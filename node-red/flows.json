[{"id":"5db64edb8eadb607","type":"tab","label":"Input ✅","disabled":false,"info":"","env":[]},{"id":"86923293ffb7e575","type":"tab","label":"Notification ✅","disabled":false,"info":""},{"id":"b0b353ce861d908b","type":"tab","label":"Presence ✅","disabled":false,"info":"","env":[]},{"id":"ccf1abe540a3b5a9","type":"tab","label":"Light ✅","disabled":false,"info":"","env":[]},{"id":"3998ef2c82bf81bd","type":"tab","label":"Heater ✅","disabled":false,"info":""},{"id":"a1ed8ea56c7ba1f9","type":"tab","label":"Temperature ✅","disabled":false,"info":"","env":[]},{"id":"ab914a2a493ebbf5","type":"tab","label":"Covers ✅","disabled":false,"info":"","env":[]},{"id":"7cc0f49198f44c93","type":"tab","label":"Devices ✅","disabled":false,"info":"","env":[]},{"id":"a62a0ee8573c9b72","type":"tab","label":"Sport ✅","disabled":false,"info":""},{"id":"eaa696a731a52b23","type":"tab","label":"AlarmClock ✅","disabled":false,"info":"","env":[]},{"id":"3bf1cd85b32b4e67","type":"tab","label":"Device ✅","disabled":false,"info":""},{"id":"22b4130fe1f6a28b","type":"tab","label":"Github update","disabled":false,"info":"","env":[]},{"id":"e95b0d12eedce5f1","type":"tab","label":"Rainmeter ✅","disabled":false,"info":""},{"id":"45b866d1e8e0fc54","type":"subflow","name":"fiesta","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"98ecd81521e7a75e"}]}],"out":[{"x":1100,"y":120,"wires":[{"id":"c6fbfce2784fd3bc","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"d193bde43bd55f9f","type":"subflow","name":"send remote command","info":"","category":"","in":[{"x":60,"y":100,"wires":[{"id":"c5ccf59387c5ac3b"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"386f1888bc94b4c8","type":"subflow","name":"motivation","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"c4c0894d444403e2"}]}],"out":[{"x":420,"y":60,"wires":[{"id":"4c9393d44c603ea8","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"5a05b9ac0289ff03","type":"subflow","name":"area light notif","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"98e68970936bcc24"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"3846091448eb9a09","type":"subflow","name":"santé calendrier process","info":"","category":"","in":[],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"e6ac576fb4598283","type":"subflow","name":"presence ?","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"659ed9ee25a47490"}]}],"out":[{"x":340,"y":40,"wires":[{"id":"659ed9ee25a47490","port":0}]},{"x":340,"y":120,"wires":[{"id":"659ed9ee25a47490","port":1}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"ba09e97f2ed22f2b","type":"subflow","name":"send to mobile","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"898c44d4d53464c6"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"dbf17bea6affd2ec","type":"subflow","name":"area speaker notif","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"455b25fabefa1b47"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"723d4991c3c87385","type":"subflow","name":"change entity state","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"955123ec73074cbf"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"ad3b29a5dd67898f","type":"subflow","name":"send bug to dashboard","info":"","category":"","in":[{"x":60,"y":40,"wires":[{"id":"bdd49c309e819698"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"6c4028aab794d52d","type":"subflow","name":"notification","info":"","category":"","in":[{"x":80,"y":80,"wires":[{"id":"321f2d38a11d9f17"}]}],"out":[{"x":760,"y":420,"wires":[{"id":"628251e2da9da6f5","port":0},{"id":"7e00d134f3038fd4","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"10a4bbabe046de0e","type":"subflow","name":"Lights 🔒","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"6a3d5dea1ffbb2d8"}]}],"out":[{"x":280,"y":80,"wires":[{"id":"6a3d5dea1ffbb2d8","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"9b9bfdbe9a43dabb","type":"subflow","name":"ambiance","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"45e68e1d589143e7"},{"id":"d95af1f39bdc2e43"}]}],"out":[{"x":920,"y":120,"wires":[{"id":"27e428e0387cac8a","port":0}]},{"x":620,"y":240,"wires":[{"id":"c83520ded53399c4","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"ea5b93cde6b1bf0a","type":"subflow","name":"get entities","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"c6e5e0125cf4b4ec"}]}],"out":[{"x":280,"y":60,"wires":[{"id":"c6e5e0125cf4b4ec","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"612068fa04cc8bbd","type":"subflow","name":"cube","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"188d4197be377390"},{"id":"4d0457a2e27a298e"},{"id":"73bf36ac50e00297"}]}],"out":[{"x":640,"y":180,"wires":[{"id":"473feda77b747512","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"050c60654a910e68","type":"subflow","name":"waits until","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"1dee8c383dad1dc9"}]}],"out":[{"x":1380,"y":60,"wires":[{"id":"cbbaf5fe1d43c359","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"7166242293a03ec9","type":"subflow","name":"ambiances","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"f51dc77777d8f60b"}]}],"out":[{"x":800,"y":60,"wires":[{"id":"907c1f317e2ca3ee","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"810176c80762139a","type":"junction","z":"7cc0f49198f44c93","x":740,"y":300,"wires":[["495d17d52fed7d90"]]},{"id":"6eef9586104aaabd","type":"junction","z":"7cc0f49198f44c93","x":740,"y":300,"wires":[["8ef14a70ba1a7d3f"]]},{"id":"312339bfc2025df4","type":"junction","z":"5db64edb8eadb607","x":460,"y":1040,"wires":[["1ce7b3c97b338020"]]},{"id":"06726fd0729b958b","type":"junction","z":"5db64edb8eadb607","x":760,"y":1040,"wires":[["5631d9e6239ab51f"]]},{"id":"a9fcbb2aa70ea1f8","type":"junction","z":"9b9bfdbe9a43dabb","x":360,"y":180,"wires":[["52d03fb81f2ee80c"]]},{"id":"0cdd3aae865a31cf","type":"junction","z":"9b9bfdbe9a43dabb","x":360,"y":180,"wires":[["9e5c408e79ac1df8"]]},{"id":"e267428f63b3b2aa","type":"junction","z":"5db64edb8eadb607","x":780,"y":1400,"wires":[["aa868fbff20bbef5"]]},{"id":"4a0d1a73e7adcc11","type":"junction","z":"050c60654a910e68","x":820,"y":60,"wires":[["a71b128c6a11f16e","4095fa2ccd977940"]]},{"id":"5ff166ae2792d64c","type":"junction","z":"050c60654a910e68","x":280,"y":60,"wires":[["87d844bd45fccde6","1ac121c8d607267c","1d64b1cbe71c8c65","9c265cc1eaad53bb","69317bea361bf45e","9d50472878b093d6","ab3f5f1f4b645507","9147624e46fd3b8b","e6e0a2f4b0faf93f","af650c007ffa4b39"]]},{"id":"af3037a2c000ff8b","type":"junction","z":"ccf1abe540a3b5a9","x":240,"y":340,"wires":[["b1bee60d1fd3da40"]]},{"id":"68556bf00513cc3b","type":"junction","z":"ccf1abe540a3b5a9","x":280,"y":400,"wires":[["059646ead3d2a49f"]]},{"id":"4b1a090c5eac6d5d","type":"junction","z":"ccf1abe540a3b5a9","x":280,"y":460,"wires":[["39a04d72d1e9fc02"]]},{"id":"3ed9df714d540dff","type":"junction","z":"b0b353ce861d908b","x":580,"y":180,"wires":[["c0a033baef2e6d6d"]]},{"id":"ba59601af723a5e2","type":"junction","z":"3998ef2c82bf81bd","x":220,"y":380,"wires":[["05ebc168524bd79f"]]},{"id":"55f2bb860de7bb22","type":"junction","z":"7cc0f49198f44c93","x":260,"y":180,"wires":[["4d07ec3b53587064"]]},{"id":"3adc7b288499c7d8","type":"junction","z":"6c4028aab794d52d","x":380,"y":200,"wires":[["978c4335d7467059"]]},{"id":"138f69c8f792548d","type":"junction","z":"5db64edb8eadb607","x":260,"y":120,"wires":[["f1440c480e2de1bc"]]},{"id":"63743b66f2e16afd","type":"junction","z":"7cc0f49198f44c93","x":480,"y":180,"wires":[["71225fcf4e1afe84"]]},{"id":"1b9e84c11edbdbf7","type":"junction","z":"7cc0f49198f44c93","x":700,"y":360,"wires":[["4e200f68fceefd6c"]]},{"id":"e35423a2a82f9168","type":"junction","z":"ccf1abe540a3b5a9","x":200,"y":720,"wires":[["e904c7abdbd0b8c2"]]},{"id":"7dec798e895a6d15","type":"junction","z":"ccf1abe540a3b5a9","x":200,"y":720,"wires":[["dd7a5828af21418b"]]},{"id":"d85024375f516485","type":"junction","z":"7cc0f49198f44c93","x":160,"y":860,"wires":[["e42a7b955c643577"]]},{"id":"58bacc915e20ccdc","type":"junction","z":"b0b353ce861d908b","x":520,"y":680,"wires":[["85e70ba4e021ee27"]]},{"id":"0ad2fc52e05f884f","type":"junction","z":"b0b353ce861d908b","x":340,"y":680,"wires":[["85e70ba4e021ee27"]]},{"id":"6acfa8ca4b422c72","type":"junction","z":"b0b353ce861d908b","x":180,"y":360,"wires":[["4a3b930cb95bbe93","2cf5a5d542aacb96"]]},{"id":"74a232c0c54bfcd0","type":"junction","z":"ab914a2a493ebbf5","x":420,"y":180,"wires":[["591f139254d874b3"]]},{"id":"d6f860c7dde4dfac","type":"junction","z":"22b4130fe1f6a28b","x":320,"y":180,"wires":[["314cf66972eefafd","8e6ca1647e0c0ba5"]]},{"id":"66876666.3e6288","type":"server","name":"Home Assistant","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":"30","areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":"at: ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true},{"id":"47f52ff3.9f438","type":"ui_base","theme":{"name":"theme-dark","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#097479","value":"#097479","edited":false},"page-titlebar-backgroundColor":{"value":"#097479","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#000000","edited":false},"group-textColor":{"value":"#0eb8c0","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#097479","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"6dbf52fb74e0857d","type":"api-call-service","z":"45b866d1e8e0fc54","name":"stores off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.cover_chambre","input_boolean.cover_salon"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":360,"y":120,"wires":[[]]},{"id":"492d3827b1f374f5","type":"ha-wait-until","z":"45b866d1e8e0fc54","name":"wait fiesta off","server":"66876666.3e6288","version":2,"outputs":2,"entityId":"input_boolean.fiesta","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"3","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":650,"y":120,"wires":[["c6a33b1ccb3eb6fc"],["c6a33b1ccb3eb6fc"]]},{"id":"7a18c237972bcf43","type":"switch","z":"45b866d1e8e0fc54","name":"","property":"delay","propertyType":"msg","rules":[{"t":"btwn","v":"1000","vt":"num","v2":"5000","v2t":"num"},{"t":"btwn","v":"5000","vt":"num","v2":"10000","v2t":"num"},{"t":"btwn","v":"10000","vt":"num","v2":"15000","v2t":"num"}],"checkall":"true","repair":false,"outputs":3,"x":590,"y":180,"wires":[["8bbee7aff9df337b"],["3328bb299530086c"],["736a0410bcd8ae28"]]},{"id":"c5e5dade2d8140b4","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"outputs":1,"x":460,"y":180,"wires":[["5dd95791799ca37b"]]},{"id":"45f3c97a1fca2055","type":"api-call-service","z":"45b866d1e8e0fc54","name":"light","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\",\"effect\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1510,"y":180,"wires":[[]]},{"id":"736a0410bcd8ae28","type":"change","z":"45b866d1e8e0fc54","name":"Disco","rules":[{"t":"set","p":"payload","pt":"msg","to":"Disco","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":180,"wires":[["85745f1699b5c18e"]]},{"id":"8bbee7aff9df337b","type":"change","z":"45b866d1e8e0fc54","name":"Strobe epilepsy!","rules":[{"t":"set","p":"payload","pt":"msg","to":"Strobe epilepsy!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":180,"wires":[["45f3c97a1fca2055"]]},{"id":"3328bb299530086c","type":"change","z":"45b866d1e8e0fc54","name":"Fast Random Loop","rules":[{"t":"set","p":"payload","pt":"msg","to":"Fast Random Loop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":180,"wires":[["45f3c97a1fca2055"]]},{"id":"51932102dd30e869","type":"api-current-state","z":"45b866d1e8e0fc54","name":"fiesta on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fiesta","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":310,"y":180,"wires":[["c5e5dade2d8140b4","7a18c237972bcf43"],[]]},{"id":"a83b97572d7d81f3","type":"switch","z":"45b866d1e8e0fc54","name":"","property":"delay","propertyType":"msg","rules":[{"t":"btwn","v":"1000","vt":"num","v2":"5000","v2t":"num"},{"t":"btwn","v":"5000","vt":"num","v2":"10000","v2t":"num"},{"t":"btwn","v":"10000","vt":"num","v2":"15000","v2t":"num"}],"checkall":"true","repair":false,"outputs":3,"x":590,"y":240,"wires":[["a0af6d11261c8245"],["0c7c59e3d8e89133"],["11ed8405127209f9"]]},{"id":"9c31e38fbb598b9a","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"outputs":1,"x":460,"y":240,"wires":[["22996ffd4a03399c"]]},{"id":"ebeb76171ceafd2c","type":"api-call-service","z":"45b866d1e8e0fc54","name":"light","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\",\"effect\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1510,"y":240,"wires":[[]]},{"id":"11ed8405127209f9","type":"change","z":"45b866d1e8e0fc54","name":"Disco","rules":[{"t":"set","p":"payload","pt":"msg","to":"Disco","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":240,"wires":[["dc43b5238775a1c7"]]},{"id":"a0af6d11261c8245","type":"change","z":"45b866d1e8e0fc54","name":"Strobe epilepsy!","rules":[{"t":"set","p":"payload","pt":"msg","to":"Strobe epilepsy!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":240,"wires":[["ebeb76171ceafd2c"]]},{"id":"0c7c59e3d8e89133","type":"change","z":"45b866d1e8e0fc54","name":"Fast Random Loop","rules":[{"t":"set","p":"payload","pt":"msg","to":"Fast Random Loop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":240,"wires":[["ebeb76171ceafd2c"]]},{"id":"7efe2fb84b3d3a4f","type":"api-current-state","z":"45b866d1e8e0fc54","name":"fiesta on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fiesta","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":310,"y":240,"wires":[["9c31e38fbb598b9a","a83b97572d7d81f3"],[]]},{"id":"9abb48c1a30a264f","type":"switch","z":"45b866d1e8e0fc54","name":"","property":"delay","propertyType":"msg","rules":[{"t":"btwn","v":"1000","vt":"num","v2":"5000","v2t":"num"},{"t":"btwn","v":"5000","vt":"num","v2":"10000","v2t":"num"},{"t":"btwn","v":"10000","vt":"num","v2":"15000","v2t":"num"}],"checkall":"true","repair":false,"outputs":3,"x":590,"y":300,"wires":[["ae562aa50f38b5c1"],["ca0da4b4f2a9f926"],["37946ec5a90342b0"]]},{"id":"e352f2f493e78666","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"outputs":1,"x":460,"y":300,"wires":[["ad517bdb76093d29"]]},{"id":"03765334b3c696a4","type":"api-call-service","z":"45b866d1e8e0fc54","name":"light","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\",\"effect\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1510,"y":300,"wires":[[]]},{"id":"37946ec5a90342b0","type":"change","z":"45b866d1e8e0fc54","name":"Disco","rules":[{"t":"set","p":"payload","pt":"msg","to":"Disco","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":300,"wires":[["18d209c95e946af2"]]},{"id":"ae562aa50f38b5c1","type":"change","z":"45b866d1e8e0fc54","name":"Strobe epilepsy!","rules":[{"t":"set","p":"payload","pt":"msg","to":"Strobe epilepsy!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":300,"wires":[["03765334b3c696a4"]]},{"id":"ca0da4b4f2a9f926","type":"change","z":"45b866d1e8e0fc54","name":"Fast Random Loop","rules":[{"t":"set","p":"payload","pt":"msg","to":"Fast Random Loop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":300,"wires":[["03765334b3c696a4"]]},{"id":"a6fd8d7d346e0c34","type":"api-current-state","z":"45b866d1e8e0fc54","name":"fiesta on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fiesta","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":310,"y":300,"wires":[["e352f2f493e78666","9abb48c1a30a264f"],[]]},{"id":"79c26f95e1cffa41","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":160,"y":420,"wires":[["dcc43a0ba67ca8f2"]]},{"id":"dcc43a0ba67ca8f2","type":"api-call-service","z":"45b866d1e8e0fc54","name":"fiesta off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.fiesta"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":300,"y":420,"wires":[[]]},{"id":"bee3e8cd6c6da8e3","type":"api-current-state","z":"45b866d1e8e0fc54","name":"stores status on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.stores_status","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":190,"y":120,"wires":[["36a443ae8864fe22","6dbf52fb74e0857d"],["492d3827b1f374f5"]]},{"id":"36a443ae8864fe22","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delay","timeout":"15","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":500,"y":120,"wires":[["492d3827b1f374f5","5dd95791799ca37b","22996ffd4a03399c","ad517bdb76093d29","eb7401127697b790"]]},{"id":"c6fbfce2784fd3bc","type":"api-call-service","z":"45b866d1e8e0fc54","name":"stores on","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.cover_chambre","input_boolean.cover_salon"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1000,"y":120,"wires":[[]]},{"id":"c6a33b1ccb3eb6fc","type":"api-current-state","z":"45b866d1e8e0fc54","name":"stores status on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.stores_status","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":830,"y":120,"wires":[["c6fbfce2784fd3bc"],[]]},{"id":"bec62ca95cc7c391","type":"switch","z":"45b866d1e8e0fc54","name":"","property":"delay","propertyType":"msg","rules":[{"t":"btwn","v":"1000","vt":"num","v2":"5000","v2t":"num"},{"t":"btwn","v":"5000","vt":"num","v2":"10000","v2t":"num"},{"t":"btwn","v":"10000","vt":"num","v2":"15000","v2t":"num"}],"checkall":"true","repair":false,"outputs":3,"x":590,"y":360,"wires":[["60038b3d5cff3f0a"],["c6e379682bf1b67c"],["69d2dddeafe9375e"]]},{"id":"e85165b20cb8f18a","type":"delay","z":"45b866d1e8e0fc54","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":460,"y":360,"wires":[["eb7401127697b790"]]},{"id":"4b39d9ca89a69090","type":"api-call-service","z":"45b866d1e8e0fc54","name":"light","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\",\"effect\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1510,"y":360,"wires":[[]]},{"id":"69d2dddeafe9375e","type":"change","z":"45b866d1e8e0fc54","name":"Disco","rules":[{"t":"set","p":"payload","pt":"msg","to":"Disco","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":360,"wires":[["06bc846f2668d898"]]},{"id":"60038b3d5cff3f0a","type":"change","z":"45b866d1e8e0fc54","name":"Strobe epilepsy!","rules":[{"t":"set","p":"payload","pt":"msg","to":"Strobe epilepsy!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":360,"wires":[["4b39d9ca89a69090"]]},{"id":"c6e379682bf1b67c","type":"change","z":"45b866d1e8e0fc54","name":"Fast Random Loop","rules":[{"t":"set","p":"payload","pt":"msg","to":"Fast Random Loop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":930,"y":360,"wires":[["4b39d9ca89a69090"]]},{"id":"28f8e10fcd63a3c6","type":"api-current-state","z":"45b866d1e8e0fc54","name":"fiesta on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fiesta","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":310,"y":360,"wires":[["e85165b20cb8f18a","bec62ca95cc7c391"],[]]},{"id":"98ecd81521e7a75e","type":"api-call-service","z":"45b866d1e8e0fc54","name":"some autolights off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.light_ambilight","input_boolean.light_bandeau_cuisine","input_boolean.light_bureau","input_boolean.light_cuisine","input_boolean.light_deco"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":190,"y":60,"wires":[["908ae564e4806fdd"]]},{"id":"908ae564e4806fdd","type":"api-call-service","z":"45b866d1e8e0fc54","name":"some lights off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.light_bandeau_cuisine","light.light_salon"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":380,"y":60,"wires":[["79c26f95e1cffa41","bee3e8cd6c6da8e3"]]},{"id":"18d209c95e946af2","type":"api-current-state","z":"45b866d1e8e0fc54","name":"","server":"66876666.3e6288","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.light_bureau","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"light","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1290,"y":300,"wires":[["03765334b3c696a4"]]},{"id":"06bc846f2668d898","type":"api-current-state","z":"45b866d1e8e0fc54","name":"","server":"66876666.3e6288","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.light_cuisine","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"light","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1290,"y":360,"wires":[["4b39d9ca89a69090"]]},{"id":"85745f1699b5c18e","type":"api-current-state","z":"45b866d1e8e0fc54","name":"","server":"66876666.3e6288","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.light_deco","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"light","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1280,"y":180,"wires":[["45f3c97a1fca2055"]]},{"id":"dc43b5238775a1c7","type":"api-current-state","z":"45b866d1e8e0fc54","name":"","server":"66876666.3e6288","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.light_ambilight","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"light","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1300,"y":240,"wires":[["ebeb76171ceafd2c"]]},{"id":"5dd95791799ca37b","type":"function","z":"45b866d1e8e0fc54","name":"","func":"msg.delay = 1000 + Math.round(Math.random()*14000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":180,"wires":[["51932102dd30e869"]]},{"id":"22996ffd4a03399c","type":"function","z":"45b866d1e8e0fc54","name":"","func":"msg.delay = 1000 + Math.round(Math.random()*14000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":240,"wires":[["7efe2fb84b3d3a4f"]]},{"id":"ad517bdb76093d29","type":"function","z":"45b866d1e8e0fc54","name":"","func":"msg.delay = 1000 + Math.round(Math.random()*14000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":300,"wires":[["a6fd8d7d346e0c34"]]},{"id":"eb7401127697b790","type":"function","z":"45b866d1e8e0fc54","name":"","func":"msg.delay = 1000 + Math.round(Math.random()*14000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":360,"wires":[["28f8e10fcd63a3c6"]]},{"id":"c5ccf59387c5ac3b","type":"function","z":"d193bde43bd55f9f","name":"prepare remote","func":"let linkedDevice = msg.linkedDevice;\nlet attributes = msg.attributes;\nlet entity_id = msg.entity_id;\nlet state = msg.state;\nlet remote = msg.remote;\nlet msgs = [];\n\nif (typeof remote == \"object\") {\n    if (\"increase\" in remote && \"decrease\" in remote) {\n        let ha_configuration = global.get(\"ha_configuration\") || {};\n        if (!(\"ha_state\" in ha_configuration[entity_id])) {\n            ha_configuration[entity_id].ha_state = attributes.max;\n        }\n        let ha_state = ha_configuration[entity_id].ha_state;\n        state = parseInt(state);\n        let diff = state - ha_state;\n        setStateMsgs([Math.abs(diff), (diff < 0 ? remote[\"decrease\"] : remote[\"increase\"])]);\n        ha_configuration[entity_id].ha_state = state;\n        global.set(\"ha_configuration\", ha_configuration);\n        return [msgs, null];\n    } else if (\"on\" in remote && \"off\" in remote) {\n        setStateMsgs(remote[state].replaceAll(\" \", \"\").split(\",\"));\n        return [msgs, null];\n    }\n} else if (typeof remote == \"string\" && state == \"on\") {\n    setStateMsgs(remote.replaceAll(\" \", \"\").split(\",\"));\n    msg.state = \"off\";\n    return [msgs, msg];\n}\n\nfunction setStateMsgs(split) {\n    let loop = parseInt(split[0]);\n    let command = split[1];\n    for (let i = 0; i < loop; i++) {\n        msgs.push({\n            payload: {\n                data: {\n                    entity_id: linkedDevice,\n                    command: command\n                }\n            }\n        });\n    }\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":100,"wires":[["5ad58a2422355551"],["242576b45e519b85"]]},{"id":"7668c6d3666d5662","type":"api-call-service","z":"d193bde43bd55f9f","name":"send command to remote","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"remote","service":"send_command","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":550,"y":60,"wires":[[]]},{"id":"5ad58a2422355551","type":"delay","z":"d193bde43bd55f9f","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"2","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":350,"y":60,"wires":[["7668c6d3666d5662"]]},{"id":"242576b45e519b85","type":"subflow:723d4991c3c87385","z":"d193bde43bd55f9f","name":"","x":370,"y":140,"wires":[]},{"id":"4c9393d44c603ea8","type":"function","z":"386f1888bc94b4c8","name":"motivation","func":"switch (msg.payload) {\n  case 1:\n    msg.payload = \"Personne n’est trop vieux pour se fixer un nouvel objectif ou réaliser de nouveaux rêves. – Les Brown\";\n    break;\n  case 2:\n    msg.payload = \"La seule façon de faire du bon travail est d’aimer ce que vous faites. Si vous n’avez pas encore trouvé, continuez à chercher. - Steve Jobs\";\n    break;\n  case 3:\n    msg.payload = \"Pour réussir, votre désir de réussite doit être plus grand que votre peur de l’échec. - Bill Cosby\";\n    break;\n  case 4:\n    msg.payload = \"Un énorme succès est la meilleure des vengeances. - Frank Sinatra\";\n    break;\n  case 5:\n    msg.payload = \"Je suis reconnaissant à tous ceux qui m’ont dit NON. C’est à grâce à eux que je suis moi-même. - Albert Einstein\";\n    break;\n  case 6:\n    msg.payload = \"La seule chose qui se dresse entre vous et votre rêve, c’est la volonté d’essayer et la conviction qu’il est réellement possible. - Joel Brown\";\n    break;\n  case 7:\n    msg.payload = \"Un pessimiste voit la difficulté dans chaque opportunité, un optimiste voit l’opportunité dans chaque difficulté. - Winston Churchill\";\n    break;\n  case 8:\n    msg.payload = \"Le succès c’est d’aller d’échec en échec sans perdre son enthousiasme. - Winston Churchill\";\n    break;\n  case 9:\n    msg.payload = \"Le succès n’est pas la clé du bonheur. Le bonheur est la clé du succès. Si vous aimez ce que vous faites, vous réussirez. - Albert Schweitzer\";\n    break;\n  case 10:\n    msg.payload = \"Les gagnants trouvent des moyens, les perdants des excuses. -  F. D. Roosevelt\";\n    break;\n  case 11:\n    msg.payload = \"Celui qui attend que tout danger soir écarté pour mettre les voiles ne prendra jamais la mer. - Thomas Fuller\";\n    break;\n  case 12:\n    msg.payload = \"Ce n’est pas parce que les choses sont difficiles que nous n’osons pas, c’est parce que nous n’osons pas qu’elles sont difficiles. -  Sénèque\";\n    break;\n  case 13:\n    msg.payload = \"Certains veulent que ça arrive, d’autres aimeraient que ça arrive et d’autres font que ça arrive. - Michael Jordan\";\n    break;\n  case 14:\n    msg.payload = \"La plus grande erreur que puisse faire un homme est d’avoir peur d’en faire une. - Elbert Hubbard\";\n    break;\n  case 15:\n    msg.payload = \"Le génie est fait d’un pour cent d’inspiration et de quatre-vingt-dix-neuf pour cent de transpiration. - Thomas Edison\";\n    break;\n  case 16:\n    msg.payload = \"Ce n’est pas le vent qui dÌ�cide de votre destination, c’est l’orientation que vous donnez à votre voile. Le vent est pareil pour tous. - Jim Rohn\";\n    break;\n  case 17:\n    msg.payload = \"L’humanité se divise en trois catégories : ceux qui ne peuvent pas bouger, ceux qui peuvent bouger, et ceux qui bougent. - Benjamin Franklin\";\n    break;\n  case 18:\n    msg.payload = \"Dans vingt ans vous serez plus déçus par les choses que vous n’avez pas faites que par celles que vous avez faites. Alors sortez des sentiers battus. Mettez les voiles. Explorez. Rêvez. Découvrez. - Mark Twain\";\n    break;\n  case 19:\n    msg.payload = \"Il n’y a pas de réussites faciles ni d’échecs définitifs. - Marcel Proust\";\n    break;\n  case 20:\n    msg.payload = \"J’ai décidé d’être heureux parce que c’est bon pour la santé. - Voltaire\";\n    break;\n  case 21:\n    msg.payload = \"Celui qui veut atteindre un objectif lointain doit faire de petits pas. - Saul Bellow\";\n    break;\n  case 22:\n    msg.payload = \"La plupart des choses importantes dans le monde ont été accomplies par des personnes qui ont continué à essayer quand il semblait y avoir aucun espoir. - Dale Carnegie\";\n    break;\n  case 23:\n    msg.payload = \"Pour réussir, retenez bien ces trois maximes: voir c’est savoir, vouloir c’est pouvoir, oser c’est avoir. - Alfred de Musset\";\n    break;\n  case 24:\n    msg.payload = \"Les chanceux sont ceux qui arrivent à tout ; Les malchanceux, ceux à qui tout arrive. - Eugène Labiche\";\n    break;\n  case 25:\n    msg.payload = \"Pour ce qui est de l’avenir, il ne s’agit pas de le prévoir, mais de le rendre possible. - Antoine de Saint-Exupéry\";\n    break;\n  case 26:\n\tmsg.payload = \"Il faut viser la lune, parce qu’au moins, si vous échouez, vous finirez dans les étoiles. - Oscar Wilde\";\n\tbreak;\n  case 27:\n\tmsg.payload = \"La meilleure façon de prédire l’avenir est de le créer. - Peter Drucker\";\n\tbreak;\n  case 28:\n\tmsg.payload = \"Le désir de bien faire est un puissant moteur. Celui de faire du bien est plus puissant encore. - Michael Aguilar\";\n\tbreak;\n  case 29:\n\tmsg.payload = \"Croyez en vos rêves et ils se réaliseront peut-être. Croyez en vous et ils se réaliseront sûrement. - Martin Luther King\";\n\tbreak;\n  case 30:\n\tmsg.payload = \"Vous ne trouverez jamais ce que vous ne cherchez pas. - Confucius\";\n\tbreak;\n  case 31:\n\tmsg.payload = \"Si vous pensez que vous ne valez pas grand-chose, vous ne trouverez personne pour augmenter votre prix. - Michael Aguilar\";\n\tbreak;\n  case 32:\n\tmsg.payload = \"La sagesse suprême, c’est d’avoir des rêves assez grands pour ne pas les perdre de vue pendant qu’on les poursuit. - Francis Scott Fitzgerald\";\n\tbreak;\n  case 33:\n\tmsg.payload = \"Si vous pouvez le rêver, vous pouvez le faire. - Walt Disney\";\n\tbreak;\n  case 34:\n\tmsg.payload = \"Notre vie vaut ce qu’elle nous a coûté d’efforts. - François Mauriac\";\n\tbreak;\n  case 35:\n\tmsg.payload = \"Ce sont nos choix qui montrent qui nous sommes, bien  plus que nos capacités. - Joanne K.Rowling\";\n\tbreak;\n  case 36:\n\tmsg.payload = \"On peut tout ce qui ne dépende que de notre volonté. - Marcel Proust\";\n\tbreak;\n  case 37:\n\tmsg.payload = \"Le but de la vie, ce n’est pas l’espoir de devenir parfait, c’est la volonté d’être toujours meilleur. - Ralph Waldo Emerson\";\n\tbreak;\n  case 38:\n\tmsg.payload = \"La persévérance, c’est ce qui rend l’impossible possible, le possible probable et le probable réalisÌ�. - Léon Trotsky\";\n\tbreak;\n  case 39:\n\tmsg.payload = \"Il n’y a qu’une façon d’échouer, c’est d’abandonner avant d’avoir réussi. - Georges Clémenceau\";\n\tbreak;\n  case 40:\n\tmsg.payload = \"Rien de grand ne s’est accompli sans passion. - Hegel\";\n\tbreak;\n  case 41:\n\tmsg.payload = \"Ne craignez pas la perfection, vous n’y parviendrez jamais. - Salvador Dali\";\n\tbreak;\n  case 42:\n\tmsg.payload = \"Il vaut mieux exceller dans une seule discipline plutôt que d’être médiocre dans plusieurs. - Proverbe latin\";\n\tbreak;\n  case 43:\n\tmsg.payload = \"En suivant le chemin qui s’appelle plus tard, nous arrivons sur la place qui s’appelle jamais. - Sén÷��que\";\n\tbreak;\n  case 44:\n\tmsg.payload = \"La vie est comme une bicyclette, il faut avancer pour ne pas perdre l’équilibre. - Albert Einstein\";\n\tbreak;\n  case 45:\n\tmsg.payload = \"Les portes de l’avenir sont ouvertes à ceux qui savent les pousser. - Coluche\";\n\tbreak;\n  case 46:\n\tmsg.payload = \"Le monde n’a progressé que grâce aux choses impossibles qui ont été réalisées. - André Maurois\";\n\tbreak;\n  case 47:\n\tmsg.payload = \"Les obstacles sont ces choses effrayantes que vous apercevez lorsque vous détournez les yeux de vos objectifs. - Henry Ford\";\n\tbreak;\n  case 48:\n\tmsg.payload = \"Pour pouvoir contempler un arc-en-ciel, il faut d’abord endurer la pluie. - Proverbe chinois\";\n\tbreak;\n  case 49:\n\tmsg.payload = \"Commencez par changer en vous ce que vous voulez changer autour de vous. - Gandhi\";\n\tbreak;\n  case 50:\n\tmsg.payload = \"La folie, c’est de refaire la même chose et d’en attendre un résultat différent. - Albert Einstein\";\n\tbreak;\n  case 51:\n\tmsg.payload = \"Agissez toujours comme s’il était impossible d’échouer. - Winston Churchill\";\n\tbreak;\n  case 52:\n\tmsg.payload = \"Il est difficile d’échouer. Mais il est encore plus difficile de ne pas avoir essayé de réussir. - Théodore Roosevelt\";\n\tbreak;\n  case 53:\n\tmsg.payload = \"Se lamenter sur un malheur passé, voilà le plus sûr moyen d’en attirer un autre. - William Shakespeare\";\n\tbreak;\n  case 54:\n\tmsg.payload = \"L’échec n’est qu’une opportunité pour recommencer la même chose plus intelligemment. - Henry Ford\";\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":60,"wires":[[]]},{"id":"c4c0894d444403e2","type":"random","z":"386f1888bc94b4c8","name":"random","low":"1","high":"54","inte":"true","property":"payload","x":160,"y":60,"wires":[["4c9393d44c603ea8"]]},{"id":"40ddb0cd55b355c4","type":"api-call-service","z":"5a05b9ac0289ff03","name":"light on","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":920,"y":60,"wires":[["60030f42d4978295"]]},{"id":"60030f42d4978295","type":"api-call-service","z":"5a05b9ac0289ff03","name":"pulse","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"yeelight","service":"start_flow","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\",\"count\":{{count}},\"transitions\":[{\"HSVTransition\":[{{hue1}},100,800,1]},{\"HSVTransition\":[{{hue2}},100,200,100]}]}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1050,"y":60,"wires":[["391b72dafa0a0318"]]},{"id":"2009d28b780871aa","type":"delay","z":"5a05b9ac0289ff03","name":"","pauseType":"delayv","timeout":"10","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1360,"y":60,"wires":[["900e0cf7e7d0f75f"]]},{"id":"900e0cf7e7d0f75f","type":"api-call-service","z":"5a05b9ac0289ff03","name":"turn off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{light}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1490,"y":60,"wires":[[]]},{"id":"cee67cf1f6f94432","type":"function","z":"5a05b9ac0289ff03","name":"","func":"var light_state = global.get('homeassistant').homeAssistant.states[msg.light].state === \"on\";\nmsg.light_state = light_state;\nmsg.delay = msg.count * 1000;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":780,"y":60,"wires":[["40ddb0cd55b355c4"]]},{"id":"391b72dafa0a0318","type":"switch","z":"5a05b9ac0289ff03","name":"light state on ?","property":"light_state","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":1200,"y":60,"wires":[["2009d28b780871aa"]]},{"id":"9a9e7eba6abacb57","type":"function","z":"5a05b9ac0289ff03","name":"set lights","func":"var lights = msg.lights;\nvar msgs = [];\n\nfor (let i = 0, j = lights.length; i < j; i++) {\n    if (supportHSColor(lights[i])) {\n        msgs.push({\n            light: lights[i].entity_id,\n            count: msg.lightEffect.count,\n            hue1: msg.lightEffect.hue1,\n            hue2: msg.lightEffect.hue2\n        });\n    }\n}\n\nreturn [msgs];\n\nfunction supportHSColor(light) {\n    for (let i = 0, j = light.attributes.supported_color_modes.length; i < j; i++) {\n        if (light.attributes.supported_color_modes[i] == \"hs\") {\n            return true;\n        }\n    }\n    return false;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":60,"wires":[["cee67cf1f6f94432"]]},{"id":"98e68970936bcc24","type":"delay","z":"5a05b9ac0289ff03","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":180,"y":60,"wires":[["863bd64df8fad725"]]},{"id":"863bd64df8fad725","type":"function","z":"5a05b9ac0289ff03","name":"msg lights","func":"msg.filter = { \"in\": { linkedClass: \"light\", linkedArea: msg.linkedArea } };\nmsg.result = \"lights\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":340,"y":60,"wires":[["6c83c3765ccd0692"]]},{"id":"6c83c3765ccd0692","type":"subflow:ea5b93cde6b1bf0a","z":"5a05b9ac0289ff03","name":"","x":490,"y":60,"wires":[["9a9e7eba6abacb57"]]},{"id":"21c3876a5ffadcba","type":"function","z":"3846091448eb9a09","name":"fitness today","func":"msg.payload = \"fitness\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1010,"y":180,"wires":[[]]},{"id":"d4e428fe90d9434b","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":260,"y":120,"wires":[["dbef126f17678db4"],[]]},{"id":"a4ad1a83c2e750a7","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":280,"y":180,"wires":[["d3dff07a07a856c0"],[]]},{"id":"d3dff07a07a856c0","type":"api-current-state","z":"3846091448eb9a09","name":"fitness on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fitness","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":450,"y":180,"wires":[["0dbe0b3b1ee01ea8"],[]]},{"id":"0dbe0b3b1ee01ea8","type":"api-current-state","z":"3846091448eb9a09","name":"fitness %","server":"66876666.3e6288","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.fitness_chance","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"fitness_chance","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":600,"y":180,"wires":[["d5b8614813377f46"]]},{"id":"13b871eff379f1ee","type":"switch","z":"3846091448eb9a09","name":"switch","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"lte","v":"fitness_chance","vt":"msg"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":180,"wires":[[],["21c3876a5ffadcba"]]},{"id":"d5b8614813377f46","type":"random","z":"3846091448eb9a09","name":"random","low":"0","high":"100","inte":"true","property":"payload","x":740,"y":180,"wires":[["13b871eff379f1ee"]]},{"id":"bf8f0796ab780d5f","type":"switch","z":"3846091448eb9a09","name":"switch","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"lte","v":"run_chance","vt":"msg"}],"checkall":"true","repair":false,"outputs":2,"x":810,"y":120,"wires":[[],["73ac5c7c899c2801"]]},{"id":"07faea239a39261c","type":"random","z":"3846091448eb9a09","name":"random","low":"0","high":"100","inte":"true","property":"payload","x":680,"y":120,"wires":[["bf8f0796ab780d5f"]]},{"id":"73ac5c7c899c2801","type":"function","z":"3846091448eb9a09","name":"run today","func":"msg.payload = \"run\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":940,"y":120,"wires":[[]]},{"id":"ef4645fb95957b02","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":260,"y":60,"wires":[["7553058f60f98d03"],[]]},{"id":"7553058f60f98d03","type":"api-current-state","z":"3846091448eb9a09","name":"walk on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.walk","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":420,"y":60,"wires":[["b690b298966cd658"],[]]},{"id":"b690b298966cd658","type":"api-current-state","z":"3846091448eb9a09","name":"walk %","server":"66876666.3e6288","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.walk_chance","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"walk_chance","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":560,"y":60,"wires":[["d0fe52999302aaa3"]]},{"id":"d0fe52999302aaa3","type":"random","z":"3846091448eb9a09","name":"random","low":"0","high":"100","inte":"true","property":"payload","x":700,"y":60,"wires":[["d916b632eeb303d2"]]},{"id":"d916b632eeb303d2","type":"switch","z":"3846091448eb9a09","name":"switch","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"lte","v":"walk_chance","vt":"msg"}],"checkall":"true","repair":false,"outputs":2,"x":830,"y":60,"wires":[[],["15d61d614c3efc74"]]},{"id":"15d61d614c3efc74","type":"function","z":"3846091448eb9a09","name":"walk today","func":"msg.payload = \"walk\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":970,"y":60,"wires":[[]]},{"id":"dbef126f17678db4","type":"api-current-state","z":"3846091448eb9a09","name":"run on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.run","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":420,"y":120,"wires":[["1e708d0d6de0804d"],[]]},{"id":"1e708d0d6de0804d","type":"api-current-state","z":"3846091448eb9a09","name":"run %","server":"66876666.3e6288","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.run_chance","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"run_chance","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":550,"y":120,"wires":[["07faea239a39261c"]]},{"id":"c00b980c627ebde7","type":"function","z":"3846091448eb9a09","name":"mesure today","func":"msg.payload = \"mesure\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":460,"y":300,"wires":[[]]},{"id":"6604a7be26d0b12b","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":280,"y":300,"wires":[["c00b980c627ebde7"],[]]},{"id":"6e673aeedf0d91f2","type":"function","z":"3846091448eb9a09","name":"stretching today","func":"msg.payload = \"stretching\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1080,"y":240,"wires":[[]]},{"id":"9e12df11d86c781c","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":300,"y":240,"wires":[["3eadaf5dd2eb5e47"],[]]},{"id":"3eadaf5dd2eb5e47","type":"api-current-state","z":"3846091448eb9a09","name":"stretching on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.stretching","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":480,"y":240,"wires":[["4b2bbbb97b3590ea"],[]]},{"id":"4b2bbbb97b3590ea","type":"api-current-state","z":"3846091448eb9a09","name":"stretching %","server":"66876666.3e6288","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.stretching_chance","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"stretching_chance","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":650,"y":240,"wires":[["22cb4249e162d154"]]},{"id":"9f856953b9cf6ab8","type":"switch","z":"3846091448eb9a09","name":"switch","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"lte","v":"stretching_chance","vt":"msg"}],"checkall":"true","repair":false,"outputs":2,"x":930,"y":240,"wires":[[],["6e673aeedf0d91f2"]]},{"id":"22cb4249e162d154","type":"random","z":"3846091448eb9a09","name":"random","low":"0","high":"100","inte":"true","property":"payload","x":800,"y":240,"wires":[["9f856953b9cf6ab8"]]},{"id":"f3d1ff0829cd2ad1","type":"function","z":"3846091448eb9a09","name":"reset activities of the day","func":"var activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state || \"{}\");\n\nactivities[\"walk\"][2] = false;\nactivities[\"run\"][2] = false;\nactivities[\"fitness\"][2] = false;\nactivities[\"stretching\"][2] = false;\nactivities[\"mesure\"][2] = false;\n\nmsg.payload = activities;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":560,"wires":[["3ee5bc2ed35854c2"]]},{"id":"9cd66b2de9e90ccd","type":"complete","z":"3846091448eb9a09","name":"> get activities for today","scope":["21c3876a5ffadcba","73ac5c7c899c2801","15d61d614c3efc74","c00b980c627ebde7","6e673aeedf0d91f2"],"uncaught":false,"x":140,"y":400,"wires":[["3b6294d24561cb76"]]},{"id":"3b6294d24561cb76","type":"delay","z":"3846091448eb9a09","name":"","pauseType":"rate","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":330,"y":400,"wires":[["652226982ca7f748"]]},{"id":"652226982ca7f748","type":"function","z":"3846091448eb9a09","name":"set activities for today","func":"var activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state || \"{}\");\nactivities[msg.payload][1]++;\nactivities[msg.payload][2] = true;\nmsg.payload = activities;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":400,"wires":[["d980c0d2ce11599a","f666923ed3c76878"]]},{"id":"d980c0d2ce11599a","type":"trigger","z":"3846091448eb9a09","name":"","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"5","extend":true,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":700,"y":400,"wires":[["37f67ac50fb1ebc6"]]},{"id":"37f67ac50fb1ebc6","type":"function","z":"3846091448eb9a09","name":"set no walk when run","func":"var activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state || \"{}\");\nif (activities[\"run\"][2] && activities[\"walk\"][2]) {\n    activities[\"walk\"][1]--;\n    activities[\"walk\"][2] = false;\n    msg.payload = activities;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":880,"y":400,"wires":[["f666923ed3c76878"]]},{"id":"f666923ed3c76878","type":"function","z":"3846091448eb9a09","name":"","func":"msg.payload = { \"data\": { \"value\": JSON.stringify(msg.payload) } };\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1060,"y":400,"wires":[["cf867b4c7b9f2f3a"]]},{"id":"cf867b4c7b9f2f3a","type":"api-call-service","z":"3846091448eb9a09","name":"json activities","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1210,"y":400,"wires":[[]]},{"id":"3ee5bc2ed35854c2","type":"function","z":"3846091448eb9a09","name":"","func":"msg.payload = { \"data\": { \"value\": JSON.stringify(msg.payload) } };\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":580,"y":560,"wires":[["6ad328ec2b20edcd"]]},{"id":"6ad328ec2b20edcd","type":"api-call-service","z":"3846091448eb9a09","name":"json activities","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":730,"y":560,"wires":[[]]},{"id":"8823f25778895e6b","type":"function","z":"3846091448eb9a09","name":"week report message","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state || \"{}\");\nlet totalUp = parseInt(activities[\"walk\"][0]) + parseInt(activities[\"run\"][0]) + parseInt(activities[\"fitness\"][0]) +parseInt(activities[\"stretching\"][0]) +parseInt(activities[\"mesure\"][0]);\nlet totalDo = parseInt(activities[\"walk\"][1]) + parseInt(activities[\"run\"][1]) + parseInt(activities[\"fitness\"][1]) +parseInt(activities[\"stretching\"][1]) +parseInt(activities[\"mesure\"][1]);\nlet percent = totalDo !== 0 ? parseInt(100*totalUp/totalDo) : 0;\n\nmsg.notification_id = \"resetSportWeek\";\nmsg.title = \"Sport et Santé : Récapitulatif de la semaine\";\nmsg.message = 'Objectifs santé de la semaine: ' + percent + '% atteints ' + (percent === 100 ? '🎊🎉' : '');\nmsg.alertType = \"info\";\nmsg.zone = [\"inside\", \"outside\"];\nmsg.data = {};\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":620,"wires":[["885ad3139a71bea4","c72aaf234d681b62"]]},{"id":"885ad3139a71bea4","type":"function","z":"3846091448eb9a09","name":"","func":"msg.payload = { \"data\": { \"value\": JSON.stringify({ walk: [0, 0, false], run: [0, 0, false], fitness: [0, 0, false], stretching: [0, 0, false], mesure: [0, 0, false] }) } };\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":740,"y":620,"wires":[["e6637470dac740dd"]]},{"id":"e6637470dac740dd","type":"api-call-service","z":"3846091448eb9a09","name":"json activities","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":890,"y":620,"wires":[[]]},{"id":"46c9a205f6b67401","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":360,"y":620,"wires":[["8823f25778895e6b"],[]]},{"id":"477c3d00ac985b04","type":"inject","z":"3846091448eb9a09","name":"walk","props":[{"p":"payload"}],"repeat":"","crontab":"00 05 * * 1,3,5","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":110,"y":60,"wires":[["ef4645fb95957b02"]]},{"id":"82d2a1259cd2e1df","type":"inject","z":"3846091448eb9a09","name":"run","props":[{"p":"payload"}],"repeat":"","crontab":"00 05 * * 1,3,5","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":110,"y":120,"wires":[["d4e428fe90d9434b"]]},{"id":"2a60ebdbf6ae66bd","type":"inject","z":"3846091448eb9a09","name":"fitness","props":[{"p":"payload"}],"repeat":"","crontab":"00 05 * * 2,4,6","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":120,"y":180,"wires":[["a4ad1a83c2e750a7"]]},{"id":"77e9feb5dce9a597","type":"inject","z":"3846091448eb9a09","name":"stretching","props":[{"p":"payload"}],"repeat":"","crontab":"00 05 * * 1,2,3,4,5,6","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":130,"y":240,"wires":[["9e12df11d86c781c"]]},{"id":"db6318cc99f48d3c","type":"inject","z":"3846091448eb9a09","name":"mesure","props":[{"p":"payload"}],"repeat":"","crontab":"00 05 * * 1","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":120,"y":300,"wires":[["6604a7be26d0b12b"]]},{"id":"1f8e8267cb4c107b","type":"inject","z":"3846091448eb9a09","name":"reset day motivation","props":[{"p":"payload"}],"repeat":"","crontab":"30 04 * * *","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":160,"y":560,"wires":[["f3d1ff0829cd2ad1","6745aae0ec95a3ed"]]},{"id":"5a0470944ca13eb5","type":"inject","z":"3846091448eb9a09","name":"reset week motivation","props":[{"p":"payload"}],"repeat":"","crontab":"00 22 * * 0","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":160,"y":620,"wires":[["46c9a205f6b67401"]]},{"id":"a115f9eacd8cc96f","type":"api-current-state","z":"3846091448eb9a09","name":"motivation_increment on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation_increment","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":580,"y":680,"wires":[["7e1241d0ddcf74cd"],[]]},{"id":"02f371c8856e0e56","type":"api-call-service","z":"3846091448eb9a09","name":"walk_chance+1","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"increment","areaId":[],"deviceId":[],"entityId":["input_number.walk_chance"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":340,"y":740,"wires":[[]]},{"id":"eba861b1a932743d","type":"inject","z":"3846091448eb9a09","name":"increment motivation","props":[{"p":"payload"}],"repeat":"","crontab":"30 04 * * 1,2,3,4,5,6","once":false,"onceDelay":0.1,"topic":"","payload":"on","payloadType":"str","x":160,"y":680,"wires":[["0eb0be7f3ed455fe"]]},{"id":"2d632f571cafe360","type":"api-call-service","z":"3846091448eb9a09","name":"run_chance+1","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"increment","areaId":[],"deviceId":[],"entityId":["input_number.run_chance"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":720,"y":740,"wires":[[]]},{"id":"d202f805ee5e20cc","type":"api-call-service","z":"3846091448eb9a09","name":"fitness_chance+1","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"increment","areaId":[],"deviceId":[],"entityId":["input_number.fitness_chance"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":830,"y":800,"wires":[[]]},{"id":"6207953840ddd842","type":"api-call-service","z":"3846091448eb9a09","name":"stretching_chance+1","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"increment","areaId":[],"deviceId":[],"entityId":["input_number.stretching_chance"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":400,"y":800,"wires":[[]]},{"id":"fdcb59da1549b4d3","type":"server-state-changed","z":"3846091448eb9a09","name":"motivation_reset","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.motivation_reset","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":460,"wires":[["4d7dfd92a56d6b30"],[]]},{"id":"6013e91ce887b3f3","type":"api-call-service","z":"3846091448eb9a09","name":"motivation_reset off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation_reset"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1130,"y":460,"wires":[[]]},{"id":"4d7dfd92a56d6b30","type":"api-call-service","z":"3846091448eb9a09","name":"walk_chance 25%","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.walk_chance"],"data":"{\"value\":\"25\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":310,"y":460,"wires":[["65675f3ffe7414d8"]]},{"id":"65675f3ffe7414d8","type":"api-call-service","z":"3846091448eb9a09","name":"run_chance 0%","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.run_chance"],"data":"{\"value\":\"0\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":500,"y":460,"wires":[["b951dd0311d6eddf"]]},{"id":"b951dd0311d6eddf","type":"api-call-service","z":"3846091448eb9a09","name":"fitness_chance 8%","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.fitness_chance"],"data":"{\"value\":\"8\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":690,"y":460,"wires":[["c838f7b3b4145325"]]},{"id":"1f01db3b11f606bd","type":"api-current-state","z":"3846091448eb9a09","name":"walk on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.walk","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":180,"y":740,"wires":[["02f371c8856e0e56"],[]]},{"id":"61f6287df8b8366c","type":"api-current-state","z":"3846091448eb9a09","name":"run on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.run","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":560,"y":740,"wires":[["2d632f571cafe360"],[]]},{"id":"1ce6220879dc5122","type":"api-current-state","z":"3846091448eb9a09","name":"fitness on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.fitness","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":650,"y":800,"wires":[["d202f805ee5e20cc"],[]]},{"id":"5474ea3036791970","type":"api-current-state","z":"3846091448eb9a09","name":"stretching on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.stretching","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":200,"y":800,"wires":[["6207953840ddd842"],[]]},{"id":"c838f7b3b4145325","type":"api-call-service","z":"3846091448eb9a09","name":"stretching_chance 50%","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.stretching_chance"],"data":"{\"value\":\"50\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":910,"y":460,"wires":[["6013e91ce887b3f3"]]},{"id":"0eb0be7f3ed455fe","type":"api-current-state","z":"3846091448eb9a09","name":"motivation on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.motivation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":360,"y":680,"wires":[["a115f9eacd8cc96f"],[]]},{"id":"c72aaf234d681b62","type":"subflow:6c4028aab794d52d","z":"3846091448eb9a09","name":"","x":1050,"y":620,"wires":[[]]},{"id":"6745aae0ec95a3ed","type":"function","z":"3846091448eb9a09","name":"reset week report message","func":"msg.notification_id = \"resetSportWeek\";\nmsg.dismiss = true;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":560,"wires":[[]]},{"id":"7e1241d0ddcf74cd","type":"link out","z":"3846091448eb9a09","name":"link out 242","mode":"link","links":["c22656a177f5d650","5849b6f7b534bec7","7860fa90d977c319","e808cb12042a366c"],"x":735,"y":680,"wires":[]},{"id":"c22656a177f5d650","type":"link in","z":"3846091448eb9a09","name":"link in 240","links":["7e1241d0ddcf74cd"],"x":85,"y":740,"wires":[["1f01db3b11f606bd"]]},{"id":"5849b6f7b534bec7","type":"link in","z":"3846091448eb9a09","name":"link in 241","links":["7e1241d0ddcf74cd"],"x":465,"y":740,"wires":[["61f6287df8b8366c"]]},{"id":"7860fa90d977c319","type":"link in","z":"3846091448eb9a09","name":"link in 242","links":["7e1241d0ddcf74cd"],"x":85,"y":800,"wires":[["5474ea3036791970"]]},{"id":"e808cb12042a366c","type":"link in","z":"3846091448eb9a09","name":"link in 243","links":["7e1241d0ddcf74cd"],"x":545,"y":800,"wires":[["1ce6220879dc5122"]]},{"id":"659ed9ee25a47490","type":"api-current-state","z":"e6ac576fb4598283","name":"in_home_zone ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.in_home_zone","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":190,"y":80,"wires":[[],[]]},{"id":"138422f99c4bd921","type":"api-call-service","z":"ba09e97f2ed22f2b","name":"send to mobile","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"notify","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"all","x":720,"y":60,"wires":[[]]},{"id":"bac0f6cb65e6ea92","type":"function","z":"ba09e97f2ed22f2b","name":"mobileNotifications ?","func":"let persons = msg.persons;\nlet msgs = [];\n\nfor (let person of persons) {\n    if (\"mobileNotifications\" in person && person.mobileNotifications != \"\") {\n        let mess = {\n            service: person.mobileNotifications,\n            payload: {\n                data: {\n                    title: \"title\" in msg ? msg.title : \"\",\n                    message: \"message\" in msg ? msg.message : \"\"\n                }\n            }\n        };\n        if (\"data\" in msg) {\n            mess.payload.data[\"data\"] = msg.data;\n        }\n        msgs.push(mess);\n    }\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":520,"y":60,"wires":[["138422f99c4bd921"]]},{"id":"898c44d4d53464c6","type":"function","z":"ba09e97f2ed22f2b","name":"msg persons","func":"if (\"sendMobile\" in msg && msg.sendMobile) {\n    msg.filter = { \"in\": { linkedClass: \"person\" } };\n    msg.result = \"persons\";\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":60,"wires":[["a356259526e3077a"]]},{"id":"a356259526e3077a","type":"subflow:ea5b93cde6b1bf0a","z":"ba09e97f2ed22f2b","name":"","x":330,"y":60,"wires":[["bac0f6cb65e6ea92"]]},{"id":"f61193ac855ee9a3","type":"api-call-service","z":"dbf17bea6affd2ec","name":"sound","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{speaker}}\",\"media_content_id\":\"https://home-assistant-erwan.duckdns.org:8123/local/{{sound}}\",\"media_content_type\":\"music\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1090,"y":80,"wires":[["eadc0b9e16656110"]]},{"id":"b1a62f6969ebc721","type":"api-call-service","z":"dbf17bea6affd2ec","name":"set vol defaultVolumeLevel","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{speaker}}\",\"volume_level\":\"{{defaultVolumeLevel}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":360,"y":200,"wires":[["74992991c1422c72"]]},{"id":"848d48c0094a227a","type":"delay","z":"dbf17bea6affd2ec","name":"","pauseType":"delay","timeout":"7","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":160,"y":200,"wires":[["b1a62f6969ebc721"]]},{"id":"e8057fb5014c2a70","type":"api-call-service","z":"dbf17bea6affd2ec","name":"speak","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"tts","service":"watson_tts_say","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{speaker}}\",\"message\":\"{{speak}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1090,"y":140,"wires":[["eadc0b9e16656110"]]},{"id":"c2e53d0c272a5a5b","type":"api-current-state","z":"dbf17bea6affd2ec","name":"get current playing","server":"66876666.3e6288","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"{{speaker}}","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":930,"y":80,"wires":[["f61193ac855ee9a3"]]},{"id":"9b82d4253e2257cd","type":"api-call-service","z":"dbf17bea6affd2ec","name":"continue playing","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":880,"y":200,"wires":[["39cf43e742a8d1ba"]]},{"id":"74992991c1422c72","type":"switch","z":"dbf17bea6affd2ec","name":"playing ?","property":"data.state","propertyType":"msg","rules":[{"t":"eq","v":"playing","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":560,"y":200,"wires":[["385d4f6f46823862"]]},{"id":"385d4f6f46823862","type":"function","z":"dbf17bea6affd2ec","name":"music data","func":"msg.media_content_type = msg.data.attributes.media_content_type;\nmsg.media_content_id = msg.data.attributes.media_content_id;\nmsg.volume_level = msg.data.attributes.volume_level;\nmsg.entity_id = msg.data.entity_id;\n\nmsg.payload = { \"data\": { \"entity_id\": msg.entity_id, \"media_content_id\": msg.media_content_id, \"media_content_type\": \"music\" } };\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":200,"wires":[["9b82d4253e2257cd"]]},{"id":"27bd1531081dd2fd","type":"link in","z":"dbf17bea6affd2ec","name":"link in 117","links":["eadc0b9e16656110"],"x":55,"y":200,"wires":[["848d48c0094a227a"]]},{"id":"eadc0b9e16656110","type":"link out","z":"dbf17bea6affd2ec","name":"link out 83","mode":"link","links":["27bd1531081dd2fd"],"x":1185,"y":80,"wires":[]},{"id":"4f3961b90903464f","type":"api-call-service","z":"dbf17bea6affd2ec","name":"set last vol","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"volume_level\":\"{{volumeLevel}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1250,"y":200,"wires":[[]]},{"id":"39cf43e742a8d1ba","type":"change","z":"dbf17bea6affd2ec","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1070,"y":200,"wires":[["4f3961b90903464f"]]},{"id":"455b25fabefa1b47","type":"delay","z":"dbf17bea6affd2ec","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":180,"y":80,"wires":[["03a071bc98774d99"]]},{"id":"016875b1df284bf6","type":"api-current-state","z":"dbf17bea6affd2ec","name":"get current playing","server":"66876666.3e6288","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"{{speaker}}","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":930,"y":140,"wires":[["e8057fb5014c2a70"]]},{"id":"03a071bc98774d99","type":"function","z":"dbf17bea6affd2ec","name":"msg","func":"msg.filter = { \"in\": { linkedClass: \"speaker\"} };\nmsg.result = \"speakers\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":80,"wires":[["deb4a2e6f5124c57"]]},{"id":"deb4a2e6f5124c57","type":"subflow:ea5b93cde6b1bf0a","z":"dbf17bea6affd2ec","name":"","x":470,"y":80,"wires":[["d2caee37b4f097d2"]]},{"id":"d2caee37b4f097d2","type":"function","z":"dbf17bea6affd2ec","name":"set speaker","func":"let linkedArea = \"linkedArea\" in msg && msg.linkedArea != \"\" ? msg.linkedArea : \"\";\nlet speakers = msg.speakers;\nlet msgSound = [];\nlet msgSpeak = [];\n\nif (speakers.length == 1 && \"linkedDefault\" in speakers[0] && speakers[0].linkedDefault) {\n    setSpeaker(speakers[0]);\n} else {\n    for (let speaker of speakers) {\n        setSpeaker(speaker);\n    }\n}\n\nreturn [msgSound, msgSpeak];\n\nfunction setSpeaker(speaker) {\n    let entity_options = {\n        speaker: speaker.entity_id,\n        volumeLevel: \"volumeLevel\" in msg ? msg.volumeLevel : speaker.defaultVolumeLevel,\n        defaultVolumeLevel: speaker.defaultVolumeLevel\n    };\n    if (\"sound\" in msg && msg.sound != \"\") {\n        msgSound.push({\n            ...entity_options,\n            sound: msg.sound\n        });\n    } else if (\"speak\" in msg && msg.speak != \"\") {\n        msgSpeak.push({\n            ...entity_options,\n            speak: msg.speak\n        });\n    }\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":80,"wires":[["b446bc24476246cd"],["65ee92959252a94a"]]},{"id":"b446bc24476246cd","type":"api-call-service","z":"dbf17bea6affd2ec","name":"set vol","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{speaker}}\",\"volume_level\":\"{{volumeLevel}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":770,"y":80,"wires":[["c2e53d0c272a5a5b"]]},{"id":"65ee92959252a94a","type":"api-call-service","z":"dbf17bea6affd2ec","name":"set vol","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{speaker}}\",\"volume_level\":\"{{volumeLevel}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":770,"y":140,"wires":[["016875b1df284bf6"]]},{"id":"c90e53f5c4e8e1e2","type":"api-call-service","z":"723d4991c3c87385","name":"call service","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":330,"y":60,"wires":[[]]},{"id":"955123ec73074cbf","type":"function","z":"723d4991c3c87385","name":"call prepare","func":"if (\"entity_id\" in msg && msg.entity_id != \"\" && \"state\" in msg && msg.state != \"\") {\n    let switchDomain = [\"input_boolean\", \"switch\"];\n    let numberDomain = [\"input_number\"];\n    let lightDomain = [\"light\"];\n    msg.domain = msg.entity_id.split(\".\")[0];\n    if (switchDomain.includes(msg.domain)) {\n        msg.service = \"turn_\" + msg.state;\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id\n            }\n        };\n        return msg;\n    } else if (numberDomain.includes(msg.domain)) {\n        msg.service = \"set_value\";\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id, value: msg.state\n            }\n        };\n        return msg;\n    } else if (lightDomain.includes(msg.domain)){\n        msg.service = \"turn_\" + msg.state;\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id\n            }\n        };\n        return msg;\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":60,"wires":[["c90e53f5c4e8e1e2"]]},{"id":"bdd49c309e819698","type":"function","z":"ad3b29a5dd67898f","name":"send dashboard bug","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet exceptions = [\"Lights_control_lights\"];\n\nif (Object.keys(ha_configuration).length != 0 && \"error\" in msg && \"source\" in msg.error && \"name\" in msg.error.source) {\n    let notifications = global.get(\"notifications\") || {};\n\n    msg.alertType = \"error\";\n    msg.title = \"Erreur détéctée\";\n    msg.notification_id = (msg.flowTitle + \"_\" + msg.error.source.name).replaceAll(\" \", \"_\");\n    msg.message = \"Erreur : \" + msg.flowTitle + \" > \" + msg.error.source.name + \" > \" + msg.error.message;\n\n    if (!exceptions.includes(msg.notification_id)) {\n        if (msg.notification_id in notifications) {\n            msg.message += \", apparue \" + (notifications[msg.notification_id].count + 1) + \" fois.\";\n        } else {\n            msg.sendMobile = true;\n        }\n\n        msg.zone = [\"inside\", \"outside\"];\n        msg.data = {};\n        return msg;\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":200,"y":40,"wires":[["6280166330ae9f71"]]},{"id":"2a0d685e1c4f2f92","type":"subflow:6c4028aab794d52d","z":"ad3b29a5dd67898f","name":"","x":550,"y":40,"wires":[[]]},{"id":"6280166330ae9f71","type":"delay","z":"ad3b29a5dd67898f","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"4","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":390,"y":40,"wires":[["2a0d685e1c4f2f92"]]},{"id":"b4b8c8acb4afc630","type":"function","z":"6c4028aab794d52d","name":"create notification","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\n\nif (Object.keys(ha_configuration).length != 0) {\n    let notifications = global.get(\"notifications\") || {};\n    if (!(msg.notification_id in notifications)) {\n        notifications[msg.notification_id] = {};\n        notifications[msg.notification_id].count = 1;\n        msg.create = true;\n    } else {\n        notifications[msg.notification_id].count++;\n    }\n\n    notifications[msg.notification_id].title = msg.title || \"\";\n    notifications[msg.notification_id].message = msg.message != \"\" ? msg.currentTime + \" : \" + msg.message : \"\";\n    notifications[msg.notification_id].alertType = msg.alertType || \"\";\n    notifications[msg.notification_id].zone = msg.zone || [\"inside\", \"outside\"];\n\n    global.set(\"notifications\", notifications);\n    msg.notification = notifications[msg.notification_id];\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":140,"wires":[["01115ff6eea2fb4d","db39b80e5ccab19b"]]},{"id":"db39b80e5ccab19b","type":"api-call-service","z":"6c4028aab794d52d","name":"","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"persistent_notification","service":"create","areaId":[],"deviceId":[],"entityId":[],"data":"{\"title\":\"{{notification.title}}\",\"message\":\"{{notification.message}}\",\"notification_id\":\"{{notification_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":740,"y":140,"wires":[[]]},{"id":"321f2d38a11d9f17","type":"switch","z":"6c4028aab794d52d","name":"notification_id ?","property":"notification_id","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":200,"y":80,"wires":[["74ef1627ad31a835","40fb28bbf56378fe"]]},{"id":"74ef1627ad31a835","type":"switch","z":"6c4028aab794d52d","name":"dismiss ?","property":"dismiss","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":600,"y":80,"wires":[["ed73f233a30a209c"]]},{"id":"1fbb7266d0e73a79","type":"api-call-service","z":"6c4028aab794d52d","name":"","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"persistent_notification","service":"dismiss","areaId":[],"deviceId":[],"entityId":[],"data":"{\"notification_id\":\"{{notification_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":270,"y":320,"wires":[[]]},{"id":"3f253902f407ad63","type":"link out","z":"6c4028aab794d52d","name":"link out 195","mode":"link","links":["fbbcce304f59d362","f645dba0f4e95e1c"],"x":495,"y":80,"wires":[]},{"id":"fbbcce304f59d362","type":"link in","z":"6c4028aab794d52d","name":"link in 211","links":["3f253902f407ad63"],"x":105,"y":140,"wires":[["a227c8d7762bf9d8"]]},{"id":"ed73f233a30a209c","type":"link out","z":"6c4028aab794d52d","name":"link out 196","mode":"link","links":["a6c8b9172e0373db","a663712effcb42a4","bf4456170c254191"],"x":695,"y":80,"wires":[]},{"id":"a6c8b9172e0373db","type":"link in","z":"6c4028aab794d52d","name":"link in 212","links":["ed73f233a30a209c"],"x":105,"y":320,"wires":[["1fbb7266d0e73a79"]]},{"id":"f81a3cb350671e4a","type":"link in","z":"6c4028aab794d52d","name":"link in 226","links":["01115ff6eea2fb4d"],"x":105,"y":260,"wires":[["c190501f4e472b81"]]},{"id":"9e6e87f91de1cad9","type":"link in","z":"6c4028aab794d52d","name":"link in 227","links":["01115ff6eea2fb4d"],"x":105,"y":200,"wires":[["e0e835a1bf17022a"]]},{"id":"2d47b21860760270","type":"subflow:dbf17bea6affd2ec","z":"6c4028aab794d52d","name":"","x":590,"y":200,"wires":[]},{"id":"fdf5af559e33c154","type":"function","z":"6c4028aab794d52d","name":"check","func":"if ((\"sound\" in msg && msg.sound != \"\") || (\"speak\" in msg && msg.speak != \"\")) {\n    return msg;\n} ","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":200,"wires":[["2d47b21860760270"]]},{"id":"bca42d4e03bd9757","type":"subflow:5a05b9ac0289ff03","z":"6c4028aab794d52d","name":"","env":[],"x":940,"y":200,"wires":[]},{"id":"978c4335d7467059","type":"switch","z":"6c4028aab794d52d","name":"lightEffect ?","property":"lightEffect","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":770,"y":200,"wires":[["bca42d4e03bd9757"]]},{"id":"01115ff6eea2fb4d","type":"link out","z":"6c4028aab794d52d","name":"link out 226","mode":"link","links":["f81a3cb350671e4a","9e6e87f91de1cad9"],"x":575,"y":140,"wires":[]},{"id":"40fb28bbf56378fe","type":"switch","z":"6c4028aab794d52d","name":"create update ?","property":"dismiss","propertyType":"msg","rules":[{"t":"null"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":380,"y":80,"wires":[["3f253902f407ad63"],["3f253902f407ad63"]]},{"id":"bf4456170c254191","type":"link in","z":"6c4028aab794d52d","name":"link in 231","links":["ed73f233a30a209c"],"x":165,"y":260,"wires":[["c190501f4e472b81"]]},{"id":"a663712effcb42a4","type":"link in","z":"6c4028aab794d52d","name":"link in 232","links":["ed73f233a30a209c"],"x":165,"y":200,"wires":[["e0e835a1bf17022a"]]},{"id":"ba2ec713942851f0","type":"subflow:ba09e97f2ed22f2b","z":"6c4028aab794d52d","name":"","x":460,"y":260,"wires":[]},{"id":"27be3bd3583772c1","type":"server-events","z":"6c4028aab794d52d","name":"persistent_notification","server":"66876666.3e6288","version":2,"eventType":"call_service","exposeToHomeAssistant":false,"eventData":"{\"domain\":\"persistent_notification\"}","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"notification","propertyType":"msg","value":"","valueType":"eventData"}],"event_type":"","x":160,"y":420,"wires":[["74186c0c46658fa0","628251e2da9da6f5"]]},{"id":"74186c0c46658fa0","type":"switch","z":"6c4028aab794d52d","name":"dismiss","property":"notification.event.service","propertyType":"msg","rules":[{"t":"eq","v":"dismiss","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":460,"y":420,"wires":[["7e00d134f3038fd4"]]},{"id":"628251e2da9da6f5","type":"switch","z":"6c4028aab794d52d","name":"create","property":"notification.event.service","propertyType":"msg","rules":[{"t":"eq","v":"create","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":330,"y":420,"wires":[[]]},{"id":"7e00d134f3038fd4","type":"function","z":"6c4028aab794d52d","name":"delete notification","func":"let notifications = global.get(\"notifications\") || {};\ndelete notifications[msg.notification.event.service_data.notification_id];\nmsg.payload = notifications;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":420,"wires":[[]]},{"id":"c190501f4e472b81","type":"api-current-state","z":"6c4028aab794d52d","name":"home empty ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"0","halt_if_type":"num","halt_if_compare":"is","entity_id":"zone.home","state_type":"num","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":280,"y":260,"wires":[["ba2ec713942851f0"],[]]},{"id":"e0e835a1bf17022a","type":"api-current-state","z":"6c4028aab794d52d","name":"home empty ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"0","halt_if_type":"num","halt_if_compare":"is","entity_id":"zone.home","state_type":"num","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":280,"y":200,"wires":[[],["3adc7b288499c7d8","fdf5af559e33c154"]]},{"id":"f30416d398faac8e","type":"time-range-switch","z":"6c4028aab794d52d","name":"enable to speak","lat":"46.98408","lon":"3.16098","startTime":"07:00","endTime":"23:30","startOffset":0,"endOffset":0,"x":1120,"y":200,"wires":[[],[]]},{"id":"a227c8d7762bf9d8","type":"moment","z":"6c4028aab794d52d","name":"","topic":"","input":"","inputType":"date","inTz":"ETC/UTC","adjAmount":"0","adjType":"hours","adjDir":"add","format":"HH:mm","locale":"C","output":"currentTime","outputType":"msg","outTz":"Europe/Paris","x":240,"y":140,"wires":[["b4b8c8acb4afc630"]]},{"id":"6a3d5dea1ffbb2d8","type":"function","z":"10a4bbabe046de0e","name":"lock / unlock","func":"let lockedLights = global.get(\"lockedLights\") || [];\n\nif (\"lock\" in msg && \"lockLights\" in msg) {\n    if (msg.lock) {\n        for (let light of msg.lockLights) {\n            if (!lockedLights.includes(light)) {\n                lockedLights.push(light);\n            }\n        }\n    } else if (!msg.lock) {\n        for (let light of msg.lockLights) {\n            if (lockedLights.includes(light)) {\n                lockedLights.splice(lockedLights.indexOf(light), 1);\n            }\n        }\n    }\n    global.set(\"lockedLights\", lockedLights);\n    delete msg.lockLights;\n    delete msg.lock;\n    return msg;\n} else if (\"entity_id\" in msg) {\n    if (!lockedLights.includes(msg.entity_id)) {\n        return msg;\n    }\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":80,"wires":[[]]},{"id":"3ff07ed925623c04","type":"function","z":"10a4bbabe046de0e","name":"set lock","func":"msg.lockLights = msg.linkedLights;\nmsg.lock = msg.cube.flip90;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":140,"wires":[[]]},{"id":"4d176d3140ce157e","type":"function","z":"9b9bfdbe9a43dabb","name":"msg speaker","func":"if (\n    \"speaker\" in msg && msg.speaker.length != 0 &&\n    \"attributes\" in msg.speaker[0] &&\n    \"device_class\" in msg.speaker[0].attributes &&\n    msg.speaker[0].attributes.device_class == \"speaker\") {\n\n    if (msg.action_type == \"stop\") {\n        let sound = \"ambiance_stop.mp3\";\n        msg.payload = {\n            data: {\n                entity_id: msg.linkedSpeaker,\n                media_content_id: \"https://home-assistant-erwan.duckdns.org:8123/local/\" + sound,\n                media_content_type: \"music\"\n            }\n        };\n    } else {\n        msg.payload = {\n            data: {\n                entity_id: msg.linkedSpeaker,\n                media_content_id: msg.ambiance_config.path.start + msg.action_type + msg.ambiance_config.path.end,\n                media_content_type: \"music\"\n            }\n        };\n    }\n    \n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":60,"wires":[["bc8f0e33771eb442"]]},{"id":"45e68e1d589143e7","type":"function","z":"9b9bfdbe9a43dabb","name":"msg","func":"msg.filter = { \"in\": { entity_id: msg.linkedSpeaker } };\nmsg.result = \"speaker\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":60,"wires":[["3d3853bdc960f5ba"]]},{"id":"ae94f5dbaf9be85a","type":"api-call-service","z":"9b9bfdbe9a43dabb","name":"set vol","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":610,"y":60,"wires":[[]]},{"id":"74e34bce502235d6","type":"function","z":"9b9bfdbe9a43dabb","name":"set volume","func":"if (\n    \"speaker\" in msg && msg.speaker.length != 0 &&\n    \"attributes\" in msg.speaker[0] &&\n    \"device_class\" in msg.speaker[0].attributes &&\n    msg.speaker[0].attributes.device_class == \"speaker\") {\n\n    if (msg.action_type == \"stop\") {\n        let defaultVolumeLevel = \"defaultVolumeLevel\" in msg.speaker[0] ? msg.speaker[0].defaultVolumeLevel : 0.4;\n        msg.payload = {\n            data: {\n                entity_id: msg.linkedSpeaker,\n                volume_level: defaultVolumeLevel\n            }\n        };\n    } else {\n        let ambianceVolumeLevel = \"ambianceVolumeLevel\" in msg ? msg.ambianceVolumeLevel : 0.6;\n        msg.payload = {\n            data: {\n                entity_id: msg.linkedSpeaker,\n                volume_level: ambianceVolumeLevel\n            }\n        };\n    }\n\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":60,"wires":[["ae94f5dbaf9be85a"]]},{"id":"bc8f0e33771eb442","type":"api-call-service","z":"9b9bfdbe9a43dabb","name":"set speaker","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":910,"y":60,"wires":[[]]},{"id":"d95af1f39bdc2e43","type":"function","z":"9b9bfdbe9a43dabb","name":"msg","func":"msg.filter = { \"in\": { entity_id: msg.linkedLights } };\nmsg.result = \"lights\";\nmsg.lock = !msg.restore;\nmsg.lockLights = msg.linkedLights;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":120,"wires":[["efeb009e7ddbf987"]]},{"id":"27e428e0387cac8a","type":"function","z":"9b9bfdbe9a43dabb","name":"restore lights","func":"let motionArea = global.get(\"motionArea\");\nlet lights = msg.lights;\nlet areas = [];\nlet msgs = [];\n\nfor (let light of lights) {\n    if (!areas.includes(light.linkedArea)) {\n        areas.push(light.linkedArea);\n    }\n}\n\nfor (let area of areas) {\n    msgs.push({ linkedArea: area, state: motionArea[area] });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":120,"wires":[[]]},{"id":"4f9438c9a5b4c1b4","type":"link out","z":"9b9bfdbe9a43dabb","name":"link out 326","mode":"link","links":["01a2c1e96153b1ea"],"x":855,"y":120,"wires":[]},{"id":"01a2c1e96153b1ea","type":"link in","z":"9b9bfdbe9a43dabb","name":"link in 339","links":["4f9438c9a5b4c1b4"],"x":135,"y":180,"wires":[["f088cfce1985c89d","6a1e98f0e17b03b9"]]},{"id":"ad661360b9c48435","type":"subflow:10a4bbabe046de0e","z":"9b9bfdbe9a43dabb","name":"","x":460,"y":120,"wires":[["a9afa54b296eb45f"]]},{"id":"f088cfce1985c89d","type":"function","z":"9b9bfdbe9a43dabb","name":"prepare lights","func":"if (\"lights\" in msg && msg.lights.length != 0 && \"ambiance_config\" in msg && \"ambiances_type\" in msg.ambiance_config) {\n    if (msg.action_type != \"stop\") {\n        let msgs = [];\n        for (let light of msg.lights) {\n            if (\"attributes\" in light && \"supported_color_modes\" in light.attributes && light.attributes.supported_color_modes.includes(\"rgb\")) {\n                let ambiance_type = msg.ambiance_config.ambiances_type[msg.action_type];\n                let hs = hsRandomValue(ambiance_type.color[0], Math.round(Math.random() * ambiance_type.variance[0]), 0, 360);\n                let saturation = randomValue(ambiance_type.color[1], Math.round(Math.random() * ambiance_type.variance[1]), 0, 100);\n                let brightness = randomValue(ambiance_type.color[2], Math.round(Math.random() * ambiance_type.variance[2]), 0, 100);\n                let delay = 1000 + Math.round(Math.random() * 14000);\n                msgs.push({\n                    entity_id: light.entity_id,\n                    action_type: msg.action_type,\n                    ambiance_config: msg.ambiance_config,\n                    delay: delay,\n                    payload: {\n                        data: {\n                            entity_id: light.entity_id,\n                            hs_color: [hs, saturation],\n                            brightness_pct: brightness,\n                            transition: Math.round(delay / 100) / 10\n                        }\n                    }\n                });\n            }\n        }\n        msg.reset = true;\n        return [msgs, msg];\n    } else {\n        msg.reset = true;\n        return [null, msg];\n    }\n}\n\nfunction hsRandomValue(value, variance, lowRange, highRange) {\n    let random = Math.random();\n    return random < 0.5 ? (value - variance < lowRange ? highRange - variance : value - variance) : (value + variance > highRange ? lowRange + variance : value + variance);\n}\n\nfunction randomValue(value, variance, lowRange, highRange) {\n    let random = Math.random();\n    return random < 0.5 ? (value - variance < lowRange ? lowRange : value - variance) : (value + variance > highRange ? highRange : value + variance);\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":180,"wires":[["badb8d2fb8ab5aa3","a9fcbb2aa70ea1f8"],["0cdd3aae865a31cf"]]},{"id":"a9afa54b296eb45f","type":"switch","z":"9b9bfdbe9a43dabb","name":"restore","property":"restore","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":600,"y":120,"wires":[["27e428e0387cac8a"]]},{"id":"52d03fb81f2ee80c","type":"api-call-service","z":"9b9bfdbe9a43dabb","name":"control lights","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":530,"y":180,"wires":[[]]},{"id":"9e5c408e79ac1df8","type":"delay","z":"9b9bfdbe9a43dabb","name":"timer","pauseType":"delayv","timeout":"1","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"10","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":670,"y":180,"wires":[["99fa979c22389f12"]]},{"id":"99fa979c22389f12","type":"function","z":"9b9bfdbe9a43dabb","name":"prepare light","func":"if (msg.action_type != \"stop\") {\n    let ambiance_type = msg.ambiance_config.ambiances_type[msg.action_type];\n    let hs = hsRandomValue(ambiance_type.color[0], Math.round(Math.random() * ambiance_type.variance[0]), 0, 360);\n    let saturation = randomValue(ambiance_type.color[1], Math.round(Math.random() * ambiance_type.variance[1]), 0, 100);\n    let brightness = randomValue(ambiance_type.color[2], Math.round(Math.random() * ambiance_type.variance[2]), 0, 100);\n    let delay = 1000 + Math.round(Math.random() * 14000);\n\n    msg.delay = delay;\n    if (msg.action_type == \"thunderstorm\" && delay < 1500) {\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id,\n                effect: \"Strobe epilepsy!\"\n            }\n        };        \n    } else {\n        msg.payload = {\n            data: {\n                entity_id: msg.entity_id,\n                hs_color: [hs, saturation],\n                brightness_pct: brightness,\n                transition: Math.round(delay / 100) / 10\n            }\n        };\n    }\n\n    return msg;\n}\n\nfunction hsRandomValue(value, variance, lowRange, highRange) {\n    let random = Math.random();\n    return random < 0.5 ? (value - variance < lowRange ? highRange - variance : value - variance) : (value + variance > highRange ? lowRange + variance : value + variance);\n}\n\nfunction randomValue(value, variance, lowRange, highRange) {\n    let random = Math.random();\n    return random < 0.5 ? (value - variance < lowRange ? lowRange : value - variance) : (value + variance > highRange ? highRange : value + variance);\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":180,"wires":[["df2086a6c727f6f7"]]},{"id":"df2086a6c727f6f7","type":"link out","z":"9b9bfdbe9a43dabb","name":"link out 327","mode":"link","links":["9fedc4504beff3ff"],"x":915,"y":180,"wires":[]},{"id":"9fedc4504beff3ff","type":"link in","z":"9b9bfdbe9a43dabb","name":"link in 340","links":["df2086a6c727f6f7"],"x":425,"y":180,"wires":[["52d03fb81f2ee80c","9e5c408e79ac1df8"]]},{"id":"badb8d2fb8ab5aa3","type":"delay","z":"9b9bfdbe9a43dabb","name":"","pauseType":"delay","timeout":"0.5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":375,"y":180,"wires":[["9e5c408e79ac1df8"]],"l":false},{"id":"3d3853bdc960f5ba","type":"subflow:ea5b93cde6b1bf0a","z":"9b9bfdbe9a43dabb","name":"","x":310,"y":60,"wires":[["74e34bce502235d6","4d176d3140ce157e"]]},{"id":"efeb009e7ddbf987","type":"subflow:ea5b93cde6b1bf0a","z":"9b9bfdbe9a43dabb","name":"","x":310,"y":120,"wires":[["4f9438c9a5b4c1b4","ad661360b9c48435"]]},{"id":"05537233af43e407","type":"delay","z":"9b9bfdbe9a43dabb","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":435,"y":240,"wires":[["c83520ded53399c4"]],"l":false},{"id":"6a1e98f0e17b03b9","type":"switch","z":"9b9bfdbe9a43dabb","name":"stop","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"stop","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":230,"y":240,"wires":[["aba5e92a0de87c53"],["05537233af43e407"]]},{"id":"aba5e92a0de87c53","type":"change","z":"9b9bfdbe9a43dabb","name":"reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":240,"wires":[["05537233af43e407"]]},{"id":"c83520ded53399c4","type":"change","z":"9b9bfdbe9a43dabb","name":"option","rules":[{"t":"set","p":"option","pt":"msg","to":"ha_configuration.ambiance_config.ambiances_type.stop.name","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":530,"y":240,"wires":[[]]},{"id":"c6e5e0125cf4b4ec","type":"function","z":"ea5b93cde6b1bf0a","name":"get entities","func":"let resultVarName = \"result\" in msg ? msg.result : \"entities\";\nlet ha_configuration = global.get(\"ha_configuration\") || {};\nlet filter = msg.filter || {};\nmsg[resultVarName] = [];\n\nif (Object.keys(filter).length != 0) {\n    for (let entity_id of Object.keys(ha_configuration)) {\n        let entity = {\n            ...ha_configuration[entity_id],\n            ...(entity_id in global.get(\"homeassistant\").homeAssistant.states ? global.get(\"homeassistant\").homeAssistant.states[entity_id] : {})\n        };\n        if (applyFilter(entity)) {\n            msg[resultVarName].push(entity);\n        }\n    }\n}\n\nfunction applyFilter(entity) {\n    let validate = true;\n    if (\"not in\" in filter) {\n        for (let f of Object.keys(filter[\"not in\"])) {\n            if (Array.isArray(filter[\"not in\"][f])) {\n                validate = validate && !filter[\"not in\"][f].includes(entity[f]);\n            } else {\n                validate = validate && !(f in entity && entity[f] == filter[\"not in\"][f]);\n            }\n            if (!validate) {\n                return validate;\n            }\n        }\n    }\n    if (\"in\" in filter) {\n        for (let f of Object.keys(filter[\"in\"])) {\n            if (Array.isArray(filter[\"in\"][f])) {\n                validate = validate && filter[\"in\"][f].includes(entity[f]);\n            } else {\n                validate = validate && (f in entity && entity[f] == filter[\"in\"][f]);\n            }\n            if (!validate) {\n                return validate;\n            }\n        }\n    }\n    return validate;\n}\n\ndelete msg.result;\ndelete msg.filter;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":60,"wires":[[]]},{"id":"1363bf94c6390b98","type":"function","z":"ea5b93cde6b1bf0a","name":"msg","func":"msg.filter = { \"in\": { entity_id: msg.linkedSpeaker } };\nmsg.result = \"speaker\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":120,"wires":[[]]},{"id":"8427d78ffb22a963","type":"function","z":"612068fa04cc8bbd","name":"msg speaker","func":"if (\n    \"speaker\" in msg && msg.speaker.length != 0 &&\n    \"attributes\" in msg.speaker[0] &&\n    \"device_class\" in msg.speaker[0].attributes &&\n    msg.speaker[0].attributes.device_class == \"speaker\" && msg.sound != \"\") {\n\n    let speaker = msg.speaker[0];\n    msg.payload = {\n        data: {\n            entity_id: speaker.entity_id,\n            media_content_id: \"https://home-assistant-erwan.duckdns.org:8123/local/\" + msg.sound,\n            media_content_type: \"music\"\n        }\n    };\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":120,"wires":[["1250be10a8843b68"]]},{"id":"fe5a2c41ba0ece4a","type":"function","z":"612068fa04cc8bbd","name":"msg","func":"msg.filter = { \"in\": { entity_id: [msg.linkedSpeaker] } };\nmsg.result = \"speaker\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":120,"wires":[["ee1dc161b4b1aca4"]]},{"id":"4d0457a2e27a298e","type":"switch","z":"612068fa04cc8bbd","name":"flip90","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"flip90","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":170,"y":240,"wires":[["1d0a618a86abc4be"]]},{"id":"052154c2e0d092dd","type":"switch","z":"612068fa04cc8bbd","name":"shake_air","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"shake_air","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":580,"y":300,"wires":[["20712a615a75c746"]]},{"id":"adbac37af81d1efd","type":"switch","z":"612068fa04cc8bbd","name":"rotate","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"rotate","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":450,"y":300,"wires":[["20712a615a75c746"]]},{"id":"e8c9b0131930af7f","type":"switch","z":"612068fa04cc8bbd","name":"free_fall","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"free_fall","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":720,"y":300,"wires":[["20712a615a75c746"]]},{"id":"561d43ede593e22a","type":"switch","z":"612068fa04cc8bbd","name":"move","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"move","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":330,"y":300,"wires":[["20712a615a75c746"]]},{"id":"1d0a618a86abc4be","type":"function","z":"612068fa04cc8bbd","name":"set flip90","func":"msg.lockLights = msg.linkedLights;\nmsg.lock = msg.cube.flip90;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":240,"wires":[["93cc5a471dff46cf"]]},{"id":"93cc5a471dff46cf","type":"subflow:10a4bbabe046de0e","z":"612068fa04cc8bbd","name":"","x":440,"y":240,"wires":[["8e986b6814a118de"]]},{"id":"d539340592244119","type":"function","z":"612068fa04cc8bbd","name":"msg","func":"msg.filter = { \"in\": { entity_id: msg.linkedLights } };\nmsg.result = \"lights\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":360,"wires":[["c0909bf2cc5938c5"]]},{"id":"7d1baedd2aaa770c","type":"api-call-service","z":"612068fa04cc8bbd","name":"control lights","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":730,"y":360,"wires":[[]]},{"id":"4fa4465bfee4db09","type":"function","z":"612068fa04cc8bbd","name":"prepare lights msgs","func":"let noSupportedRgbLights = [];\nlet supportedRgbLights = [];\nlet lights = msg.lights;\nlet msgs = [];\n\nfor (let light of lights) {\n    if (\"supported_color_modes\" in light.attributes && light.attributes.supported_color_modes.includes(\"rgb\")) {\n        supportedRgbLights.push(light.entity_id);\n    }\n    if (\"supported_color_modes\" in light.attributes && !light.attributes.supported_color_modes.includes(\"rgb\")) {\n        noSupportedRgbLights.push(light.entity_id);\n    }\n}\n\nif (noSupportedRgbLights.length != 0) {\n    msgs.push({\n        payload: { \"data\": { \"entity_id\": noSupportedRgbLights, \"brightness_pct\": !msg.cube.free_fall && msg.cube.shake_air ? msg.lightPower : 0, \"color_temp\": msg.colorTemp } }\n    });\n}\n\nif (supportedRgbLights.length != 0) {\n    if (msg.cube.move) {\n        msgs.push({\n            payload: { \"data\": { \"entity_id\": supportedRgbLights, \"brightness_pct\": !msg.cube.free_fall ? msg.lightPower : 0, \"hs_color\": [msg.lightColor, 100] } }\n        });\n    } else {\n        msgs.push({\n            payload: { \"data\": { \"entity_id\": supportedRgbLights, \"brightness_pct\": !msg.cube.free_fall ? msg.lightPower : 0, \"color_temp\": msg.colorTemp } }\n        });\n    }\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":360,"wires":[["7d1baedd2aaa770c"]]},{"id":"1dbd6d25e340e304","type":"link in","z":"612068fa04cc8bbd","name":"link in 341","links":["806b922bb41828e4","8e986b6814a118de"],"x":135,"y":120,"wires":[["fe5a2c41ba0ece4a"]]},{"id":"8e986b6814a118de","type":"link out","z":"612068fa04cc8bbd","name":"link out 328","mode":"link","links":["1dbd6d25e340e304","e24925e9228a946c"],"x":535,"y":240,"wires":[]},{"id":"e24925e9228a946c","type":"link in","z":"612068fa04cc8bbd","name":"link in 342","links":["8e986b6814a118de","20712a615a75c746"],"x":135,"y":360,"wires":[["d539340592244119"]]},{"id":"20712a615a75c746","type":"link out","z":"612068fa04cc8bbd","name":"link out 329","mode":"link","links":["e24925e9228a946c"],"x":815,"y":300,"wires":[]},{"id":"188d4197be377390","type":"switch","z":"612068fa04cc8bbd","name":"tap_twice","property":"action_type","propertyType":"msg","rules":[{"t":"eq","v":"tap_twice","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":180,"y":60,"wires":[["4083f149db8cfa38"]]},{"id":"ab82ed8311159e56","type":"link in","z":"612068fa04cc8bbd","name":"link in 343","links":["806b922bb41828e4"],"x":135,"y":180,"wires":[["32b1085949c8bcb3"]]},{"id":"32b1085949c8bcb3","type":"function","z":"612068fa04cc8bbd","name":"msg","func":"msg.filter = { \"in\": { linkedClass: \"light\", entity_id: msg.linkedLights } };\nmsg.result = \"lights\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":180,"wires":[["12bcaa8513c71b16"]]},{"id":"473feda77b747512","type":"function","z":"612068fa04cc8bbd","name":"restore lights","func":"let motionArea = global.get(\"motionArea\");\nlet lights = msg.lights;\nlet areas = [];\nlet msgs = [];\n\nfor (let light of lights) {\n    if (!areas.includes(light.linkedArea)) {\n        areas.push(light.linkedArea);\n    }\n}\n\nfor (let area of areas) {\n    msgs.push({ linkedArea: area, state: motionArea[area] });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":180,"wires":[[]]},{"id":"4083f149db8cfa38","type":"function","z":"612068fa04cc8bbd","name":"set tap_twice","func":"msg.lockLights = msg.linkedLights;\nmsg.lock = false;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":60,"wires":[["8fa0b486a664301b"]]},{"id":"8fa0b486a664301b","type":"subflow:10a4bbabe046de0e","z":"612068fa04cc8bbd","name":"","x":480,"y":60,"wires":[["806b922bb41828e4"]]},{"id":"806b922bb41828e4","type":"link out","z":"612068fa04cc8bbd","name":"link out 331","mode":"link","links":["1dbd6d25e340e304","ab82ed8311159e56"],"x":575,"y":60,"wires":[]},{"id":"c0909bf2cc5938c5","type":"subflow:ea5b93cde6b1bf0a","z":"612068fa04cc8bbd","name":"","x":370,"y":360,"wires":[["4fa4465bfee4db09"]]},{"id":"ee1dc161b4b1aca4","type":"subflow:ea5b93cde6b1bf0a","z":"612068fa04cc8bbd","name":"","x":370,"y":120,"wires":[["8427d78ffb22a963"]]},{"id":"12bcaa8513c71b16","type":"subflow:ea5b93cde6b1bf0a","z":"612068fa04cc8bbd","name":"","x":370,"y":180,"wires":[["473feda77b747512"]]},{"id":"73bf36ac50e00297","type":"switch","z":"612068fa04cc8bbd","name":"cube flip90","property":"cube.flip90","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":190,"y":300,"wires":[["561d43ede593e22a","adbac37af81d1efd","052154c2e0d092dd","e8c9b0131930af7f"]]},{"id":"1250be10a8843b68","type":"api-call-service","z":"612068fa04cc8bbd","name":"set speaker","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":690,"y":120,"wires":[[]]},{"id":"1dee8c383dad1dc9","type":"function","z":"050c60654a910e68","name":"prepare waits","func":"let msgs = [];\n\nif (msg.waits.length != 0 && msg.states.length == msg.waits.length) {\n    for (let i = 0; i < msg.waits.length; i++) {\n        msgs.push({ ...msg, wait_entity_id: msg.waits[i], wait_state: msg.states[i], count: i });\n    }\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":60,"wires":[["5ff166ae2792d64c"]]},{"id":"d3ca50e2799953d7","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"66876666.3e6288","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeout","timeoutType":"jsonata","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":670,"y":60,"wires":[["4a0d1a73e7adcc11"],["4a0d1a73e7adcc11"]]},{"id":"a71b128c6a11f16e","type":"change","z":"050c60654a910e68","name":"reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":890,"y":60,"wires":[["b08aef3e9a7c901b"]]},{"id":"300dfabdcd908fd9","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"66876666.3e6288","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeout","timeoutType":"jsonata","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":670,"y":120,"wires":[["4a0d1a73e7adcc11"],["4a0d1a73e7adcc11"]]},{"id":"e58d38a7afe6e5e5","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"66876666.3e6288","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeout","timeoutType":"jsonata","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":670,"y":180,"wires":[["4a0d1a73e7adcc11"],["4a0d1a73e7adcc11"]]},{"id":"9bdf1086b4bdec91","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"66876666.3e6288","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeout","timeoutType":"jsonata","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":670,"y":240,"wires":[["4a0d1a73e7adcc11"],["4a0d1a73e7adcc11"]]},{"id":"2c104887531dbd31","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"66876666.3e6288","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeout","timeoutType":"jsonata","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":670,"y":300,"wires":[["4a0d1a73e7adcc11"],["4a0d1a73e7adcc11"]]},{"id":"eaeda3c13f3fda3b","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"66876666.3e6288","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeout","timeoutType":"jsonata","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":670,"y":360,"wires":[["4a0d1a73e7adcc11"],["4a0d1a73e7adcc11"]]},{"id":"d616641422d1e85a","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"66876666.3e6288","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeout","timeoutType":"jsonata","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":670,"y":420,"wires":[["4a0d1a73e7adcc11"],["4a0d1a73e7adcc11"]]},{"id":"09152de118411910","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"66876666.3e6288","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeout","timeoutType":"jsonata","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":670,"y":480,"wires":[["4a0d1a73e7adcc11"],["4a0d1a73e7adcc11"]]},{"id":"af75c05a4a5d4955","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"66876666.3e6288","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeout","timeoutType":"jsonata","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":670,"y":540,"wires":[["4a0d1a73e7adcc11"],["4a0d1a73e7adcc11"]]},{"id":"e3b0c1e807acb20b","type":"ha-wait-until","z":"050c60654a910e68","name":"wait entity_id","server":"66876666.3e6288","version":2,"outputs":2,"entityId":"{{wait_entity_id}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"wait_state","valueType":"msg","timeout":"timeout","timeoutType":"jsonata","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":670,"y":600,"wires":[["4a0d1a73e7adcc11"],["4a0d1a73e7adcc11"]]},{"id":"87d844bd45fccde6","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":410,"y":60,"wires":[["d3ca50e2799953d7"]]},{"id":"af650c007ffa4b39","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":410,"y":120,"wires":[["300dfabdcd908fd9"]]},{"id":"1ac121c8d607267c","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"2","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":410,"y":180,"wires":[["e58d38a7afe6e5e5"]]},{"id":"1d64b1cbe71c8c65","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":410,"y":240,"wires":[["9bdf1086b4bdec91"]]},{"id":"9c265cc1eaad53bb","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"4","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":410,"y":300,"wires":[["2c104887531dbd31"]]},{"id":"69317bea361bf45e","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"5","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":410,"y":360,"wires":[["eaeda3c13f3fda3b"]]},{"id":"9d50472878b093d6","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"6","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":410,"y":420,"wires":[["d616641422d1e85a"]]},{"id":"ab3f5f1f4b645507","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"7","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":410,"y":480,"wires":[["09152de118411910"]]},{"id":"9147624e46fd3b8b","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"8","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":410,"y":540,"wires":[["af75c05a4a5d4955"]]},{"id":"e6e0a2f4b0faf93f","type":"switch","z":"050c60654a910e68","name":"count","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"9","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":410,"y":600,"wires":[["e3b0c1e807acb20b"]]},{"id":"b08aef3e9a7c901b","type":"link out","z":"050c60654a910e68","name":"link out 353","mode":"link","links":["dd24f19d09420eb6"],"x":975,"y":60,"wires":[]},{"id":"dd24f19d09420eb6","type":"link in","z":"050c60654a910e68","name":"link in 368","links":["b08aef3e9a7c901b"],"x":505,"y":60,"wires":[["d3ca50e2799953d7","300dfabdcd908fd9","e58d38a7afe6e5e5","9bdf1086b4bdec91","2c104887531dbd31","eaeda3c13f3fda3b","d616641422d1e85a","09152de118411910","af75c05a4a5d4955","e3b0c1e807acb20b"]]},{"id":"4095fa2ccd977940","type":"change","z":"050c60654a910e68","name":"","rules":[{"t":"delete","p":"wait_entity_id","pt":"msg"},{"t":"delete","p":"wait_state","pt":"msg"},{"t":"delete","p":"timeout","pt":"msg"},{"t":"delete","p":"waits","pt":"msg"},{"t":"delete","p":"states","pt":"msg"},{"t":"delete","p":"count","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1100,"y":60,"wires":[["cbbaf5fe1d43c359"]]},{"id":"cbbaf5fe1d43c359","type":"delay","z":"050c60654a910e68","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":1270,"y":60,"wires":[[]]},{"id":"dd7125b940e5e663","type":"function","z":"050c60654a910e68","name":"set waits","func":"let motions = msg.motions;\nmsg.waits = [];\nmsg.states = [];\n\nfor(let motion of motions){\n    msg.waits.push(motion.entity_id);\n    msg.states.push(\"on\");\n    msg.timeout = 20;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":120,"wires":[[]]},{"id":"7a326f951564d5db","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":60,"wires":[["cc4e9a25b741e5b5"],["983c576accbdd1a8"]]},{"id":"f51dc77777d8f60b","type":"function","z":"7166242293a03ec9","name":"count","func":"let ambiances = global.get(\"ambiances\") || {};\nlet linkedAmbiance = msg.linkedAmbiance;\n\nmsg.count = Object.keys(ambiances).indexOf(msg.linkedAmbiance);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":60,"wires":[["4f25dbc1a164f41f"]]},{"id":"7f0acd26f3c01f74","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":120,"wires":[["df96ad23721c9b37"],["c4ce766bfba99f60"]]},{"id":"939c33b32ba14e28","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":180,"wires":[["a3910fff73ce4d4b"],["02bd6203821573d6"]]},{"id":"bd39a0530a2296c9","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":240,"wires":[["3f899843af04db15"],["494b9ad847029c04"]]},{"id":"47f76380129d7466","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":300,"wires":[["c1144f4ae8809948"],["a0dc0c93931f1e10"]]},{"id":"544c5beb752c4b83","type":"subflow:9b9bfdbe9a43dabb","z":"7166242293a03ec9","name":"","x":580,"y":360,"wires":[["13014577787c3ec1"],["9c17c037cc291546"]]},{"id":"cc4e9a25b741e5b5","type":"link out","z":"7166242293a03ec9","name":"link out 376","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":60,"wires":[]},{"id":"907c1f317e2ca3ee","type":"link in","z":"7166242293a03ec9","name":"link in 384","links":["cc4e9a25b741e5b5","df96ad23721c9b37","a3910fff73ce4d4b","3f899843af04db15","c1144f4ae8809948","13014577787c3ec1","5584a83a9faa2c1b"],"x":735,"y":60,"wires":[[]]},{"id":"983c576accbdd1a8","type":"link out","z":"7166242293a03ec9","name":"link out 377","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":60,"wires":[]},{"id":"c728ac07d0d13bab","type":"link in","z":"7166242293a03ec9","name":"link in 385","links":["983c576accbdd1a8","c4ce766bfba99f60","02bd6203821573d6","494b9ad847029c04","a0dc0c93931f1e10","9c17c037cc291546","d4ac5377eff74978"],"x":735,"y":120,"wires":[["b7354c936912ab1e"]]},{"id":"df96ad23721c9b37","type":"link out","z":"7166242293a03ec9","name":"link out 378","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":120,"wires":[]},{"id":"c4ce766bfba99f60","type":"link out","z":"7166242293a03ec9","name":"link out 379","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":120,"wires":[]},{"id":"a3910fff73ce4d4b","type":"link out","z":"7166242293a03ec9","name":"link out 380","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":180,"wires":[]},{"id":"02bd6203821573d6","type":"link out","z":"7166242293a03ec9","name":"link out 381","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":180,"wires":[]},{"id":"3f899843af04db15","type":"link out","z":"7166242293a03ec9","name":"link out 382","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":240,"wires":[]},{"id":"494b9ad847029c04","type":"link out","z":"7166242293a03ec9","name":"link out 383","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":240,"wires":[]},{"id":"c1144f4ae8809948","type":"link out","z":"7166242293a03ec9","name":"link out 384","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":300,"wires":[]},{"id":"a0dc0c93931f1e10","type":"link out","z":"7166242293a03ec9","name":"link out 385","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":300,"wires":[]},{"id":"13014577787c3ec1","type":"link out","z":"7166242293a03ec9","name":"link out 386","mode":"link","links":["907c1f317e2ca3ee"],"x":675,"y":360,"wires":[]},{"id":"9c17c037cc291546","type":"link out","z":"7166242293a03ec9","name":"link out 387","mode":"link","links":["c728ac07d0d13bab"],"x":675,"y":360,"wires":[]},{"id":"ae7861968403f307","type":"switch","z":"7166242293a03ec9","name":"count 1","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":120,"wires":[["7f0acd26f3c01f74"]]},{"id":"e113ddcda7707d78","type":"switch","z":"7166242293a03ec9","name":"count 2","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"2","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":180,"wires":[["939c33b32ba14e28"]]},{"id":"cface082c3f3571c","type":"switch","z":"7166242293a03ec9","name":"count 3","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":240,"wires":[["bd39a0530a2296c9"]]},{"id":"f83935731bab2f93","type":"switch","z":"7166242293a03ec9","name":"count 4","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"4","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":300,"wires":[["47f76380129d7466"]]},{"id":"7b8515b9f1fccf72","type":"switch","z":"7166242293a03ec9","name":"count 5","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"5","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":360,"wires":[["544c5beb752c4b83"]]},{"id":"4f25dbc1a164f41f","type":"link out","z":"7166242293a03ec9","name":"link out 388","mode":"link","links":["346607f7f851b121","87ebde6adf601137","3a0148158457edf5","4cd60f8b7145da89","4272daeffcf81037","fe1c9b9ece62fe4b"],"x":265,"y":60,"wires":[]},{"id":"346607f7f851b121","type":"link in","z":"7166242293a03ec9","name":"link in 386","links":["4f25dbc1a164f41f"],"x":335,"y":60,"wires":[["56f6adecc2b7c507"]]},{"id":"87ebde6adf601137","type":"link in","z":"7166242293a03ec9","name":"link in 387","links":["4f25dbc1a164f41f"],"x":335,"y":120,"wires":[["ae7861968403f307"]]},{"id":"3a0148158457edf5","type":"link in","z":"7166242293a03ec9","name":"link in 388","links":["4f25dbc1a164f41f"],"x":335,"y":180,"wires":[["e113ddcda7707d78"]]},{"id":"4cd60f8b7145da89","type":"link in","z":"7166242293a03ec9","name":"link in 389","links":["4f25dbc1a164f41f"],"x":335,"y":240,"wires":[["cface082c3f3571c"]]},{"id":"4272daeffcf81037","type":"link in","z":"7166242293a03ec9","name":"link in 390","links":["4f25dbc1a164f41f"],"x":335,"y":300,"wires":[["f83935731bab2f93"]]},{"id":"fe1c9b9ece62fe4b","type":"link in","z":"7166242293a03ec9","name":"link in 391","links":["4f25dbc1a164f41f"],"x":335,"y":360,"wires":[["7b8515b9f1fccf72"]]},{"id":"b7354c936912ab1e","type":"api-call-service","z":"7166242293a03ec9","name":"select ambiance","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_select","service":"select_option","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"input_select.{{linkedAmbiance}}\",\"option\":\"{{option}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":860,"y":120,"wires":[[]]},{"id":"56f6adecc2b7c507","type":"switch","z":"7166242293a03ec9","name":"count 0","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":60,"wires":[["7a326f951564d5db"]]},{"id":"13c010508ce67f72","type":"catch","z":"5db64edb8eadb607","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["5e89993c9c22ce96"]]},{"id":"a9b35861543b041d","type":"subflow:ad3b29a5dd67898f","z":"5db64edb8eadb607","name":"","x":460,"y":40,"wires":[]},{"id":"5e89993c9c22ce96","type":"change","z":"5db64edb8eadb607","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Inputs","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["a9b35861543b041d"]]},{"id":"e1ffdf362e4e6ec2","type":"server-events","z":"5db64edb8eadb607","name":"state_changed","server":"66876666.3e6288","version":2,"eventType":"state_changed","exposeToHomeAssistant":false,"eventData":"","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"}],"event_type":"","x":120,"y":300,"wires":[["e7a8d7f4cd35fbcc","5dc09e4546d9e62a","0aee7b103ab2abff"]]},{"id":"0aee7b103ab2abff","type":"link out","z":"5db64edb8eadb607","name":"detect state_changed","mode":"link","links":["b7f95571f58da4b8"],"x":235,"y":300,"wires":[]},{"id":"b7f95571f58da4b8","type":"link in","z":"5db64edb8eadb607","name":"link in 259","links":["0aee7b103ab2abff"],"x":375,"y":120,"wires":[["d22abdd33ba9aee7"]]},{"id":"906539269e197641","type":"server-state-changed","z":"5db64edb8eadb607","name":"reload ha_configuration","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.reload_ha_configuration","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":140,"y":120,"wires":[["4706abe170888960","138f69c8f792548d"],[]]},{"id":"4706abe170888960","type":"api-call-service","z":"5db64edb8eadb607","name":"turn off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.reload_ha_configuration"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":275,"y":120,"wires":[["8a7374ae240edc55"]],"l":false},{"id":"6c9a074a2dc15225","type":"link out","z":"5db64edb8eadb607","name":"key exist","mode":"link","links":["0e4671741c814d23","3731f5663a3d6080","5209db7b34653379","654f65aa1d1d3a0b","7a5411f93f6c3f3f","8b943fca42c01b65","9274c7b1fbee1e2c","ab09dc8260c48f59","ad2f2718523d973b","b3ce9acdeb52eeb2","b99794334aba637b","c07188f127519436","d512c613f3875d4b","efb17b3e40b2e28c","f298332e4c67a310","39865ab68216d6a6"],"x":435,"y":300,"wires":[]},{"id":"5209db7b34653379","type":"link in","z":"5db64edb8eadb607","name":"link in 260","links":["6c9a074a2dc15225","fcdf8f4a9545369b"],"x":55,"y":440,"wires":[["ca0a3f1d8b1d657a"]]},{"id":"6e4ff40731c860f9","type":"function","z":"5db64edb8eadb607","name":"average","func":"let count = 0;\nlet sum = 0;\n\nfor (let entity_id of msg.entities) {\n    sum += parseFloat(entity_id.state);\n    count++;\n}\n\nmsg.value = sum / count;\nmsg.meanValue = msg.value;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":440,"wires":[["82fdbad20da7c436"]]},{"id":"ca0a3f1d8b1d657a","type":"function","z":"5db64edb8eadb607","name":"ext_temp","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"ext_temp\";\n\nif (\"linkedClass\" in ha_configuration[msg.payload.entity_id] && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass) {\n        msg.linkedEntity = ha_configuration[msg.payload.entity_id].linkedEntity;\n        msg.linkedArea = ha_configuration[msg.payload.entity_id].linkedArea;\n        msg.linkedClass = linkedClass;\n\n        msg.filter = { \"in\": { linkedClass: msg.linkedClass, linkedArea: msg.linkedArea } };\n        msg.result = \"entities\";\n        delete msg.payload;\n        return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":440,"wires":[["3d95b8a982d17cca"]]},{"id":"0e4671741c814d23","type":"link in","z":"5db64edb8eadb607","name":"link in 261","links":["6c9a074a2dc15225","fcdf8f4a9545369b"],"x":55,"y":500,"wires":[["4f7ffd4f0b5e9900"]]},{"id":"e5ddc54bcc038d01","type":"function","z":"5db64edb8eadb607","name":"average","func":"let count = 0;\nlet sum = 0;\n\nfor (let entity_id of msg.entities) {\n    sum += parseFloat(entity_id.state);\n    count++;\n}\n\nmsg.value = sum / count;\nmsg.meanValue = msg.value;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":500,"wires":[["33663b5f7cf7864f"]]},{"id":"4f7ffd4f0b5e9900","type":"function","z":"5db64edb8eadb607","name":"int_temp","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"int_temp\";\n\nif (\"linkedClass\" in ha_configuration[msg.payload.entity_id] && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass) {\n        msg.linkedEntity = ha_configuration[msg.payload.entity_id].linkedEntity;\n        msg.linkedArea = ha_configuration[msg.payload.entity_id].linkedArea;\n        msg.linkedClass = linkedClass;\n\n        msg.filter = { \"in\": { linkedClass: msg.linkedClass, linkedArea: msg.linkedArea } };\n        msg.result = \"entities\";\n        delete msg.payload;\n        return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":500,"wires":[["7ceaa4036f36341d"]]},{"id":"82fdbad20da7c436","type":"smooth","z":"5db64edb8eadb607","name":"","property":"value","action":"mean","count":"5","round":"2","mult":"single","reduce":false,"x":555,"y":440,"wires":[["41241ac35e117c75","11fa152f7d7304d8"]],"l":false},{"id":"41241ac35e117c75","type":"api-call-service","z":"5db64edb8eadb607","name":"set temp","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{linkedEntity}}\",\"value\":\"{{value}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":605,"y":440,"wires":[[]],"l":false},{"id":"438d08ae753a57c4","type":"function","z":"5db64edb8eadb607","name":"set global","func":"var temperatures = global.get(\"temperatures\") || {};\n\nif (!(\"exterior\" in temperatures)) {\n    temperatures.exterior = {};\n}\n\ntemperatures.exterior.temperature = msg.value;\ntemperatures.exterior.tendency = 2 * Math.round((msg.value - msg.meanValue) * 1000) / 1000;\n\nglobal.set(\"temperatures\", temperatures);","outputs":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1180,"y":440,"wires":[]},{"id":"11fa152f7d7304d8","type":"smooth","z":"5db64edb8eadb607","name":"","property":"meanValue","action":"mean","count":"60","round":"4","mult":"single","reduce":false,"x":655,"y":440,"wires":[["438d08ae753a57c4"]],"l":false},{"id":"f3f5421d0c78493c","type":"comment","z":"5db64edb8eadb607","name":"linkedClass : ext_temp | int_temp ","info":"","x":170,"y":380,"wires":[]},{"id":"33663b5f7cf7864f","type":"smooth","z":"5db64edb8eadb607","name":"","property":"value","action":"mean","count":"5","round":"2","mult":"single","reduce":false,"x":555,"y":500,"wires":[["b784cd5c7571f51f","c296b4d64867bb37"]],"l":false},{"id":"b784cd5c7571f51f","type":"api-call-service","z":"5db64edb8eadb607","name":"set temp","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{linkedEntity}}\",\"value\":\"{{value}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":605,"y":500,"wires":[[]],"l":false},{"id":"50018f0bdc362e48","type":"function","z":"5db64edb8eadb607","name":"set global","func":"let tempMax = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_max\"].state);\nlet tempMin = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state);\nlet temperatures = global.get(\"temperatures\") || {};\n\nif (!(msg.linkedArea in temperatures)) {\n    temperatures[msg.linkedArea] = {};\n    temperatures[msg.linkedArea].equalTemp = false;\n    temperatures[msg.linkedArea].alert = \"\";\n}\n\ntemperatures[msg.linkedArea].temperature = msg.value;\ntemperatures[msg.linkedArea].tendency = 2 * Math.round((msg.value - msg.meanValue) * 1000) / 1000;\ntemperatures[msg.linkedArea].lowTemp = temperatures[msg.linkedArea][\"temperature\"] < tempMin;\ntemperatures[msg.linkedArea].highTemp = tempMax < temperatures[msg.linkedArea][\"temperature\"];\ntemperatures[msg.linkedArea].lastChange = new Date().getTime();\n\nglobal.set(\"temperatures\", temperatures);","outputs":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1180,"y":500,"wires":[]},{"id":"c296b4d64867bb37","type":"smooth","z":"5db64edb8eadb607","name":"","property":"meanValue","action":"mean","count":"60","round":"4","mult":"single","reduce":false,"x":655,"y":500,"wires":[["50018f0bdc362e48"]],"l":false},{"id":"7906a9e6c231aca2","type":"smooth","z":"5db64edb8eadb607","name":"","property":"value","action":"mean","count":"5","round":"2","mult":"single","reduce":false,"x":555,"y":620,"wires":[["c4249deb8b3f5bb5","7844924f2cda8504"]],"l":false},{"id":"486518dd476ab401","type":"smooth","z":"5db64edb8eadb607","name":"","property":"value","action":"mean","count":"5","round":"2","mult":"single","reduce":false,"x":555,"y":680,"wires":[["d531fb2a244f4fed","369224770a75fada"]],"l":false},{"id":"a92f90bf9d4cbc67","type":"function","z":"5db64edb8eadb607","name":"set global","func":"var humidities = global.get(\"humidities\") || {};\n\nif (!(\"exterior\" in humidities)) {\n    humidities.exterior = {};\n}\n\nhumidities.exterior.humidity = msg.value;\nhumidities.exterior.tendency = 2 * Math.round((msg.value - msg.meanValue) * 1000) / 1000;\n\nglobal.set(\"humidities\", humidities);","outputs":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1180,"y":620,"wires":[]},{"id":"e3dc34d07edd370a","type":"function","z":"5db64edb8eadb607","name":"set global","func":"let humidityMax = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_max\"].state);\nlet humidityMin = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.humidity_min\"].state);\nlet humidities = global.get(\"humidities\") || {};\n\nif (!(msg.linkedArea in humidities)) {\n    humidities[msg.linkedArea] = {};\n}\n\nhumidities[msg.linkedArea].humidity = msg.value;\nhumidities[msg.linkedArea].tendency = 2 * Math.round((msg.value - msg.meanValue) * 1000) / 1000;\nhumidities[msg.linkedArea].lowHumidity = humidities[msg.linkedArea][\"humidity\"] < humidityMin;\nhumidities[msg.linkedArea].highHumidity = humidityMax < humidities[msg.linkedArea][\"humidity\"];\nhumidities[msg.linkedArea].lastChange = new Date().getTime();\n\nglobal.set(\"humidities\", humidities);","outputs":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1180,"y":680,"wires":[]},{"id":"c4249deb8b3f5bb5","type":"api-call-service","z":"5db64edb8eadb607","name":"set humidity","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{linkedEntity}}\",\"value\":\"{{value}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":605,"y":620,"wires":[[]],"l":false},{"id":"d531fb2a244f4fed","type":"api-call-service","z":"5db64edb8eadb607","name":"set humidity","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{linkedEntity}}\",\"value\":\"{{value}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":605,"y":680,"wires":[[]],"l":false},{"id":"7844924f2cda8504","type":"smooth","z":"5db64edb8eadb607","name":"","property":"meanValue","action":"mean","count":"60","round":"4","mult":"single","reduce":false,"x":655,"y":620,"wires":[["a92f90bf9d4cbc67"]],"l":false},{"id":"369224770a75fada","type":"smooth","z":"5db64edb8eadb607","name":"","property":"meanValue","action":"mean","count":"60","round":"4","mult":"single","reduce":false,"x":655,"y":680,"wires":[["e3dc34d07edd370a"]],"l":false},{"id":"9274c7b1fbee1e2c","type":"link in","z":"5db64edb8eadb607","name":"link in 262","links":["6c9a074a2dc15225","fcdf8f4a9545369b"],"x":55,"y":620,"wires":[["6ac838a0cd6c8524"]]},{"id":"d53a2ea4574a815d","type":"function","z":"5db64edb8eadb607","name":"average","func":"let count = 0;\nlet sum = 0;\n\nfor (let entity_id of msg.entities) {\n    sum += parseFloat(entity_id.state);\n    count++;\n}\n\nmsg.value = sum / count;\nmsg.meanValue = msg.value;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":620,"wires":[["7906a9e6c231aca2"]]},{"id":"6ac838a0cd6c8524","type":"function","z":"5db64edb8eadb607","name":"ext_hum","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"ext_humidity\";\n\nif (\"linkedClass\" in ha_configuration[msg.payload.entity_id] && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass) {\n        msg.linkedEntity = ha_configuration[msg.payload.entity_id].linkedEntity;\n        msg.linkedArea = ha_configuration[msg.payload.entity_id].linkedArea;\n        msg.linkedClass = linkedClass;\n\n        msg.filter = { \"in\": { linkedClass: msg.linkedClass, linkedArea: msg.linkedArea } };\n        msg.result = \"entities\";\n        delete msg.payload;\n        return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":620,"wires":[["8c8c4084a0ead40b"]]},{"id":"b3ce9acdeb52eeb2","type":"link in","z":"5db64edb8eadb607","name":"link in 263","links":["6c9a074a2dc15225","fcdf8f4a9545369b"],"x":55,"y":680,"wires":[["58b248c8965d9eb4"]]},{"id":"bb10b6d1f7f3592d","type":"function","z":"5db64edb8eadb607","name":"average","func":"let count = 0;\nlet sum = 0;\n\nfor (let entity_id of msg.entities) {\n    sum += parseFloat(entity_id.state);\n    count++;\n}\n\nmsg.value = sum / count;\nmsg.meanValue = msg.value;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":680,"wires":[["486518dd476ab401"]]},{"id":"58b248c8965d9eb4","type":"function","z":"5db64edb8eadb607","name":"int_hum","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"int_humidity\";\n\nif (\"linkedClass\" in ha_configuration[msg.payload.entity_id] && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass) {\n        msg.linkedEntity = ha_configuration[msg.payload.entity_id].linkedEntity;\n        msg.linkedArea = ha_configuration[msg.payload.entity_id].linkedArea;\n        msg.linkedClass = linkedClass;\n\n        msg.filter = { \"in\": { linkedClass: msg.linkedClass, linkedArea: msg.linkedArea } };\n        msg.result = \"entities\";\n        delete msg.payload;\n        return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":680,"wires":[["a5092e5dfd747046"]]},{"id":"c3f8b65feec71764","type":"comment","z":"5db64edb8eadb607","name":"linkedClass : ext_humidity | int_humidity","info":"","x":190,"y":560,"wires":[]},{"id":"ad2f2718523d973b","type":"link in","z":"5db64edb8eadb607","name":"link in 264","links":["6c9a074a2dc15225","fcdf8f4a9545369b"],"x":55,"y":920,"wires":[["0587660a33b0ca97"]]},{"id":"0587660a33b0ca97","type":"function","z":"5db64edb8eadb607","name":"window","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"window\";\n\nif (\"linkedClass\" in ha_configuration[msg.payload.entity_id]\n        && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass\n        && msg.payload.event.old_state.state != msg.payload.event.new_state.state) {\n\n        msg = { ...msg, ...(msg.payload.entity_id in ha_configuration ? ha_configuration[msg.payload.entity_id] : {}) };\n        msg.entity_id = msg.payload.entity_id;\n\n        delete msg.payload;\n        return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":920,"wires":[["f9bc064b194c9654"]]},{"id":"f9bc064b194c9654","type":"link out","z":"5db64edb8eadb607","name":"detect windows","mode":"link","links":["3c7a2e7e55e2ba48","a9d131c4dbe11860"],"x":1225,"y":920,"wires":[]},{"id":"7e42aad6302f43e4","type":"function","z":"5db64edb8eadb607","name":"notification","func":"let tempMax = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_max\"].state);\nlet tempMin = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state);\nlet temperatures = global.get(\"temperatures\") || {};\n\nif (\"exterior\" in temperatures && msg.state == \"on\"){\n    if (temperatures[\"exterior\"].temperature < tempMin){\n        msg.notification_id = \"window_\" + msg.entity_id.split(\".\")[1];\n        msg.alertType = \"warning\";\n        msg.title = \"Température basse : La fenêtre \" + msg.friendlyName +\" est ouverte\";\n        msg.message = \"Température basse : La fenêtre \" + msg.friendlyName + \" est ouverte 🥶\";\n        msg.speak = msg.title;\n        msg.zone = [\"inside\",\"outside\"];\n        return msg;\n    } else if (temperatures[\"exterior\"].temperature > tempMax){\n        msg.notification_id = \"window_\" + msg.entity_id.split(\".\")[1];\n        msg.alertType = \"warning\";\n        msg.title = \"Température haute : La fenêtre \" + msg.friendlyName + \" est ouverte\";\n        msg.message = \"Température haute : La fenêtre \" + msg.friendlyName + \" est ouverte 🥵\";\n        msg.speak = msg.title;\n        msg.zone = [\"inside\", \"outside\"];\n        return msg;\n    }\n} else if (msg.state == \"off\"){\n    msg.notification_id = \"window_\" + msg.entity_id.split(\".\")[1];\n    msg.dismiss = true;\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":860,"wires":[["33c24c7c52435205"]]},{"id":"33c24c7c52435205","type":"link out","z":"5db64edb8eadb607","name":"link out 263","mode":"link","links":["4fcc3b49d98a2c1f"],"x":415,"y":860,"wires":[]},{"id":"611337a3568054cf","type":"comment","z":"5db64edb8eadb607","name":"linkedClass :  window","info":"","x":130,"y":860,"wires":[]},{"id":"0489992ff2313771","type":"link out","z":"5db64edb8eadb607","name":"detect motion on","mode":"link","links":["06656b50ad8cb96f","3c7a2e7e55e2ba48","c8961e8203b2cf99","417c65de22f57c58","13a390949bac6841","7abd739d866737c4","c0617f3319a72d37","a9d131c4dbe11860","fbc1c0ac1d7bec76","20da1d1d997c0428","2ac1c7da511dbdd8"],"x":1225,"y":1040,"wires":[]},{"id":"7bd6bfe3948fb9ed","type":"comment","z":"5db64edb8eadb607","name":"linkedClass : motion","info":"","x":130,"y":980,"wires":[]},{"id":"efb17b3e40b2e28c","type":"link in","z":"5db64edb8eadb607","name":"link in 267","links":["6c9a074a2dc15225","fcdf8f4a9545369b"],"x":55,"y":1040,"wires":[["5a95e325cc3f249b"]]},{"id":"5a95e325cc3f249b","type":"function","z":"5db64edb8eadb607","name":"motion","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"motion\";\n\nif (\"linkedClass\" in ha_configuration[msg.payload.entity_id]\n        && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass\n        && msg.payload.event.old_state.state != msg.payload.event.new_state.state) {\n\n        let inverse = { \"on\": \"off\", \"off\": \"on\" };\n        msg = { ...msg, ...(msg.payload.entity_id in ha_configuration ? ha_configuration[msg.payload.entity_id] : {}) };\n        msg.ha_state = msg.invertedMotion ? inverse[msg.payload.event.new_state.state] : msg.payload.event.new_state.state;\n        msg.entity_id = msg.payload.entity_id;\n\n        delete msg.payload;\n        return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":1040,"wires":[["3a4013f521bd4095"]]},{"id":"1ce7b3c97b338020","type":"function","z":"5db64edb8eadb607","name":"motion","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\n\nif (in_home_zone) {\n    if (msg.ha_state == \"on\") {\n        let ha_configuration = global.get(\"ha_configuration\") || {};\n        ha_configuration[msg.entity_id].state = \"on\";\n        global.set(\"ha_configuration\", ha_configuration);\n        msg.state = \"on\";\n\n        delete msg.addNoMotionDelay;\n        delete msg.invertedMotion;\n        delete msg.lastMotion;\n        delete msg.delay;\n        return [msg, null];\n    } else {\n        return [null, msg];\n    }\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":690,"y":1040,"wires":[["06726fd0729b958b","814342be9b1bd1e5"],["f17df02c88186b14"]]},{"id":"3a4013f521bd4095","type":"function","z":"5db64edb8eadb607","name":"global.motionArea exist","func":"let motionArea = global.get(\"motionArea\") || {};\n\nif (Object.keys(motionArea).length != 0) {\n    return [msg, null];\n} else {\n    msg.filter = { \"in\": { linkedClass: \"motion\" } };\n    msg.result = \"entities\";\n    return [null, msg];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":1040,"wires":[["312339bfc2025df4"],["ea12aea2bf4d781c"]]},{"id":"b1f18fa3ff6357ec","type":"function","z":"5db64edb8eadb607","name":"set global motionArea","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet inverse = { on: \"off\", off: \"on\" };\nlet entities = msg.entities;\nlet motionArea = {};\n\nfor (let entity of entities) {\n    let state = \"invertedMotion\" in entity && entity.invertedMotion ? inverse[entity.state] : entity.state;\n    if (!(entity.linkedArea in motionArea)) {\n        motionArea[entity.linkedArea] = state;\n    } else {\n        motionArea[entity.linkedArea] = motionArea[entity.linkedArea] == \"on\" ? \"on\" : state;\n    }\n    ha_configuration[entity.entity_id].state = state;\n}\n\nglobal.set(\"ha_configuration\", ha_configuration);\nglobal.set(\"motionArea\", motionArea);\n\ndelete msg.entities;\ndelete msg.filter;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":1160,"wires":[["d20ad6447c28a0eb"]]},{"id":"814342be9b1bd1e5","type":"link out","z":"5db64edb8eadb607","name":"link out 269","mode":"link","links":["50b4ac7eee4438c8"],"x":775,"y":1040,"wires":[]},{"id":"bc03125781b61f51","type":"delay","z":"5db64edb8eadb607","name":"delay","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":315,"y":1100,"wires":[["78e9f6afbcc99077"]],"l":false},{"id":"0dbe0577db154289","type":"function","z":"5db64edb8eadb607","name":"addNoMotionDelay","func":"msg.delay = \"addNoMotionDelay\" in msg && msg.addNoMotionDelay >= 0 ? msg.addNoMotionDelay * 1000 : 0;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":1100,"wires":[["bc03125781b61f51"]]},{"id":"cdb01b7de6732b05","type":"link in","z":"5db64edb8eadb607","name":"link in 268","links":["f17df02c88186b14"],"x":55,"y":1100,"wires":[["0dbe0577db154289"]]},{"id":"47d539270b563099","type":"function","z":"5db64edb8eadb607","name":"no motion","func":"let motionArea = global.get(\"motionArea\") || {};\n\nif (msg.ha_state == \"on\") {\n    let motionAreaKeys = Object.keys(motionArea);\n    motionArea[msg.linkedArea] = \"on\";\n    for (let key of motionAreaKeys) {\n        if (key != msg.linkedArea && motionArea[key] == \"last\") {\n            motionArea[key] = \"off\";\n            global.set(\"motionArea\", motionArea);\n            msg.state = \"off\";\n            msg.linkedArea = key;\n            return msg;\n        }\n    }\n}\n\nif (msg.ha_state == \"off\") {\n    let noMotionInAreas = true;\n    let motionAreaKeys = Object.keys(motionArea);\n    for (let key of motionAreaKeys) {\n        if (key != msg.linkedArea) {\n            noMotionInAreas = noMotionInAreas && motionArea[key] == \"off\";\n        }\n    }\n    let motionInArea = false;\n    let entities = msg.entities;\n    for (let entity of entities) {\n        motionInArea = motionInArea || entity.state == \"on\";\n    }\n    msg.state = motionInArea ? \"on\" : noMotionInAreas && \"lastMotion\" in msg && msg.lastMotion ? \"last\" : \"off\";\n    motionArea[msg.linkedArea] = msg.state;\n    global.set(\"motionArea\", motionArea);\n\n    if (msg.state != \"on\") {\n        delete msg.addNoMotionDelay;\n        delete msg.invertedMotion;\n        delete msg.lastMotion;\n        delete msg.entities;\n        delete msg.filter;\n        delete msg.delay;\n        return msg;\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":1100,"wires":[["35de429a78f68ace"]]},{"id":"f17df02c88186b14","type":"link out","z":"5db64edb8eadb607","name":"link out 270","mode":"link","links":["cdb01b7de6732b05"],"x":775,"y":1040,"wires":[]},{"id":"50b4ac7eee4438c8","type":"link in","z":"5db64edb8eadb607","name":"link in 270","links":["814342be9b1bd1e5"],"x":535,"y":1100,"wires":[["47d539270b563099"]]},{"id":"a287019eb9938f44","type":"server-state-changed","z":"5db64edb8eadb607","name":"in_middle_zone","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_middle_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":620,"y":1160,"wires":[[],["6685df5bdeb82249"]]},{"id":"6685df5bdeb82249","type":"function","z":"5db64edb8eadb607","name":"set motionAreas to off","func":"let motionArea = global.get(\"motionArea\") || {};\nlet msgs = [];\n\nlet motionAreaKeys = Object.keys(motionArea);\nfor (let key of motionAreaKeys) {\n    if (motionArea[key] != \"off\") {\n        msgs.push({ linkedArea: key, state: \"off\" });\n        motionArea[key] = \"off\";\n\n    }\n}\n\nglobal.set(\"motionArea\", motionArea);\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":1160,"wires":[["1849c3d6ff1ccfb0"]]},{"id":"1849c3d6ff1ccfb0","type":"link out","z":"5db64edb8eadb607","name":"detect motion all off","mode":"link","links":["c8961e8203b2cf99","13a390949bac6841","20da1d1d997c0428","fbc1c0ac1d7bec76"],"x":1225,"y":1160,"wires":[]},{"id":"dab0254d90ea14b5","type":"comment","z":"5db64edb8eadb607","name":"linkedClass : cube","info":"","x":130,"y":1340,"wires":[]},{"id":"5481c10dccf47e49","type":"server-events","z":"5db64edb8eadb607","name":"detect cubes","server":"66876666.3e6288","version":2,"eventType":"xiaomi_aqara.cube_action","exposeToHomeAssistant":false,"eventData":"","haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"}],"x":110,"y":1400,"wires":[["8b8418977eb2ef56"]]},{"id":"8b8418977eb2ef56","type":"function","z":"5db64edb8eadb607","name":"set msg","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet ha_configuration = global.get(\"ha_configuration\") || {};\n\nif (msg.payload.entity_id in ha_configuration && in_home_zone) {\n        msg = { ...msg, ...(msg.payload.entity_id in ha_configuration ? ha_configuration[msg.payload.entity_id] : {}) };\n        msg.entity_id = msg.payload.entity_id;\n        msg.action_type = msg.payload.event.action_type;\n        msg.action_value = \"action_value\" in msg.payload.event ? msg.payload.event.action_value : 0;\n\n        delete msg.payload;\n        return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":1400,"wires":[["e3060120d8d0874b"]]},{"id":"aa868fbff20bbef5","type":"link out","z":"5db64edb8eadb607","name":"cube","mode":"link","links":["bab2c7afb8981886","17df8120f9c53aca"],"x":1225,"y":1400,"wires":[]},{"id":"4feda8d00f5ac1a9","type":"function","z":"5db64edb8eadb607","name":"set cubes","func":"let lightColorOptions = [0, 36, 72, 108, 144, 180, 216, 252, 288, 324];\nlet lightPowerOptions = [1, 2, 6, 25, 100];\nlet cubes = global.get(\"cubes\") || {};\nlet msgs = [];\n\nif (!(msg.entity_id in cubes)) {\n    cubes[msg.entity_id] = {};\n    cubes[msg.entity_id].move = true;\n    cubes[msg.entity_id].flip90 = false;\n    cubes[msg.entity_id].flip180 = false;\n    cubes[msg.entity_id].shake_air = false;\n    cubes[msg.entity_id].free_fall = false;\n    cubes[msg.entity_id].lightPower = 3;\n    cubes[msg.entity_id].lightColor = 0;\n    msg.action_type = \"flip90\";\n}\n\nswitch (msg.action_type) {\n    case \"flip180\":\n        let ha_configuration = global.get(\"ha_configuration\") || {};\n        msgs.push({\n            type: \"ambiance\",\n            entity_id: msg.linkedSelectAmbiance,\n            action_type: \"select_option\",\n            payload: { data: { option: randomAmbiance(ha_configuration[\"ambiance_config\"].ambiances_type) } }\n        });\n        return saveAndReturn();\n    case \"flip90\":\n        if (!cubes[msg.entity_id].flip180) {\n            cubes[msg.entity_id].flip90 = true;\n            cubes[msg.entity_id].free_fall = false;\n            msg.lightPower = lightPowerOptions[cubes[msg.entity_id].lightPower];\n            if (cubes[msg.entity_id].flip90) {\n                if (cubes[msg.entity_id].move) {\n                    msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n                } else {\n                    msg.colorTemp = 300;\n                }\n            }\n            msg.cube = cubes[msg.entity_id];\n            msg.sound = \"light_auto_off.mp3\";\n            msgs.push({ ...msg, type: \"cube\" });\n        } else if (cubes[msg.entity_id].flip180) {\n            cubes[msg.entity_id].flip180 = false;\n            cubes[msg.entity_id].free_fall = false;\n            msgs.push({ type: \"ambiance\", entity_id: msg.linkedSelectAmbiance, action_type: \"select_first\" });\n        }\n        return saveAndReturn();\n    case \"tap_twice\":\n        if (cubes[msg.entity_id].flip90) {\n            msg.sound = \"light_auto_on.mp3\";\n            cubes[msg.entity_id].flip90 = false;\n            cubes[msg.entity_id].free_fall = false;\n            msg.cube = cubes[msg.entity_id];\n            msgs.push({ ...msg, type: \"cube\" });\n        } else if (cubes[msg.entity_id].flip180) {\n            cubes[msg.entity_id].flip180 = false;\n            cubes[msg.entity_id].free_fall = false;\n            msgs.push({ type: \"ambiance\", entity_id: msg.linkedSelectAmbiance, action_type: \"select_first\" });\n        }\n        return saveAndReturn();\n    case \"shake_air\":\n        if (cubes[msg.entity_id].flip90) {\n            cubes[msg.entity_id].shake_air = !cubes[msg.entity_id].shake_air;\n            cubes[msg.entity_id].free_fall = false;\n            msg.cube = cubes[msg.entity_id];\n            msgs.push({ ...msg, type: \"cube\" });\n            return saveAndReturn();\n        }\n    case \"rotate\":\n        if (cubes[msg.entity_id].flip90) {\n            lights(rotate());\n            cubes[msg.entity_id].free_fall = false;\n            msg.cube = cubes[msg.entity_id];\n            msgs.push({ ...msg, type: \"cube\" });\n        } else if (cubes[msg.entity_id].flip180) {\n            let action_type = msg.action_value < 0 ? \"select_previous\" : \"select_next\";\n            msgs.push({ type: \"ambiance\", entity_id: msg.linkedSelectAmbiance, action_type: action_type });\n        }\n        return saveAndReturn();\n    case \"free_fall\":\n        if (cubes[msg.entity_id].flip90) {\n            cubes[msg.entity_id].free_fall = !cubes[msg.entity_id].free_fall;\n            if (cubes[msg.entity_id].move) {\n                msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n            } else {\n                msg.colorTemp = 300;\n            }\n            msg.cube = cubes[msg.entity_id];\n            msgs.push({ ...msg, type: \"cube\" });\n            return saveAndReturn();\n        }\n    case \"move\":\n        if (cubes[msg.entity_id].flip90) {\n            cubes[msg.entity_id].move = !cubes[msg.entity_id].move;\n            cubes[msg.entity_id].free_fall = false;\n            if (cubes[msg.entity_id].move) {\n                msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n            } else {\n                msg.colorTemp = 300;\n            }\n            msg.cube = cubes[msg.entity_id];\n            msgs.push({ ...msg, type: \"cube\" });\n            return saveAndReturn();\n        }\n    case \"alert\":\n}\n\nfunction rotate() {\n    return msg.action_value == 0 ? \"\" : msg.action_value > 0 ? msg.action_value < 25 ? 'rotate_pos' : 'rotate_pos_hard' : msg.action_value > -25 ? 'rotate_neg' : 'rotate_neg_hard';\n}\n\nfunction lights(rotate) {\n    switch (rotate) {\n        case \"rotate_pos\":\n            cubes[msg.entity_id].lightPower = cubes[msg.entity_id].lightPower + 1 > 4 ? 0 : cubes[msg.entity_id].lightPower + 1;\n            msg.lightPower = lightPowerOptions[cubes[msg.entity_id].lightPower];\n            msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n            msg.colorTemp = 300;\n            break;\n        case \"rotate_neg\":\n            cubes[msg.entity_id].lightPower = cubes[msg.entity_id].lightPower - 1 < 0 ? 4 : cubes[msg.entity_id].lightPower - 1;\n            msg.lightPower = lightPowerOptions[cubes[msg.entity_id].lightPower];\n            msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n            msg.colorTemp = 300;\n            break;\n        case \"rotate_pos_hard\":\n            cubes[msg.entity_id].move = true;\n            msg.lightPower = lightPowerOptions[cubes[msg.entity_id].lightPower];\n            cubes[msg.entity_id].lightColor = cubes[msg.entity_id].lightColor + 1 > 9 ? 0 : cubes[msg.entity_id].lightColor + 1;\n            msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n            msg.colorTemp = 300;\n            break;\n        case \"rotate_neg_hard\":\n            cubes[msg.entity_id].move = true;\n            msg.lightPower = lightPowerOptions[cubes[msg.entity_id].lightPower];\n            cubes[msg.entity_id].lightColor = cubes[msg.entity_id].lightColor - 1 < 0 ? 9 : cubes[msg.entity_id].lightColor - 1;\n            msg.lightColor = lightColorOptions[cubes[msg.entity_id].lightColor];\n            msg.colorTemp = 300;\n            break;\n        default:\n    }\n}\n\nfunction randomAmbiance(ambiances_type) {\n    let ambiancesTypeKeys = Object.keys(ambiances_type);\n    let ambiancesType = [];\n    for (let key of ambiancesTypeKeys) {\n        ambiancesType.push(ambiances_type[key].name);\n    }\n    return ambiancesType[1 + Math.floor(Math.random() * 7)];\n}\n\nfunction saveAndReturn() {\n    global.set(\"cubes\", cubes);\n    return [msgs];\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":580,"y":1400,"wires":[["9e05ac1ada523d13"]]},{"id":"e3060120d8d0874b","type":"trigger","z":"5db64edb8eadb607","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"250","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":420,"y":1400,"wires":[["4feda8d00f5ac1a9"]]},{"id":"e842a22d5d294c9e","type":"comment","z":"5db64edb8eadb607","name":"linkedClass : ambiance","info":"","x":140,"y":1460,"wires":[]},{"id":"a11e52f70b3f44ee","type":"link out","z":"5db64edb8eadb607","name":"ambiance","mode":"link","links":["57970c88e211ce04"],"x":1225,"y":1520,"wires":[]},{"id":"3d95b8a982d17cca","type":"subflow:ea5b93cde6b1bf0a","z":"5db64edb8eadb607","name":"","x":310,"y":440,"wires":[["6e4ff40731c860f9"]]},{"id":"7ceaa4036f36341d","type":"subflow:ea5b93cde6b1bf0a","z":"5db64edb8eadb607","name":"","x":310,"y":500,"wires":[["e5ddc54bcc038d01"]]},{"id":"8c8c4084a0ead40b","type":"subflow:ea5b93cde6b1bf0a","z":"5db64edb8eadb607","name":"","x":310,"y":620,"wires":[["d53a2ea4574a815d"]]},{"id":"a5092e5dfd747046","type":"subflow:ea5b93cde6b1bf0a","z":"5db64edb8eadb607","name":"","x":310,"y":680,"wires":[["bb10b6d1f7f3592d"]]},{"id":"955a69cfe9348ae5","type":"subflow:ea5b93cde6b1bf0a","z":"5db64edb8eadb607","name":"","x":170,"y":1160,"wires":[["b1f18fa3ff6357ec"]]},{"id":"9e05ac1ada523d13","type":"switch","z":"5db64edb8eadb607","name":"type","property":"type","propertyType":"msg","rules":[{"t":"eq","v":"cube","vt":"str"},{"t":"eq","v":"ambiance","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":710,"y":1400,"wires":[["e267428f63b3b2aa"],["fef71a9429a03c19"]]},{"id":"78e9f6afbcc99077","type":"function","z":"5db64edb8eadb607","name":"get entities","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet inverse = { \"on\": \"off\", \"off\": \"on\" };\nmsg.entities = [];\n\nfor (let entity_id of Object.keys(ha_configuration)) {\n    if (ha_configuration[entity_id].linkedClass == msg.linkedClass && ha_configuration[entity_id].linkedArea == msg.linkedArea) {\n        if (msg.entity_id == entity_id) {\n            let state = global.get(\"homeassistant\").homeAssistant.states[entity_id].state;\n            state = msg.invertedMotion ? inverse[state] : state;\n            if (state == \"off\") {\n                ha_configuration[entity_id].state = \"off\";\n                global.set(\"ha_configuration\", ha_configuration);\n            }\n        }\n        msg.entities.push(ha_configuration[entity_id]);\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":1100,"wires":[["47d539270b563099"]]},{"id":"96682dac2756797e","type":"function","z":"5db64edb8eadb607","name":"amb_sel","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"ambiance_select\";\n\nif (in_home_zone && msg.payload.event.old_state.state != msg.payload.event.new_state.state && \"linkedAmbiance\" in ha_configuration[msg.payload.entity_id] && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass) {\n        msg = { ...msg, ...(msg.payload.entity_id in ha_configuration ? ha_configuration[msg.payload.entity_id] : {}) };\n        msg.action_type = msg.payload.event.new_state.state;\n\n        delete msg.payload;\n        return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":1520,"wires":[["f46685e79b8fecb6"]]},{"id":"f2abe23402efadfd","type":"api-call-service","z":"5db64edb8eadb607","name":"set ambiance options","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_select","service":"set_options","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"options\":\"{{options}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":660,"y":240,"wires":[[]]},{"id":"77a85057e34ff490","type":"subflow:ea5b93cde6b1bf0a","z":"5db64edb8eadb607","name":"","x":290,"y":240,"wires":[["48bffb9a97588b9d"]]},{"id":"ee820d2b413b2016","type":"function","z":"5db64edb8eadb607","name":"filter","func":"msg.filter = { \"in\": { linkedClass: \"ambiance\" } };\nmsg.result = \"ambiances\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":240,"wires":[["77a85057e34ff490"]]},{"id":"48bffb9a97588b9d","type":"function","z":"5db64edb8eadb607","name":"prepare options","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\n\nif (\"ambiance_config\" in ha_configuration) {\n    let ambiance_config = ha_configuration.ambiance_config;\n    let ambiances = msg.ambiances;\n    let options = [];\n    let msgs = [];\n\n    let ambiancesTypeKeys = Object.keys(ambiance_config.ambiances_type);\n    for (let key of ambiancesTypeKeys) {\n        options.push(ambiance_config.ambiances_type[key].name);\n    }\n\n    for (let ambiance of ambiances) {\n        msgs.push({ payload: { data: { entity_id: ambiance.linkedSelect, options: options } } });\n    }\n    return [msgs];\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":240,"wires":[["f2abe23402efadfd"]]},{"id":"ba01e397c4ca1e22","type":"link in","z":"5db64edb8eadb607","name":"link in 345","links":["12e321042a486aa5","8a7374ae240edc55","69921aad961be528"],"x":55,"y":240,"wires":[["ee820d2b413b2016"]]},{"id":"fef71a9429a03c19","type":"api-call-service","z":"5db64edb8eadb607","name":"select ambiance","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_select","service":"{{action_type}}","areaId":[],"deviceId":[],"entityId":["{{entity_id}}"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":860,"y":1400,"wires":[[]]},{"id":"f46685e79b8fecb6","type":"function","z":"5db64edb8eadb607","name":"set ambiance","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet ambiances_type = ha_configuration.ambiance_config.ambiances_type;\nlet ambiances = global.get(\"ambiances\") || {};\nlet action_type = msg.action_type;\n\nif (!(msg.linkedAmbiance in ambiances)) {\n        ambiances[msg.linkedAmbiance] = {};\n        ambiances[msg.linkedAmbiance].current = \"stop\";\n}\n\nlet new_action_type = msg.action_type == \"stop\" ? \"stop\" : selectAmbiance(msg.action_type);\nif (ambiances[msg.linkedAmbiance].current != new_action_type) {\n        msg = { ...msg, ...ha_configuration[msg.linkedAmbiance] };\n        msg.ambiance_config = ha_configuration[\"ambiance_config\"];\n        msg.restore = new_action_type == \"stop\";\n        msg.action_type = new_action_type;\n        ambiances[msg.linkedAmbiance].current = new_action_type;\n        global.set(\"ambiances\", ambiances);\n        return msg;\n}\n\nfunction selectAmbiance(action_type) {\n        let ambiancesTypeKeys = Object.keys(ambiances_type);\n        let ambiancesType = [];\n        for (let key of ambiancesTypeKeys) {\n                if (ambiances_type[key].name == action_type) {\n                        return key;\n                }\n                ambiancesType.push(key);\n        }\n        if (action_type == \"random\") {\n                return ambiancesType[1 + Math.floor(Math.random() * 7)];\n        }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":1520,"wires":[["a11e52f70b3f44ee","2a7e34a51aa4787e"]]},{"id":"654f65aa1d1d3a0b","type":"link in","z":"5db64edb8eadb607","name":"link in 346","links":["6c9a074a2dc15225","fcdf8f4a9545369b"],"x":55,"y":1520,"wires":[["96682dac2756797e"]]},{"id":"e7a8d7f4cd35fbcc","type":"switch","z":"5db64edb8eadb607","name":"key exist","property":"ha_configuration","propertyType":"global","rules":[{"t":"hask","v":"payload.entity_id","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":340,"y":300,"wires":[["6c9a074a2dc15225"]]},{"id":"ab09dc8260c48f59","type":"link in","z":"5db64edb8eadb607","name":"link in 347","links":["6c9a074a2dc15225","fcdf8f4a9545369b"],"x":55,"y":1640,"wires":[["c4479a362a52818a"]]},{"id":"3871a3c14e9fab3d","type":"comment","z":"5db64edb8eadb607","name":"linkedClass : phone","info":"","x":130,"y":1580,"wires":[]},{"id":"c4479a362a52818a","type":"function","z":"5db64edb8eadb607","name":"phone_alarm","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"phone_alarm\";\n\nif (\"linkedClass\" in ha_configuration[msg.payload.entity_id] && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass) {\n        msg = { ...msg, ...(msg.payload.entity_id in ha_configuration ? ha_configuration[msg.payload.entity_id] : {}) };\n        msg.alarm = msg.payload.event.new_state;\n        if (msg.linkedPerson in ha_configuration && \"attributes\" in msg.alarm && \"Package\" in msg.alarm.attributes && msg.alarm.attributes.Package == msg.package) {\n                msg.person = ha_configuration[msg.linkedPerson];\n                delete msg.payload;\n                return msg;\n        }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":1640,"wires":[["b4f8664a51ee033b"]]},{"id":"b4f8664a51ee033b","type":"function","z":"5db64edb8eadb607","name":"set alarm","func":"if (msg.alarm.state == \"unavailable\") {\n    let date = new Date();\n    let timeZoneOffset = -date.getTimezoneOffset() / 60;\n    msg.localTime = cleanDate(new Date(date.setHours(date.getHours() + timeZoneOffset - 24)));\n    return msg;\n} else {\n    let localTime = msg.alarm.attributes[\"Local Time\"].split(\"+\");\n    msg.localTime = cleanDate(new Date(localTime[0] + \"+00:00 \" + localTime[1].split(\" \")[1]));\n    return msg;\n}\n\nfunction cleanDate(dateString) {\n    dateString = dateString.toISOString().replace(\"T\", \" \").split(\".\")[0];\n    return dateString.substring(0, dateString.lastIndexOf(\":\"));\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":1640,"wires":[["65f9e934a594c3e4"]]},{"id":"65f9e934a594c3e4","type":"trigger","z":"5db64edb8eadb607","name":"","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"hr","reset":"","bytopic":"topic","topic":"topic","outputs":1,"x":470,"y":1640,"wires":[["2fe6890217e27ac6"]]},{"id":"149c3f151508c43e","type":"inject","z":"5db64edb8eadb607","name":"1 min","props":[{"p":"time","v":"true","vt":"bool"}],"repeat":"","crontab":"*/1 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":650,"y":40,"wires":[["d3c516a5226a53b8","05622adb2099a7cb"]]},{"id":"08a2e534e6dd4397","type":"link out","z":"5db64edb8eadb607","name":"detect date","mode":"link","links":["0b9796d6577bb527","fdaf52796d22e4f8"],"x":875,"y":40,"wires":[]},{"id":"2a7e34a51aa4787e","type":"function","z":"5db64edb8eadb607","name":"msg","func":"msg.filter = { \"in\": { linkedClass: \"cube\", linkedAmbiance: msg.linkedAmbiance } };\nmsg.result = \"cubes\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":1520,"wires":[["de033b1ba4589786"]]},{"id":"de033b1ba4589786","type":"subflow:ea5b93cde6b1bf0a","z":"5db64edb8eadb607","name":"","x":590,"y":1520,"wires":[["ef346da54370f789"]]},{"id":"ef346da54370f789","type":"function","z":"5db64edb8eadb607","name":"set cube","func":"let globalCubes = global.get(\"cubes\") || {};\nlet cubes = msg.cubes;\n\nif (cubes.length != 0) {\n    for (let cube of cubes) {\n        if (!(cube.entity_id in cubes)) {\n            globalCubes[cube.entity_id] = {};\n            globalCubes[cube.entity_id].move = true;\n            globalCubes[cube.entity_id].flip90 = false;\n            globalCubes[cube.entity_id].flip180 = false;\n            globalCubes[cube.entity_id].shake_air = false;\n            globalCubes[cube.entity_id].free_fall = false;\n            globalCubes[cube.entity_id].lightPower = 3;\n            globalCubes[cube.entity_id].lightColor = 0;\n        }\n        globalCubes[cube.entity_id].flip180 = msg.action_type != \"stop\";\n        globalCubes[cube.entity_id].flip90 = false;\n        globalCubes[cube.entity_id].free_fall = false;\n    }\n    global.set(\"cubes\", globalCubes);\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":740,"y":1520,"wires":[[]]},{"id":"7a5411f93f6c3f3f","type":"link in","z":"5db64edb8eadb607","name":"link in 365","links":["6c9a074a2dc15225","fcdf8f4a9545369b"],"x":55,"y":1700,"wires":[["04b8580112fd762d"]]},{"id":"04b8580112fd762d","type":"function","z":"5db64edb8eadb607","name":"phone_position","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"phone_position\";\n\nif (\"linkedClass\" in ha_configuration[msg.payload.entity_id] && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass) {\n        msg = { ...msg, ...(msg.payload.entity_id in ha_configuration ? ha_configuration[msg.payload.entity_id] : {}) };\n        msg.position = msg.payload.event.new_state;\n        if (msg.linkedPerson in ha_configuration){\n                msg.person = ha_configuration[msg.linkedPerson];\n                delete msg.payload;\n                return msg;\n        }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":1700,"wires":[["0f67e5c1f5f2c15e"]]},{"id":"0f67e5c1f5f2c15e","type":"function","z":"5db64edb8eadb607","name":"set distance","func":"if (msg.position.state == \"home\") {\n    msg.payload = 0;\n    return msg;\n} else {\n    let zoneHomePosition = global.get(\"homeassistant\").homeAssistant.states[\"zone.home\"].attributes;\n    let lat1 = zoneHomePosition.latitude;\n    let lon1 = zoneHomePosition.longitude;\n    let lat2 = msg.position.attributes.latitude;\n    let lon2 = msg.position.attributes.longitude;\n\n    msg.payload = calculateDistance(lat1, lon1, lat2, lon2);\n    return msg;\n\n    function calculateDistance(lat1, lon1, lat2, lon2) {\n        // Earth's radius, in meters\n        var R = 6371e3;\n\n        // convert latitude and longitude from degrees to radians\n        lat1 = lat1 * (Math.PI / 180);\n        lon1 = lon1 * (Math.PI / 180);\n        lat2 = lat2 * (Math.PI / 180);\n        lon2 = lon2 * (Math.PI / 180);\n\n        // calculate the differences between the coordinates\n        var dlat = lat2 - lat1;\n        var dlon = lon2 - lon1;\n\n        // calculate the distance using the Haversine formula\n        var a = Math.pow(Math.sin(dlat / 2), 2) + Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin(dlon / 2), 2);\n        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n        var d = R * c;\n\n        // return the distance in meters\n        return Math.round(d);\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":1700,"wires":[["77d0854e26682334"]]},{"id":"77d0854e26682334","type":"function","z":"5db64edb8eadb607","name":"set phone_position","func":"let persons = global.get(\"persons\") || {};\n\nif (!(msg.linkedPerson in persons)) {\n    persons[msg.linkedPerson] = {};\n    persons[msg.linkedPerson].homeDistance = 0;\n    persons[msg.linkedPerson].name = msg.person.name;\n}\n\nif (persons[msg.linkedPerson].homeDistance != msg.payload) {\n    persons[msg.linkedPerson].homeDistance = msg.payload;\n    global.set(\"persons\", persons);\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":1700,"wires":[["22bace3b59def9cc"]]},{"id":"22bace3b59def9cc","type":"link out","z":"5db64edb8eadb607","name":"detect persons position","mode":"link","links":["837f5e57291454a2"],"x":1225,"y":1700,"wires":[]},{"id":"2fe6890217e27ac6","type":"link out","z":"5db64edb8eadb607","name":"link out 351","mode":"link","links":["4e516a193edce284"],"x":1225,"y":1640,"wires":[]},{"id":"5631d9e6239ab51f","type":"change","z":"5db64edb8eadb607","name":"","rules":[{"t":"delete","p":"ha_state","pt":"msg"},{"t":"delete","p":"alias","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":825,"y":1040,"wires":[["0489992ff2313771"]],"l":false},{"id":"2588ed3a4ef13b66","type":"subflow:723d4991c3c87385","z":"5db64edb8eadb607","name":"","x":310,"y":1280,"wires":[]},{"id":"986cf1cf1b476eab","type":"comment","z":"5db64edb8eadb607","name":"linkedClass : light","info":"","x":120,"y":1220,"wires":[]},{"id":"3731f5663a3d6080","type":"link in","z":"5db64edb8eadb607","name":"link in 383","links":["6c9a074a2dc15225","fcdf8f4a9545369b"],"x":55,"y":1280,"wires":[["7c883f5930f4aa4a"]]},{"id":"7c883f5930f4aa4a","type":"function","z":"5db64edb8eadb607","name":"light","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"light\";\n\nif (msg.payload.event.old_state.state != msg.payload.event.new_state.state && \"linkedClass\" in ha_configuration[msg.payload.entity_id] && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass) {\n        if (!in_home_zone) {\n                msg.entity_id = msg.payload.entity_id;\n                msg.state = \"off\";\n\n                delete msg.payload;\n                return msg;\n        }\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":1280,"wires":[["2588ed3a4ef13b66"]]},{"id":"471faf5b6eb7d65d","type":"function","z":"5db64edb8eadb607","name":"set illuminance","func":"let lightTimeStatus = global.get('homeassistant').homeAssistant.states[\"input_boolean.light_time_status\"].state == \"on\";\nlet cloudyLight = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.cloudy_light\"].state);\n\nlet illuminances = global.get(\"illuminances\") || {};\nilluminances[msg.linkedArea] = msg.value;\nglobal.set(\"illuminances\", illuminances);\n\nif (!lightTimeStatus && msg.value > cloudyLight) {\n    msg.entity_id = \"input_number.illuminance_light\";\n    msg.state = msg.value;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":1940,"wires":[["65edb6875e6621bb","305181e3928ba486"]]},{"id":"65edb6875e6621bb","type":"link out","z":"5db64edb8eadb607","name":"detect illuminance","mode":"link","links":["42bcf58ce90dbbb4"],"x":1225,"y":1940,"wires":[]},{"id":"f7885ad3b4d0e18c","type":"comment","z":"5db64edb8eadb607","name":"linkedClass : illuminance","info":"","x":150,"y":1880,"wires":[]},{"id":"c07188f127519436","type":"link in","z":"5db64edb8eadb607","name":"link in 392","links":["6c9a074a2dc15225"],"x":55,"y":1940,"wires":[["ea26b896fd5ce874"]]},{"id":"ea26b896fd5ce874","type":"function","z":"5db64edb8eadb607","name":"illuminance","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"illuminance\";\n\nif (msg.payload.event.old_state.state != msg.payload.event.new_state.state && \"linkedClass\" in ha_configuration[msg.payload.entity_id] && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass) {\n        msg = { ...msg, ...(msg.payload.entity_id in ha_configuration ? ha_configuration[msg.payload.entity_id] : {}) };\n\n        delete msg.payload;\n        return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":1940,"wires":[["5793bf6d22940aa4"]]},{"id":"5793bf6d22940aa4","type":"function","z":"5db64edb8eadb607","name":"msg","func":"msg.filter = { \"in\": { linkedClass: msg.linkedClass, linkedArea: msg.linkedArea } };\nmsg.result = \"entities\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":1940,"wires":[["594491f95d2ab68c"]]},{"id":"594491f95d2ab68c","type":"subflow:ea5b93cde6b1bf0a","z":"5db64edb8eadb607","name":"","x":450,"y":1940,"wires":[["daf94aca204fa5a0"]]},{"id":"daf94aca204fa5a0","type":"function","z":"5db64edb8eadb607","name":"average","func":"let count = 0;\nlet sum = 0;\n\nfor (let entity_id of msg.entities) {\n    sum += parseFloat(entity_id.state);\n    count++;\n}\n\nmsg.value = sum / count;\nmsg.meanValue = msg.value;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":1940,"wires":[["1aedf1a77f49f760"]]},{"id":"1aedf1a77f49f760","type":"smooth","z":"5db64edb8eadb607","name":"","property":"value","action":"mean","count":"5","round":"2","mult":"single","reduce":false,"x":695,"y":1940,"wires":[["471faf5b6eb7d65d"]],"l":false},{"id":"59d934b417cbdec8","type":"function","z":"5db64edb8eadb607","name":"security_entrance","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\nlet invitation = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.invitation\"].state == \"on\";\nlet ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"security_entrance\";\n\nif (\n        !in_home_zone && !invitation &&\n        \"security_entrance\" in ha_configuration &&\n        ha_configuration.security_entrance.linkedClass == linkedClass &&\n        (ha_configuration.security_entrance.linkedDoors.includes(msg.payload.entity_id) || ha_configuration.security_entrance.linkedWindows.includes(msg.payload.entity_id)) &&\n        msg.payload.event.new_state.state == \"on\") {\n        msg = { ...msg.payload.event.new_state, ...ha_configuration.security_entrance };\n\n        delete msg.payload;\n        return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":2060,"wires":[["d719c2de89994314"]]},{"id":"d512c613f3875d4b","type":"link in","z":"5db64edb8eadb607","name":"link in 404","links":["6c9a074a2dc15225"],"x":55,"y":2060,"wires":[["59d934b417cbdec8"]]},{"id":"f03c866c7366cfa0","type":"comment","z":"5db64edb8eadb607","name":"device_class: security_entrance","info":"","x":170,"y":2000,"wires":[]},{"id":"d719c2de89994314","type":"link out","z":"5db64edb8eadb607","name":"security_entrance","mode":"link","links":["514ddcb3e84c5765"],"x":1225,"y":2060,"wires":[]},{"id":"f298332e4c67a310","type":"link in","z":"5db64edb8eadb607","name":"link in 405","links":["6c9a074a2dc15225"],"x":55,"y":1760,"wires":[["908fcffa19081289"]]},{"id":"908fcffa19081289","type":"function","z":"5db64edb8eadb607","name":"phone_bluetooth","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"phone_bluetooth\";\n\nif (\"linkedClass\" in ha_configuration[msg.payload.entity_id] && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass) {\n        msg = { ...msg, ...(msg.payload.entity_id in ha_configuration ? ha_configuration[msg.payload.entity_id] : {}) };\n        msg.bluetooth = msg.payload.event.new_state;\n        if (msg.linkedPerson in ha_configuration) {\n                msg.person = ha_configuration[msg.linkedPerson];\n                delete msg.payload;\n                return msg;\n        }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":1760,"wires":[["c622552acbb4dac3"]]},{"id":"c622552acbb4dac3","type":"function","z":"5db64edb8eadb607","name":"set phone_bluetooth","func":"let pairedDevices = msg.bluetooth.attributes.connected_paired_devices;\nlet persons = global.get(\"persons\") || {};\nlet bluetooth = {};\n\nif (!(msg.linkedPerson in persons)) {\n    persons[msg.linkedPerson] = {};\n    persons[msg.linkedPerson].homeDistance = -1;\n    persons[msg.linkedPerson].name = msg.person.name;\n    persons[msg.linkedPerson].bluetooth = {};\n}\n\nfor (let pairedDevice of pairedDevices) {\n    let splitDevice = pairedDevice.split(\" (\");\n    bluetooth[splitDevice[0]] = splitDevice[1].replaceAll(\")\", \"\");\n}\n\npersons[msg.linkedPerson].bluetooth = bluetooth;\nglobal.set(\"persons\", persons);\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":1760,"wires":[["626db2a2ab0f40e6"]]},{"id":"626db2a2ab0f40e6","type":"link out","z":"5db64edb8eadb607","name":"detect persons bluetooth","mode":"link","links":[],"x":1225,"y":1760,"wires":[]},{"id":"b99794334aba637b","type":"link in","z":"5db64edb8eadb607","name":"link in 406","links":["6c9a074a2dc15225"],"x":55,"y":1820,"wires":[["2403f909f3808edf"]]},{"id":"2403f909f3808edf","type":"function","z":"5db64edb8eadb607","name":"phone_wifi","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"phone_wifi\";\n\nif (\"linkedClass\" in ha_configuration[msg.payload.entity_id] && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass) {\n        msg = { ...msg, ...(msg.payload.entity_id in ha_configuration ? ha_configuration[msg.payload.entity_id] : {}) };\n        msg.state = msg.payload.event.new_state.state;\n        if (msg.linkedPerson in ha_configuration) {\n                msg.person = ha_configuration[msg.linkedPerson];\n                delete msg.payload;\n                return msg;\n        }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":1820,"wires":[["549c43c3443d883f"]]},{"id":"549c43c3443d883f","type":"function","z":"5db64edb8eadb607","name":"set phone_wifi","func":"let persons = global.get(\"persons\") || {};\n\nif (!(msg.linkedPerson in persons)) {\n    persons[msg.linkedPerson] = {};\n    persons[msg.linkedPerson].homeDistance = -1;\n    persons[msg.linkedPerson].name = msg.person.name;\n    persons[msg.linkedPerson].bluetooth = {};\n}\n\npersons[msg.linkedPerson].wifi = msg.state;\nglobal.set(\"persons\", persons);\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":340,"y":1820,"wires":[["ad7fb736c71b744d"]]},{"id":"ad7fb736c71b744d","type":"link out","z":"5db64edb8eadb607","name":"detect persons wifi","mode":"link","links":[],"x":1225,"y":1820,"wires":[]},{"id":"f52eed949708c549","type":"link in","z":"5db64edb8eadb607","name":"link in 407","links":["4d44b039681cc6cd"],"x":55,"y":2180,"wires":[["da40470e07efdd18"]]},{"id":"b4c9930324b962fd","type":"comment","z":"5db64edb8eadb607","name":"linkedAction: control_device","info":"","x":160,"y":2120,"wires":[]},{"id":"da40470e07efdd18","type":"function","z":"5db64edb8eadb607","name":"control_device","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\n\nif (\"control_device\" in ha_configuration && msg.payload.entity_id in ha_configuration[\"control_device\"]) {\n        msg = { ...msg.payload.event.new_state, control_device: ha_configuration[\"control_device\"][msg.payload.entity_id] };\n\n        delete msg.payload;\n        return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":2180,"wires":[["26abb5af0922722f"]]},{"id":"26abb5af0922722f","type":"link out","z":"5db64edb8eadb607","name":"control_device","mode":"link","links":["fbc1c0ac1d7bec76"],"x":1225,"y":2180,"wires":[]},{"id":"e2084ffb49335b77","type":"link out","z":"5db64edb8eadb607","name":"detect motion off","mode":"link","links":["13a390949bac6841","a9d131c4dbe11860","fbc1c0ac1d7bec76","20da1d1d997c0428"],"x":1225,"y":1100,"wires":[]},{"id":"35de429a78f68ace","type":"change","z":"5db64edb8eadb607","name":"","rules":[{"t":"delete","p":"ha_state","pt":"msg"},{"t":"delete","p":"alias","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":735,"y":1100,"wires":[["e2084ffb49335b77"]],"l":false},{"id":"8b943fca42c01b65","type":"link in","z":"5db64edb8eadb607","name":"link in 410","links":["6c9a074a2dc15225"],"x":55,"y":2300,"wires":[["0c07be25be917042"]]},{"id":"f840f02ae4b9722a","type":"comment","z":"5db64edb8eadb607","name":"linkedClass: remote","info":"","x":130,"y":2240,"wires":[]},{"id":"0c07be25be917042","type":"function","z":"5db64edb8eadb607","name":"remote","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"remote\";\n\nif (\"linkedClass\" in ha_configuration[msg.payload.entity_id] && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass) {\n        msg = { ...msg.payload.event.new_state, ...ha_configuration[msg.payload.entity_id] };\n\n        delete msg.payload;\n        return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":2300,"wires":[["2b4f212fa503ce2d"]]},{"id":"2b4f212fa503ce2d","type":"subflow:d193bde43bd55f9f","z":"5db64edb8eadb607","name":"","x":1140,"y":2300,"wires":[]},{"id":"5dc09e4546d9e62a","type":"switch","z":"5db64edb8eadb607","name":"control_device key exist","property":"ha_configuration.control_device","propertyType":"global","rules":[{"t":"hask","v":"payload.entity_id","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":590,"y":300,"wires":[["4d44b039681cc6cd"]]},{"id":"4d44b039681cc6cd","type":"link out","z":"5db64edb8eadb607","name":"control_device key exist","mode":"link","links":["f52eed949708c549"],"x":735,"y":300,"wires":[]},{"id":"f1440c480e2de1bc","type":"file in","z":"5db64edb8eadb607","name":"get ha_configuration","filename":"/config/entities/user_configuration.yaml","filenameType":"str","format":"utf8","chunk":false,"sendError":false,"encoding":"none","allProps":false,"x":800,"y":120,"wires":[["af4ed2b8b2672048"]]},{"id":"a553dfd0d3f3df48","type":"yaml","z":"5db64edb8eadb607","property":"payload","name":"","x":150,"y":180,"wires":[["8155e92220629738"]]},{"id":"8155e92220629738","type":"function","z":"5db64edb8eadb607","name":"set global.ha_configuration","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet ha_configuration_file = msg.payload;\n\nlet ha_configuration_file_keys = Object.keys(ha_configuration_file);\nlet ha_configuration_keys = Object.keys(ha_configuration);\nlet msgs = [];\n\nif (\"reloadAll\" in msg && msg.reloadAll) {\n    ha_configuration = msg.payload;\n} else {\n    for (let key of ha_configuration_file_keys) {\n        if (\"linkedClass\" in ha_configuration_file[key] && ha_configuration_file[key].linkedClass == \"motion\") {\n            let motion = ha_configuration[key];\n            delete motion.state;\n            if (JSON.stringify(ha_configuration_file[key]) != JSON.stringify(motion)) {\n                global.set(\"motionArea\", {});\n            }\n        } else if (JSON.stringify(ha_configuration_file[key]) != JSON.stringify(ha_configuration[key])) {\n            if (\"linkedClass\" in ha_configuration_file[key] &&\n                (ha_configuration_file[key].linkedClass == \"ambiance\" || ha_configuration_file[key].linkedClass == \"ambiance_select\")) {\n                global.set(\"ambiances\", {});\n            }\n            if (\"linkedClass\" in ha_configuration_file[key] && ha_configuration_file[key].linkedClass == \"cube\") {\n                global.set(\"cubes\", {});\n            }\n            ha_configuration[key] = ha_configuration_file[key];\n        }\n    }\n}\n\nglobal.set(\"ha_configuration\", ha_configuration);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":340,"y":180,"wires":[["99be5f8e27fbe0db","69921aad961be528"]]},{"id":"d22abdd33ba9aee7","type":"function","z":"5db64edb8eadb607","name":"global.ha_configuration not exist","func":"if (Object.keys(global.get(\"ha_configuration\") || {}).length == 0) {\n    return { reloadAll: true };\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":120,"wires":[["f1440c480e2de1bc"]]},{"id":"8a7374ae240edc55","type":"link out","z":"5db64edb8eadb607","name":"","mode":"link","links":["ba01e397c4ca1e22"],"x":325,"y":120,"wires":[]},{"id":"cb44cde26ee31290","type":"link out","z":"5db64edb8eadb607","name":"detect hour","mode":"link","links":["0a58c821fdc03b27","14b33d911438f95c","2c41d0af87e204e7","750c28d389fe672b","fbc1c0ac1d7bec76","fb43b785c9654545"],"x":1075,"y":40,"wires":[]},{"id":"6b133f949c3795fe","type":"comment","z":"5db64edb8eadb607","name":"linkedClass: cover","info":"","x":130,"y":740,"wires":[]},{"id":"39865ab68216d6a6","type":"link in","z":"5db64edb8eadb607","name":"link in 419","links":["6c9a074a2dc15225"],"x":55,"y":800,"wires":[["e7fee8dbaa5f48ed"]]},{"id":"e7fee8dbaa5f48ed","type":"function","z":"5db64edb8eadb607","name":"cover","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet linkedClass = \"cover\";\n\nif (msg.payload.event.old_state.state != msg.payload.event.new_state.state && \"linkedClass\" in ha_configuration[msg.payload.entity_id] && ha_configuration[msg.payload.entity_id].linkedClass == linkedClass) {\n        msg = { ...msg, ...(msg.payload.entity_id in ha_configuration ? ha_configuration[msg.payload.entity_id] : {}) };\n        msg.newState = parseInt(msg.payload.event.new_state.state);\n        msg.oldState = parseInt(msg.payload.event.old_state.state);\n        msg.entity_id = msg.payload.entity_id;\n\n        delete msg.payload;\n        return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":800,"wires":[["b7ac33720a1cbe49"]]},{"id":"b7ac33720a1cbe49","type":"link out","z":"5db64edb8eadb607","name":"detect cover","mode":"link","links":["ff8917fbe0e53ade"],"x":1225,"y":800,"wires":[]},{"id":"59f17f3b25bd3ec6","type":"link in","z":"5db64edb8eadb607","name":"link in 424","links":["5a303de0484c8578"],"x":55,"y":1160,"wires":[["955a69cfe9348ae5"]]},{"id":"d20ad6447c28a0eb","type":"link out","z":"5db64edb8eadb607","name":"link out 419","mode":"return","links":[],"x":495,"y":1160,"wires":[]},{"id":"ea12aea2bf4d781c","type":"link call","z":"5db64edb8eadb607","name":"set motion area","links":["59f17f3b25bd3ec6"],"linkType":"static","timeout":"30","x":540,"y":1040,"wires":[["1ce7b3c97b338020"]]},{"id":"99be5f8e27fbe0db","type":"function","z":"5db64edb8eadb607","name":"global.motionArea exist","func":"if (Object.keys(global.get(\"motionArea\") || {}).length == 0) {\n    msg.filter = { \"in\": { linkedClass: \"motion\" } };\n    msg.result = \"entities\";\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":180,"wires":[["ca109e57a549d988"]]},{"id":"ca109e57a549d988","type":"link call","z":"5db64edb8eadb607","name":"set motion area","links":["59f17f3b25bd3ec6"],"linkType":"static","timeout":"30","x":860,"y":180,"wires":[[]]},{"id":"af4ed2b8b2672048","type":"link out","z":"5db64edb8eadb607","name":"link out 420","mode":"link","links":["4e1a62887302f259"],"x":935,"y":120,"wires":[]},{"id":"4e1a62887302f259","type":"link in","z":"5db64edb8eadb607","name":"link in 425","links":["af4ed2b8b2672048"],"x":55,"y":180,"wires":[["a553dfd0d3f3df48"]]},{"id":"05622adb2099a7cb","type":"moment","z":"5db64edb8eadb607","name":"get date","topic":"","input":"","inputType":"date","inTz":"ETC/UTC","adjAmount":"0","adjType":"hours","adjDir":"add","format":"YYYY-MM-DD HH:mm","locale":"C","output":"currentTime","outputType":"msg","outTz":"Europe/Paris","x":780,"y":40,"wires":[["08a2e534e6dd4397"]]},{"id":"d3c516a5226a53b8","type":"moment","z":"5db64edb8eadb607","name":"get time","topic":"","input":"","inputType":"date","inTz":"ETC/UTC","adjAmount":"0","adjType":"hours","adjDir":"add","format":"HH:mm","locale":"C","output":"currentTime","outputType":"msg","outTz":"Europe/Paris","x":980,"y":40,"wires":[["cb44cde26ee31290"]]},{"id":"305181e3928ba486","type":"subflow:723d4991c3c87385","z":"5db64edb8eadb607","name":"","x":1010,"y":1940,"wires":[]},{"id":"69921aad961be528","type":"link out","z":"5db64edb8eadb607","name":"","mode":"link","links":["ba01e397c4ca1e22"],"x":495,"y":180,"wires":[]},{"id":"a0bd3e00c1f69781","type":"catch","z":"86923293ffb7e575","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["ccfff7a2d1032fef"]]},{"id":"b43c2c1d12fd392d","type":"api-call-service","z":"86923293ffb7e575","name":"recap 1","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recap_1"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":960,"y":320,"wires":[[]]},{"id":"f17e5d0251891c67","type":"api-call-service","z":"86923293ffb7e575","name":"recap 2","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recap_2"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":960,"y":320,"wires":[[]]},{"id":"f041c7513f66d5a3","type":"change","z":"86923293ffb7e575","name":"txt1","rules":[{"t":"set","p":"payload","pt":"msg","to":"txt1","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":320,"wires":[["b43c2c1d12fd392d"]]},{"id":"5ea78cfacfd01d4c","type":"change","z":"86923293ffb7e575","name":"txt2","rules":[{"t":"set","p":"payload","pt":"msg","to":"txt2","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":320,"wires":[["f17e5d0251891c67"]]},{"id":"c098385623b7e699","type":"function","z":"86923293ffb7e575","name":"recap presence","func":"let notifications = global.get(\"notifications\") || {};\nlet notificationsKeys = Object.keys(notifications);\nlet txt = \"\";\n\ntxt += \"<center><h2>Notifications \" + (notificationsKeys.length == 0 ? \"✅\" : \":\") + \"</h2>\";\n\n// NOTIFICATIONS\nlet first = true;\nlet alertPriority = { \"error\": 1, \"warning\": 2, \"success\": 3, \"info\": 4 };\nnotificationsKeys.sort(function (a, b) { return alertPriority[notifications[a].alertType] - alertPriority[notifications[b].alertType] });\nfor (let notificationsKey of notificationsKeys) {\n    if (notifications[notificationsKey].zone.includes(\"inside\")) {\n        if (notifications[notificationsKey].alertType != \"\") {\n            txt += (!first ? \"<br>\" : \"\") + '<ha-alert alert-type=\"' + notifications[notificationsKey].alertType + '\">' + notifications[notificationsKey].message + \"</ha-alert>\";\n        } else {\n            txt += notifications[notificationsKey].title;\n        }\n        first = false;\n    }\n}\n\ntxt += \"</center>\";\n\nmsg.txt1 = { \"data\": { \"value\": txt.substring(0, 254) } };\nmsg.txt2 = { \"data\": { \"value\": txt.substring(254, 508) } };\nmsg.txt3 = { \"data\": { \"value\": txt.substring(508, 762) } };\nmsg.txt4 = { \"data\": { \"value\": txt.substring(762, 1016) } };\nmsg.txt5 = { \"data\": { \"value\": txt.substring(1016, 1270) } };\nmsg.txt6 = { \"data\": { \"value\": txt.substring(1270, 1524) } };\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":320,"wires":[["f041c7513f66d5a3","5ea78cfacfd01d4c","570492d18c2f9780","f359115289938c2d","1c6806dd52b32a38","217f91bd7e9a9633"]]},{"id":"2cc9264d86dae78a","type":"function","z":"86923293ffb7e575","name":"recap absence","func":"let notifications = global.get(\"notifications\") || {};\nlet notificationsKeys = Object.keys(notifications);\nlet txt = \"\";\n\n// HEADER\nlet home_invitation = getState(\"input_boolean.home_invitation\") == \"on\";\nif (home_invitation) {\n    txt += \"<center><h2>Mode invitation actif \" + (notificationsKeys.length == 0 ? \"✅\" : \":\") + \"</h2>\";\n} else {\n    txt += \"<center><h2>Notifications \" + (notificationsKeys.length == 0 ? \"✅\" : \":\") + \"</h2>\";\n}\n\n// NOTIFICATIONS\nlet first = true;\nlet alertPriority = { \"error\": 1, \"warning\": 2, \"success\": 3, \"info\": 4 };\nnotificationsKeys.sort(function (a, b) { return alertPriority[notifications[a].alertType] - alertPriority[notifications[b].alertType] });\nfor (let notificationsKey of notificationsKeys) {\n    if (notifications[notificationsKey].zone.includes(\"outside\")) {\n        if (notifications[notificationsKey].alertType != \"\") {\n            txt += (!first ? \"<br>\" : \"\") + '<ha-alert alert-type=\"' + notifications[notificationsKey].alertType + '\">' + notifications[notificationsKey].message + \"</ha-alert>\";\n        } else {\n            txt += notifications[notificationsKey].title;\n        }\n        first = false;\n    }\n}\n\ntxt += \"</center>\";\n\nmsg.txt1 = { \"data\": { \"value\": txt.substring(0, 254) } };\nmsg.txt2 = { \"data\": { \"value\": txt.substring(254, 508) } };\nmsg.txt3 = { \"data\": { \"value\": txt.substring(508, 762) } };\nmsg.txt4 = { \"data\": { \"value\": txt.substring(762, 1016) } };\nmsg.txt5 = { \"data\": { \"value\": txt.substring(1016, 1270) } };\nmsg.txt6 = { \"data\": { \"value\": txt.substring(1270, 1524) } };\n\nreturn msg;\n\nfunction getState(entity_id) {\n    if (entity_id in global.get(\"homeassistant\").homeAssistant.states) {\n        return global.get(\"homeassistant\").homeAssistant.states[entity_id].state;\n    } else {\n        return \"\";\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":380,"wires":[["5ea78cfacfd01d4c","f359115289938c2d","217f91bd7e9a9633","f041c7513f66d5a3","570492d18c2f9780","1c6806dd52b32a38"]]},{"id":"6daab380b00c0282","type":"subflow:e6ac576fb4598283","z":"86923293ffb7e575","name":"","x":480,"y":320,"wires":[["c098385623b7e699"],["2cc9264d86dae78a"]]},{"id":"0ecf08aa987f0450","type":"server-state-changed","z":"86923293ffb7e575","name":"sun","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sun.sun","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":90,"y":120,"wires":[["dc7aa72d2f62c04a","62d3813e84bccb4a"]]},{"id":"62d3813e84bccb4a","type":"api-call-service","z":"86923293ffb7e575","name":"set elevation","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_number.elevation"],"data":"{\"value\":\"{{data.new_state.attributes.elevation}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":230,"y":120,"wires":[[]]},{"id":"dc7aa72d2f62c04a","type":"function","z":"86923293ffb7e575","name":"function","func":"if (msg.data.old_state.state == 'below_horizon' && msg.data.new_state.state == 'above_horizon') {\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":120,"wires":[["9e39d7f1ae0518b0"]]},{"id":"9e39d7f1ae0518b0","type":"api-call-service","z":"86923293ffb7e575","name":"purge history > 3 days","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"recorder","service":"purge","areaId":[],"deviceId":[],"entityId":[],"data":"{\"keep_days\":\"3\",\"repack\":\"false\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":560,"y":120,"wires":[[]]},{"id":"6dbb6467b0ab1a39","type":"subflow:ad3b29a5dd67898f","z":"86923293ffb7e575","name":"","x":460,"y":40,"wires":[]},{"id":"ccfff7a2d1032fef","type":"change","z":"86923293ffb7e575","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Notifications","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["6dbb6467b0ab1a39"]]},{"id":"88d07525ab79542c","type":"api-call-service","z":"86923293ffb7e575","name":"recap 3","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recap_3"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":960,"y":320,"wires":[[]]},{"id":"570492d18c2f9780","type":"change","z":"86923293ffb7e575","name":"txt3","rules":[{"t":"set","p":"payload","pt":"msg","to":"txt3","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":320,"wires":[["88d07525ab79542c"]]},{"id":"9274dfd6fdaea86e","type":"api-call-service","z":"86923293ffb7e575","name":"recap 4","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recap_4"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":960,"y":380,"wires":[[]]},{"id":"f359115289938c2d","type":"change","z":"86923293ffb7e575","name":"txt4","rules":[{"t":"set","p":"payload","pt":"msg","to":"txt4","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":380,"wires":[["9274dfd6fdaea86e"]]},{"id":"c42edeed9a361f5b","type":"api-call-service","z":"86923293ffb7e575","name":"recap 5","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recap_5"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":960,"y":380,"wires":[[]]},{"id":"1c6806dd52b32a38","type":"change","z":"86923293ffb7e575","name":"txt5","rules":[{"t":"set","p":"payload","pt":"msg","to":"txt5","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":380,"wires":[["c42edeed9a361f5b"]]},{"id":"ee3f9cbea92c653d","type":"api-call-service","z":"86923293ffb7e575","name":"recap 6","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recap_6"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":960,"y":380,"wires":[[]]},{"id":"217f91bd7e9a9633","type":"change","z":"86923293ffb7e575","name":"txt6","rules":[{"t":"set","p":"payload","pt":"msg","to":"txt6","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":380,"wires":[["ee3f9cbea92c653d"]]},{"id":"3d55123d5a0ef973","type":"subflow:6c4028aab794d52d","z":"86923293ffb7e575","name":"","x":170,"y":320,"wires":[["6daab380b00c0282"]]},{"id":"4fcc3b49d98a2c1f","type":"link in","z":"86923293ffb7e575","name":"notification","links":["ad446eefb7df13b9","db2a87c1d25e790a","53f20c1b123f35a2","9efffdb0ef885bb8","604d97b1c4befed2","9cbe78b2241026d2","041e52487b294778","3108493db991645d","45af9fa28332c9ea","b2f601230d55ad01","774ae1c614b41638","ec3a162f37ac727a","18d4b11011f0c20b","ba78b5e5c855646d","ced63105eee2903b","2293fd1b7eb68348","12db0960dcc59044","6be74e8ddda30b40","f02a5c5bf62e5e0c","2e001b7d46b62357","a546510700c89455","ebc79424c9266d44","b8a8b2386a16ebe3","26bf77adbe18a8c6","08c93702f30dea3a","d9c985b15cd4cd54","08aa6a694a30f006","93218896eff01151","8eef2ad2d99d780f","7ed2b9fc73f864e3","f8c09b1c8a0bedf2","743f5fda8b689c2c","cbe89428a1bce3d2","41c03bb8a071fda7","33c24c7c52435205","2ca739e1baf94b4b","bc565cb3613c2eb8","2b960bc7d3565741","fc6f9a12ca3d3c25","c5c8bf8009943bf5","4081f75de6cc9b4f","3fc43a2dd10bba99","430ec4e954d98214","94a976c93bbf5c7c","6f459ab11a551418","0dc804fe20ae0d4a","4c7682a3d69b57a1","12947aaf7b3ad675","47e4fe779b75e0dc","2f8a3219e659722d","3b3dd6b16a5c5a1d","625506e86313414c","b968a370a50879c2"],"x":55,"y":320,"wires":[["3d55123d5a0ef973"]]},{"id":"985567bb7da8bc0b","type":"server-state-changed","z":"86923293ffb7e575","name":"zone.home","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"zone.home","entityidfiltertype":"exact","outputinitially":true,"state_type":"num","haltifstate":"","halt_if_type":"num","halt_if_compare":"gt","outputs":1,"output_only_on_state_change":false,"for":"0","forType":"num","forUnits":"seconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":320,"y":320,"wires":[["6daab380b00c0282"]]},{"id":"f8c09b1c8a0bedf2","type":"link out","z":"86923293ffb7e575","name":"link out 257","mode":"link","links":["4fcc3b49d98a2c1f"],"x":575,"y":260,"wires":[]},{"id":"69910239d39b440a","type":"comment","z":"86923293ffb7e575","name":"Notification","info":"","x":100,"y":200,"wires":[]},{"id":"3b22bd7a735af263","type":"ha-get-entities","z":"86923293ffb7e575","name":"get persistentNotifications","server":"66876666.3e6288","version":0,"rules":[{"property":"state","logic":"is","value":"notifying","valueType":"str"},{"property":"entity_id","logic":"is","value":"persistent_notification.*","valueType":"re"}],"output_type":"array","output_empty_results":false,"output_location_type":"msg","output_location":"persistentNotifications","output_results_count":1,"x":210,"y":260,"wires":[["1a0c2271010612ac"]]},{"id":"fb43b785c9654545","type":"link in","z":"86923293ffb7e575","name":"link in 427","links":["cb44cde26ee31290"],"x":55,"y":260,"wires":[["3b22bd7a735af263"]]},{"id":"1a0c2271010612ac","type":"function","z":"86923293ffb7e575","name":"set global notifications","func":"let notifications = global.get(\"notifications\") || {};\nlet persistentNotifications = msg.persistentNotifications;\nlet msgs = [];\n\nlet notificationKeys = Object.keys(notifications);\nif (persistentNotifications.length > notificationKeys.length) {\n    for (let persistentNotification of persistentNotifications) {\n        if (!(notificationKeys.includes(persistentNotification.entity_id.split(\".\")[1]))) {\n\n            let title = persistentNotification.attributes.title;\n            let message = persistentNotification.attributes.message;\n            let alertType = \"error\";\n            let zone = [\"inside\", \"outside\"];\n            let count = 1;\n\n            msgs.push({\n                notification_id: persistentNotification.entity_id.split(\".\")[1],\n                title: title,\n                message: message,\n                alertType: alertType,\n                zone: zone,\n                count: count\n            });\n        }\n    }\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":260,"wires":[["f8c09b1c8a0bedf2"]]},{"id":"7d355bae08e9bcc8","type":"catch","z":"b0b353ce861d908b","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["041f4aa52ca65740"]]},{"id":"08a8d6e0e1cf9419","type":"server-events","z":"b0b353ce861d908b","name":"phone receive","server":"66876666.3e6288","version":2,"eventType":"mobile_app_notification_action","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":110,"y":300,"wires":[["ac173fc7add2f604"]]},{"id":"ac173fc7add2f604","type":"switch","z":"b0b353ce861d908b","name":"invitation_off","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"invitation_off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":270,"y":300,"wires":[["fd526be7658c06c2"]]},{"id":"fd526be7658c06c2","type":"api-call-service","z":"b0b353ce861d908b","name":"home_invitation off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.invitation"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":450,"y":300,"wires":[["0a5f0f171df609dc"]]},{"id":"837f5e57291454a2","type":"link in","z":"b0b353ce861d908b","name":"set nearest","links":["22bace3b59def9cc","6b62e5e1bfab0019","a272e7ace5110c9b","2cf5a5d542aacb96"],"x":55,"y":180,"wires":[["922083f63b657fbb"]]},{"id":"fcec0f9c2adc1980","type":"subflow:ad3b29a5dd67898f","z":"b0b353ce861d908b","name":"","x":460,"y":40,"wires":[]},{"id":"041f4aa52ca65740","type":"change","z":"b0b353ce861d908b","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Presence","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["fcec0f9c2adc1980"]]},{"id":"2293fd1b7eb68348","type":"link out","z":"b0b353ce861d908b","name":"link out 223","mode":"link","links":["4fcc3b49d98a2c1f"],"x":735,"y":300,"wires":[]},{"id":"0a5f0f171df609dc","type":"function","z":"b0b353ce861d908b","name":"notification","func":"msg.notification_id = \"invitation\";\nmsg.dismiss = true;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":300,"wires":[["2293fd1b7eb68348"]]},{"id":"85b278c323f3b6c6","type":"server-state-changed","z":"b0b353ce861d908b","name":"invitation","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.invitation","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":100,"y":360,"wires":[["24771a7fefeb56f5"],["6acfa8ca4b422c72"]]},{"id":"24771a7fefeb56f5","type":"function","z":"b0b353ce861d908b","name":"notification","func":"msg.notification_id = \"invitation\";\nmsg.title = \"Mode invitation: Activé\";\nmsg.alertType = \"success\";\nmsg.message = \"Mode invitation activé\";\nmsg.sendMobile = true;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":360,"wires":[["08aa6a694a30f006"]]},{"id":"08aa6a694a30f006","type":"link out","z":"b0b353ce861d908b","name":"link out 232","mode":"link","links":["4fcc3b49d98a2c1f"],"x":525,"y":360,"wires":[]},{"id":"4a3b930cb95bbe93","type":"function","z":"b0b353ce861d908b","name":"notification","func":"msg.notification_id = \"invitation\";\nmsg.dismiss = true;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":360,"wires":[["08aa6a694a30f006"]]},{"id":"78879f268b739306","type":"function","z":"b0b353ce861d908b","name":"get zones","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\n\nif (\"zone.home\" in ha_configuration) {\n    let persons = global.get(\"persons\") || {};\n    let personsKeys = Object.keys(persons);\n    let distance = [];\n\n    for (let key of personsKeys) {\n        distance.push(persons[key].homeDistance);\n    }\n\n    if (distance.length != 0) {\n        distance.sort(function (a, b) { return a - b });\n        let zones = ha_configuration[\"zone.home\"];\n        let msgs = [];\n\n        let zonesKeys = Object.keys(zones);\n        for (let key of zonesKeys) {\n            if (distance[0] <= zones[key]) {\n                msgs.push({ service: \"turn_on\", entity_id: key });\n            } else {\n                msgs.push({ service: \"turn_off\", entity_id: key });\n            }\n        }\n        return [msgs];\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":180,"wires":[["464f99375855b471"]]},{"id":"c0a033baef2e6d6d","type":"api-call-service","z":"b0b353ce861d908b","name":"set zones","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1200,"y":180,"wires":[[]]},{"id":"922083f63b657fbb","type":"api-current-state","z":"b0b353ce861d908b","name":"invitation ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.invitation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":170,"y":180,"wires":[[],["78879f268b739306"]]},{"id":"6a3ec8b19251bf55","type":"server-state-changed","z":"b0b353ce861d908b","name":"invitation","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.invitation","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":100,"y":120,"wires":[["8590f3771a72dbdc"],[]]},{"id":"afda0ab80075878c","type":"function","z":"b0b353ce861d908b","name":"set zones","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\n\nif (\"zone.home\" in ha_configuration) {\n    let zones = ha_configuration[\"zone.home\"];\n    let msgs = [];\n\n    let zonesKeys = Object.keys(zones);\n    for (let key of zonesKeys) {\n        msgs.push({ service: \"turn_on\", entity_id: key });\n    }\n\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1060,"y":180,"wires":[["c0a033baef2e6d6d"]]},{"id":"8590f3771a72dbdc","type":"subflow:e6ac576fb4598283","z":"b0b353ce861d908b","name":"","x":250,"y":120,"wires":[[],["a28f17b576d85af3"]]},{"id":"9f8f42d514cb0054","type":"subflow:050c60654a910e68","z":"b0b353ce861d908b","name":"","x":620,"y":120,"wires":[["89b60a3c819b59ce","d30f1ac4833b6f50"]]},{"id":"a28f17b576d85af3","type":"function","z":"b0b353ce861d908b","name":"set waits linkedDoors","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\n\nif (\"security_entrance\" in ha_configuration && \"linkedDoors\" in ha_configuration.security_entrance) {\n    let linkedDoors = ha_configuration.security_entrance.linkedDoors;\n    msg.waits = [];\n    msg.states = [];\n\n    for (let door of linkedDoors) {\n        msg.waits.push(door);\n        msg.states.push(\"on\");\n        msg.timeout = 240;\n    }\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":120,"wires":[["9f8f42d514cb0054"]]},{"id":"ba78b5e5c855646d","type":"link out","z":"b0b353ce861d908b","name":"link out 221","mode":"link","links":["4fcc3b49d98a2c1f"],"x":935,"y":120,"wires":[]},{"id":"d30f1ac4833b6f50","type":"function","z":"b0b353ce861d908b","name":"notification","func":"msg.notification_id = \"invitation\";\nmsg.title = \"Mode invité: Présent\";\nmsg.alertType = \"success\";\nmsg.message = \"L'invité est entré\";\nmsg.sendMobile = true;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":120,"wires":[["ba78b5e5c855646d"]]},{"id":"89b60a3c819b59ce","type":"link out","z":"b0b353ce861d908b","name":"link out 355","mode":"link","links":["da541aea7280faf7"],"x":715,"y":120,"wires":[]},{"id":"da541aea7280faf7","type":"link in","z":"b0b353ce861d908b","name":"link in 370","links":["89b60a3c819b59ce"],"x":955,"y":180,"wires":[["afda0ab80075878c"]]},{"id":"2ac1c7da511dbdd8","type":"link in","z":"b0b353ce861d908b","name":"link in 371","links":["0489992ff2313771"],"x":55,"y":240,"wires":[["a042521ec6c5bc98"]]},{"id":"0a74831b69b5de4f","type":"function","z":"b0b353ce861d908b","name":"linkedDoors ?","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\n\nif (\"security_entrance\" in ha_configuration && \"linkedDoors\" in ha_configuration.security_entrance) {\n    let linkedDoors = ha_configuration.security_entrance.linkedDoors;\n    if (linkedDoors.includes(msg.entity_id)) {\n        return msg;\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":240,"wires":[["ea36df0e95629e52"]]},{"id":"a042521ec6c5bc98","type":"api-current-state","z":"b0b353ce861d908b","name":"invitation ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.invitation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":170,"y":240,"wires":[["6ea7ea5c7b875e1c"],[]]},{"id":"2ca739e1baf94b4b","type":"link out","z":"b0b353ce861d908b","name":"link out 356","mode":"link","links":["4fcc3b49d98a2c1f"],"x":775,"y":240,"wires":[]},{"id":"ea36df0e95629e52","type":"function","z":"b0b353ce861d908b","name":"notification","func":"msg.notification_id = \"invitation\";\nmsg.title = \"Mode invité: Sortant\";\nmsg.alertType = \"success\";\nmsg.message = \"L'invité est parti\";\nmsg.data = { actions: [{ \"action\": \"invitation_off\", \"title\": \"Désactiver mode invité\" }] };\nmsg.sendMobile = true;\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":240,"wires":[["2ca739e1baf94b4b"]]},{"id":"e0e4b731f70d927f","type":"server-state-changed","z":"b0b353ce861d908b","name":"invitation","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.invitation","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":100,"y":420,"wires":[["e3a81bdc1ccb562a"],["a293f768a3ec296b"]]},{"id":"e3a81bdc1ccb562a","type":"api-call-service","z":"b0b353ce861d908b","name":"reveil off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.reveil"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":240,"y":420,"wires":[[]]},{"id":"a293f768a3ec296b","type":"api-call-service","z":"b0b353ce861d908b","name":"reveil on","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.reveil"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":380,"y":420,"wires":[[]]},{"id":"0a2bed08ec229abc","type":"server-state-changed","z":"b0b353ce861d908b","name":"in_home_zone","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_home_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":480,"wires":[[],["58fe60fe4d1e87b9"]]},{"id":"58fe60fe4d1e87b9","type":"api-call-service","z":"b0b353ce861d908b","name":"mode canape off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.mode_canape"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":310,"y":480,"wires":[[]]},{"id":"464f99375855b471","type":"function","z":"b0b353ce861d908b","name":"filter home zone","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\n\nif (\"zone.home\" in ha_configuration) {\n    if (msg.entity_id == Object.keys(ha_configuration[\"zone.home\"])[0] && msg.service == \"turn_on\") {\n        return [msg, null];\n    } else {\n        return [null, msg];\n    }\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":180,"wires":[["986fa7d9d2408fed"],["3ed9df714d540dff"]]},{"id":"986fa7d9d2408fed","type":"function","z":"b0b353ce861d908b","name":"set wait linkedDoors","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\n\nif (\"security_entrance\" in ha_configuration && \"linkedDoors\" in ha_configuration.security_entrance) {\n    let linkedDoors = ha_configuration.security_entrance.linkedDoors;\n    msg.waits = [];\n    msg.states = [];\n\n    for (let door of linkedDoors) {\n        msg.waits.push(door);\n        msg.states.push(\"on\");\n        msg.timeout = 20;\n    }\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":180,"wires":[["5787289d7c4652a5"]]},{"id":"5787289d7c4652a5","type":"subflow:050c60654a910e68","z":"b0b353ce861d908b","name":"","x":860,"y":180,"wires":[["c0a033baef2e6d6d"]]},{"id":"2cf5a5d542aacb96","type":"link out","z":"b0b353ce861d908b","name":"link out 400","mode":"link","links":["837f5e57291454a2"],"x":575,"y":360,"wires":[]},{"id":"3dff4d53cd1e7309","type":"comment","z":"b0b353ce861d908b","name":"Zones detect","info":"","x":110,"y":760,"wires":[]},{"id":"992e0b9bf2f9a7b5","type":"function","z":"b0b353ce861d908b","name":"notification","func":"msg.title = \"Liste de courses:\";\nmsg.data = { clickAction: \"https://keep.google.com/u/0/#LIST/1OMLS-IRRl7_EcGH0gXfJ9RvevCyX-GpV2Ri1DMklLg87l3k1if4Wsf0PceCJAimAL7fR\" };\nmsg.sendMobile = true;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":820,"wires":[["9cbf7198f4d10a5b"]]},{"id":"302aac40cf4e1144","type":"ha-zone","z":"b0b353ce861d908b","name":"Erwan Courses","server":"66876666.3e6288","version":0,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entities":["device_tracker.phone"],"event":"enter","zones":["zone.courses","zone.magasin_2","zone.magasin_3"],"x":120,"y":820,"wires":[["bf60495b3b1730f3"]]},{"id":"9cbf7198f4d10a5b","type":"subflow:ba09e97f2ed22f2b","z":"b0b353ce861d908b","name":"","x":620,"y":820,"wires":[]},{"id":"bf60495b3b1730f3","type":"delay","z":"b0b353ce861d908b","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"hour","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":290,"y":820,"wires":[["992e0b9bf2f9a7b5"]]},{"id":"65a5d5e9d9d9d752","type":"comment","z":"b0b353ce861d908b","name":"Security","info":"","x":100,"y":560,"wires":[]},{"id":"e5f67442c9d87639","type":"delay","z":"b0b353ce861d908b","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":160,"y":620,"wires":[["7e4840b6876573aa"]]},{"id":"7e4840b6876573aa","type":"function","z":"b0b353ce861d908b","name":"notification","func":"let in_home_zone = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.in_home_zone\"].state == \"on\";\n\nif (!in_home_zone) {\n    let friendly_name = msg.attributes.friendly_name;\n    friendly_name = friendly_name.charAt(0).toUpperCase() + friendly_name.slice(1);\n\n    msg.alertType = \"error\";\n    msg.title = \"Mode surveillance: Mouvement détécté\";\n    msg.message = \" > Détection : \" + friendly_name + \" 💢\";\n    msg.notification_id = \"security_\" + msg.entity_id.split(\".\")[1];\n    msg.zone = [\"inside\", \"outside\"];\n    msg.sendMobile = true;\n    msg.data = {};\n\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":620,"wires":[["ad446eefb7df13b9"]]},{"id":"0ef64107e361a055","type":"api-current-state","z":"b0b353ce861d908b","name":"invitation on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.invitation","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":600,"y":680,"wires":[[],["85e70ba4e021ee27"]]},{"id":"85e70ba4e021ee27","type":"function","z":"b0b353ce861d908b","name":"notification","func":"if (msg.payload == \"off\") {\n    msg.notification_id = \"security_intrusion\";\n    msg.alertType = \"success\";\n    msg.title = \"Mode surveillance: Activé\";\n    msg.message = \"Mode surveillance activé 🛡️\";\n    msg.zone = [\"inside\", \"outside\"];\n    msg.sendMobile = false;\n    msg.data = {};\n} else {\n    msg.notification_id = \"security_intrusion\";\n    msg.dismiss = true;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":680,"wires":[["db2a87c1d25e790a"]]},{"id":"ad446eefb7df13b9","type":"link out","z":"b0b353ce861d908b","name":"link out 203","mode":"link","links":["4fcc3b49d98a2c1f"],"x":415,"y":620,"wires":[]},{"id":"db2a87c1d25e790a","type":"link out","z":"b0b353ce861d908b","name":"link out 205","mode":"link","links":["4fcc3b49d98a2c1f"],"x":875,"y":680,"wires":[]},{"id":"9747baf2bc79243c","type":"server-state-changed","z":"b0b353ce861d908b","name":"invitation","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.invitation","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":100,"y":680,"wires":[[],["50bcb623608b5268"]]},{"id":"50bcb623608b5268","type":"subflow:e6ac576fb4598283","z":"b0b353ce861d908b","name":"","x":250,"y":680,"wires":[[],["0ad2fc52e05f884f"]]},{"id":"2479895c05c38144","type":"server-state-changed","z":"b0b353ce861d908b","name":"in_home_zone","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_home_zone","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":420,"y":680,"wires":[["0ef64107e361a055"],["58bacc915e20ccdc"]]},{"id":"514ddcb3e84c5765","type":"link in","z":"b0b353ce861d908b","name":"security","links":["d719c2de89994314"],"x":55,"y":620,"wires":[["e5f67442c9d87639"]]},{"id":"6ea7ea5c7b875e1c","type":"api-current-state","z":"b0b353ce861d908b","name":"home empty","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"0","halt_if_type":"num","halt_if_compare":"is","entity_id":"zone.home","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":330,"y":240,"wires":[["0a74831b69b5de4f"],[]]},{"id":"13a390949bac6841","type":"link in","z":"ccf1abe540a3b5a9","name":"light on/off/last","links":["69601683934d5337","97cd4b5251421ee0","7ed8d8c9c40bff59","e7c5e008342c4826","a05eae266322e6dc","0489992ff2313771","0490f80a37072b35","1849c3d6ff1ccfb0","946612fff0682b4c","c7a86f08021d6103","9c1ae434ae76af59","b8e8a6779e6eae20","eadee799d3f92a1d","c94243a944d034c5","a0ec305d313aa8f9","01a0f34909e557d2","e2084ffb49335b77"],"x":55,"y":220,"wires":[["a40553b9e1b431c2"]]},{"id":"c16109ee9dcc8d36","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 358","mode":"link","links":["f43547038a49e0b1","6430216584826676"],"x":875,"y":280,"wires":[]},{"id":"276aeb51a13a0819","type":"function","z":"ccf1abe540a3b5a9","name":"sun calc","func":"let sunDateTimeLightOff = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_angle_light_off_time\"].state;\nlet sunDateTimeLightOn = global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_angle_light_on_time\"].state;\nlet sunDateTimeSunrise = global.get('homeassistant').homeAssistant.states[\"input_datetime.rise_light_time\"].state;\nlet sunAngleLightOff = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_light_off\"].state);\nlet sunAngleLightOn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_light_on\"].state);\nlet lightTimeStatus = global.get('homeassistant').homeAssistant.states[\"input_boolean.light_time_status\"].state == \"on\"; \nlet nextDawn = msg.data.new_state.attributes.next_dawn;\nlet oldElevation = msg.data.old_state.attributes.elevation;\nlet newElevation = msg.data.new_state.attributes.elevation;\nlet msgs = [];\n\nlet nextDawnHMS = getHMS(nextDawn);\nif (sunDateTimeSunrise != nextDawnHMS){\n    msgs.push({ entity_id: \"input_datetime.rise_light_time\", time: nextDawnHMS });\n}\n\nif (oldElevation <= sunAngleLightOff && sunAngleLightOff <= newElevation && getHMS() != sunDateTimeLightOff){\n    msgs.push({ entity_id: \"input_datetime.sun_angle_light_off_time\", time: getHMS() });\n}\n\nif (oldElevation >= sunAngleLightOn && sunAngleLightOn >= newElevation && getHMS() != sunDateTimeLightOn) {\n    msgs.push({ entity_id: \"input_datetime.sun_angle_light_on_time\", time: getHMS() });\n}\n\nif (lightTimeStatus && minutesCalc(sunDateTimeLightOff) <= minutesCalc(getHMS()) && minutesCalc(getHMS()) <= minutesCalc(sunDateTimeLightOn)) {\n    msg.state = \"off\";\n} else if (!lightTimeStatus && !(minutesCalc(sunDateTimeLightOff) <= minutesCalc(getHMS()) && minutesCalc(getHMS()) <= minutesCalc(sunDateTimeLightOn))) {\n    msg.state = \"on\";\n}\n\nreturn [msgs,msg];\n\nfunction getHMS(dateString) {\n    let date = dateString == null ? new Date() : new Date(dateString);\n    return (date.getHours() < 10 ? \"0\" + date.getHours() : date.getHours()) + \":\" + (date.getMinutes() < 10 ? \"0\" + date.getMinutes() : date.getMinutes()) + \":00\";\n}\n\nfunction minutesCalc(date) {\n    return parseInt(date.slice(0, 2) * 60) + parseInt(date.slice(3, 5));\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":220,"y":140,"wires":[["2a98fab2161c3ec9"],["ec213f2d09b7d0c6"]]},{"id":"5c1578eb5358a261","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"sun","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sun.sun","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":90,"y":140,"wires":[["276aeb51a13a0819"]]},{"id":"751c99b6607ee7b1","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"in_home_zone","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_home_zone","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":660,"wires":[[],["ad9a09b8e7b92562"]]},{"id":"0fcb5d94030ab313","type":"catch","z":"ccf1abe540a3b5a9","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":60,"wires":[["d52e65e568a3244a"]]},{"id":"308dcdc841f55ee0","type":"subflow:ad3b29a5dd67898f","z":"ccf1abe540a3b5a9","name":"","x":460,"y":60,"wires":[]},{"id":"d52e65e568a3244a","type":"change","z":"ccf1abe540a3b5a9","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Lights","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":60,"wires":[["308dcdc841f55ee0"]]},{"id":"b1bee60d1fd3da40","type":"function","z":"ccf1abe540a3b5a9","name":"current time status","func":"let lightTimeStatus = global.get('homeassistant').homeAssistant.states[\"input_boolean.light_time_status\"].state == \"on\";\nlet sunAngleLightOnTime = minutes_calc(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_angle_light_on_time\"].state);\nlet nightLightTime = minutes_calc(global.get('homeassistant').homeAssistant.states[\"input_datetime.night_light_time\"].state);\nlet riseLightTime = minutes_calc(global.get('homeassistant').homeAssistant.states[\"input_datetime.rise_light_time\"].state);\nlet sunAngleLightOffTime = minutes_calc(global.get('homeassistant').homeAssistant.states[\"input_datetime.sun_angle_light_off_time\"].state);\nlet currentTime = minutes_calc(new Date().toString().slice(16, 21));\n\nnightLightTime = nightLightTime <= sunAngleLightOnTime ? 1440 - sunAngleLightOnTime + nightLightTime : nightLightTime - sunAngleLightOnTime;\nriseLightTime = 1440 - sunAngleLightOnTime + riseLightTime;\nsunAngleLightOffTime = 1440 - sunAngleLightOnTime + sunAngleLightOffTime;\ncurrentTime = sunAngleLightOnTime <= currentTime ? currentTime - sunAngleLightOnTime : 1440 - sunAngleLightOnTime + currentTime;\nsunAngleLightOnTime = 0;\n\nif (lightTimeStatus && currentTime >= sunAngleLightOnTime && currentTime < nightLightTime) {\n    msg.currentTimeStatus = min_is1(pctCalc(sunAngleLightOnTime, nightLightTime, currentTime, false));\n} else if (lightTimeStatus && currentTime >= nightLightTime && currentTime < riseLightTime) {\n    msg.currentTimeStatus = 100;\n} else if (lightTimeStatus && currentTime >= riseLightTime && currentTime < sunAngleLightOffTime) {\n    msg.currentTimeStatus = min_is1(pctCalc(riseLightTime, sunAngleLightOffTime, currentTime, true));\n} else if (lightTimeStatus) {\n    msg.currentTimeStatus = 1;\n} else {\n    msg.currentTimeStatus = 0;\n}\nreturn msg;\n\nfunction minutes_calc(date) {\n    return parseInt(date.slice(0, 2) * 60) + parseInt(date.slice(3, 5));\n}\n\nfunction min_is1(number) {\n    return number < 1 ? 1 : number;\n}\n\nfunction pctCalc(min, max, nb, reverse) {\n    return nb < min ? (reverse ? 100 : 0) : nb > max ? (reverse ? 0 : 100) : reverse ? (max - nb) / Math.abs(min - max) * 100 : (nb - min) / Math.abs(min - max) * 100;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":340,"wires":[["262dd804ff651dbf"]]},{"id":"262dd804ff651dbf","type":"function","z":"ccf1abe540a3b5a9","name":"brightness pct","func":"if (msg.currentTimeStatus == 0 && msg.dayLight) {\n    msg.brightnessPct = msg.brightRange[1];\n} else if (msg.currentTimeStatus == 0 && msg.lightWhenCloudy) {\n    msg.brightnessPct = cloudyLightBrightnessPctCalc();\n} else {\n    if (msg.currentTimeStatus < 50) {\n        msg.brightnessPct = 50 + 50 * Math.cos((36 * msg.currentTimeStatus / 10 - 180) * Math.PI / 180);\n        if (msg.lightWhenCloudy) {\n            let cloudyLightBrightnessPct = cloudyLightBrightnessPctCalc();\n            msg.brightnessPct = cloudyLightBrightnessPct > msg.brightnessPct ? cloudyLightBrightnessPct : msg.brightnessPct;\n        }\n    } else {\n        msg.brightnessPct = 100 * Math.cos((18 * msg.currentTimeStatus / 10 - 90) * Math.PI / 180);\n    }\n    msg.brightnessPct = msg.brightnessPct * msg.brightRange[1] / 100 + msg.brightRange[0] * (100 - msg.brightnessPct) / 100;\n}\n\nif (msg.motionState == \"on\" && (msg.currentTimeStatus != 100 || msg.nightLight)) {\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n\nfunction pctCalc(min, max, nb, reverse) {\n    return nb < min ? (reverse ? 100 : 0) : nb > max ? (reverse ? 0 : 100) : reverse ? (max - nb) / Math.abs(min - max) * 100 : (nb - min) / Math.abs(min - max) * 100;\n}\n\nfunction cloudyLightBrightnessPctCalc() {\n    let cloudy_light = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.cloudy_light\"].state);\n    let illuminances = global.get(\"illuminances\") || {};\n    return pctCalc(50, cloudy_light, illuminances[\"exterior\"], true);\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":340,"wires":[["02814d30601aa3af"],["ab7efea6038a1013"]]},{"id":"02814d30601aa3af","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 363","mode":"link","links":["b1bba93bd37d5d05"],"x":815,"y":340,"wires":[]},{"id":"ab7efea6038a1013","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 364","mode":"link","links":["4bdf829a570f42ef"],"x":865,"y":340,"wires":[]},{"id":"b1bba93bd37d5d05","type":"link in","z":"ccf1abe540a3b5a9","name":"link in 379","links":["02814d30601aa3af"],"x":115,"y":400,"wires":[["c2309ba3320c4c50"]]},{"id":"c2309ba3320c4c50","type":"switch","z":"ccf1abe540a3b5a9","name":"color ?","property":"color","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":210,"y":400,"wires":[["525315b5041cfb6e"],["68556bf00513cc3b"]]},{"id":"059646ead3d2a49f","type":"function","z":"ccf1abe540a3b5a9","name":"temp","func":"let colorTemp = msg.currentTimeStatus * (msg.colorTempRange[1] - msg.colorTempRange[0]) / 100 + msg.colorTempRange[0];\n\nmsg.payload = {\n    data: {\n        entity_id: msg.entity_id,\n        color_temp: colorTemp,\n        brightness_pct: msg.brightnessPct,\n        transition: msg.transitionRange[0]\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":400,"wires":[["f4a70f8d00443477"]]},{"id":"525315b5041cfb6e","type":"function","z":"ccf1abe540a3b5a9","name":"hs color","func":"let colorRotate = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.color_rotate\"].state);\nlet hsColor = [(360 * (msg.currentTimeStatus / 100) + colorRotate) % 360, msg.hsSaturation];\n\nmsg.payload = {\n    data: {\n        entity_id: msg.entity_id,\n        hs_color: hsColor,\n        brightness_pct: msg.brightnessPct,\n        transition: msg.transitionRange[0]\n    }\n};\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":340,"y":400,"wires":[["f4a70f8d00443477"]]},{"id":"f4a70f8d00443477","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control light on","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":620,"y":400,"wires":[[]]},{"id":"4bdf829a570f42ef","type":"link in","z":"ccf1abe540a3b5a9","name":"link in 380","links":["ab7efea6038a1013","dc601dd0c5207b78"],"x":115,"y":460,"wires":[["79f626eba220efd3"]]},{"id":"79f626eba220efd3","type":"switch","z":"ccf1abe540a3b5a9","name":"color ?","property":"color","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":210,"y":460,"wires":[["28ae2d8ddeb77867"],["4b1a090c5eac6d5d"]]},{"id":"39a04d72d1e9fc02","type":"function","z":"ccf1abe540a3b5a9","name":"temp","func":"msg.payload = {\n    data: {\n        entity_id: msg.entity_id,\n        transition: msg.transitionRange[1]\n    }\n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":460,"wires":[["a4b98272aabef1c3"]]},{"id":"28ae2d8ddeb77867","type":"function","z":"ccf1abe540a3b5a9","name":"hs color","func":"let colorRotate = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.color_rotate\"].state);\n\nmsg.hsColor = [(360 * (msg.currentTimeStatus / 100) + colorRotate) % 360, msg.hsSaturation];\nmsg.transition = msg.transitionRange[1] * 1000;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":340,"y":460,"wires":[["7a9937d226a8849e"]]},{"id":"a4b98272aabef1c3","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control light off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":820,"y":460,"wires":[[]]},{"id":"7a9937d226a8849e","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control yeelight off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"yeelight","service":"start_flow","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"action\": \"off\",\"count\": \"1\",\"transitions\": [{\"HSVTransition\": [{{hsColor}},{{transition}},1]},{\"SleepTransition\":2000}]}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":510,"y":460,"wires":[[]]},{"id":"4c5d190004d0ac98","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"light_time_status state","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_{{state}}","areaId":[],"deviceId":[],"entityId":["input_boolean.light_time_status"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":680,"y":140,"wires":[[]]},{"id":"2a98fab2161c3ec9","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"set light_time","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_datetime","service":"set_datetime","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"time\":\"{{time}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":370,"y":140,"wires":[[]]},{"id":"ec213f2d09b7d0c6","type":"switch","z":"ccf1abe540a3b5a9","name":"state ?","property":"state","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":510,"y":140,"wires":[["4c5d190004d0ac98"]]},{"id":"57970c88e211ce04","type":"link in","z":"ccf1abe540a3b5a9","name":"ambiance","links":["a11e52f70b3f44ee"],"x":615,"y":60,"wires":[["3def32a14603ce09"]]},{"id":"b8e8a6779e6eae20","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 372","mode":"link","links":["13a390949bac6841"],"x":1015,"y":60,"wires":[]},{"id":"ddf840aed2822269","type":"subflow:612068fa04cc8bbd","z":"ccf1abe540a3b5a9","name":"","x":930,"y":60,"wires":[["b8e8a6779e6eae20"]]},{"id":"17df8120f9c53aca","type":"link in","z":"ccf1abe540a3b5a9","name":"cube","links":["aa868fbff20bbef5"],"x":835,"y":60,"wires":[["ddf840aed2822269"]]},{"id":"d31d59eca145cbf3","type":"subflow:ea5b93cde6b1bf0a","z":"ccf1abe540a3b5a9","name":"","x":510,"y":220,"wires":[["692843b77d632d73"]]},{"id":"79b22379be79f83f","type":"function","z":"ccf1abe540a3b5a9","name":"msg lights","func":"msg.filter = { \"in\": { linkedClass: \"light\", linkedArea: msg.linkedArea } };\nmsg.result = \"lights\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":220,"wires":[["d31d59eca145cbf3"]]},{"id":"fd6da1a9eb3b4a30","type":"function","z":"ccf1abe540a3b5a9","name":"msgs lights","func":"let lightWhenCloudy = global.get('homeassistant').homeAssistant.states[\"input_boolean.light_when_cloudy\"].state == \"on\";\nlet lightTimeStatus = global.get('homeassistant').homeAssistant.states[\"input_boolean.light_time_status\"].state == \"on\";\nlet cloudy_light = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.cloudy_light\"].state);\nlet illuminances = global.get(\"illuminances\") || {};\nlet lights = msg.lights;\nlet msgs = [];\n\nif (lights.length != 0) {\n    delete msg.lights;\n    delete msg.linkedClass;\n    for (let light of lights) {\n        msgs.push({\n            lightWhenCloudy: lightWhenCloudy && \"exterior\" in illuminances ? illuminances[\"exterior\"] < cloudy_light : false,\n            lightTimeStatus: lightTimeStatus,\n            lightState: light.state,\n            motionState: msg.state == \"last\" ? light.lastLight ? \"on\" : \"off\" : msg.state,\n            covers: msg.covers,\n            ...light\n        });\n    }\n\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":280,"wires":[["93ba87ba312b913a"]]},{"id":"93ba87ba312b913a","type":"subflow:10a4bbabe046de0e","z":"ccf1abe540a3b5a9","name":"","x":640,"y":280,"wires":[["5890eb33250f72d1"]]},{"id":"56c4434e8fac0757","type":"function","z":"ccf1abe540a3b5a9","name":"msg covers","func":"msg.filter = { \"in\": { linkedClass: \"cover\", linkedArea: msg.linkedArea, state: \"off\" } };\nmsg.result = \"covers\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":280,"wires":[["94220b29503cf863"]]},{"id":"94220b29503cf863","type":"subflow:ea5b93cde6b1bf0a","z":"ccf1abe540a3b5a9","name":"","x":330,"y":280,"wires":[["fd6da1a9eb3b4a30"]]},{"id":"5890eb33250f72d1","type":"function","z":"ccf1abe540a3b5a9","name":"msg light","func":"let covers = msg.covers;\ndelete msg.covers;\n\nif (msg.lightState != \"unavailable\" && (msg.dayLight || msg.lightWhenCloudy || msg.lightTimeStatus || covers.length != 0)) {\n    return msg;\n} else if (msg.lightState == \"on\") {\n    msg.motionState = \"off\";\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":780,"y":280,"wires":[["c16109ee9dcc8d36"]]},{"id":"6430216584826676","type":"link in","z":"ccf1abe540a3b5a9","name":"link in 382","links":["ad9cf82da7b8d9d5","c16109ee9dcc8d36"],"x":55,"y":340,"wires":[["06801e5b53e8a439"]]},{"id":"06801e5b53e8a439","type":"function","z":"ccf1abe540a3b5a9","name":"not light ?","func":"if (\"attributes\" in msg && \"supported_color_modes\" in msg.attributes && msg.entity_id.split(\".\")[0] == \"light\") {\n    return [null, msg];\n} else {\n    msg.domain = msg.entity_id.split(\".\")[0];\n    msg.service = \"turn_\" + msg.motionState;\n    return [msg, null];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":340,"wires":[["d86d8527b58936dd"],["af3037a2c000ff8b"]]},{"id":"d86d8527b58936dd","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control device","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"{{domain}}","service":"{{service}}","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":320,"y":340,"wires":[[]]},{"id":"b92bbceff4118685","type":"function","z":"ccf1abe540a3b5a9","name":"msg","func":"msg.filter = { \"in\": { linkedClass: \"light\" } };\nmsg.result = \"lights\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":600,"wires":[["f15fc07f246b58c7"]]},{"id":"3d427e9849b65be2","type":"function","z":"ccf1abe540a3b5a9","name":"restore lights from motions","func":"let motionArea = global.get(\"motionArea\");\nlet lights = msg.lights;\nlet areas = [];\nlet msgs = [];\n\nfor (let light of lights) {\n    if (!areas.includes(light.linkedArea)) {\n        areas.push(light.linkedArea);\n    }\n}\n\nfor (let area of areas) {\n    msgs.push({ linkedArea: area, state: motionArea[area] });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":860,"y":600,"wires":[["a0ec305d313aa8f9"]]},{"id":"f15fc07f246b58c7","type":"subflow:ea5b93cde6b1bf0a","z":"ccf1abe540a3b5a9","name":"","x":650,"y":600,"wires":[["3d427e9849b65be2"]]},{"id":"a0ec305d313aa8f9","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 373","mode":"link","links":["13a390949bac6841"],"x":1015,"y":600,"wires":[]},{"id":"a8aedad4f45a3e9c","type":"delay","z":"ccf1abe540a3b5a9","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":300,"y":540,"wires":[["96fcc71316f08920"]]},{"id":"830aa417e845e28d","type":"subflow:e6ac576fb4598283","z":"ccf1abe540a3b5a9","name":"","x":370,"y":600,"wires":[["b92bbceff4118685"],[]]},{"id":"2e22c3522e999a5b","type":"ha-time","z":"ccf1abe540a3b5a9","name":"night_light_time","server":"66876666.3e6288","version":2,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityId":"input_datetime.night_light_time","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"debugenabled":false,"x":800,"y":540,"wires":[["96fcc71316f08920"]]},{"id":"3b11cb01c3e36fd8","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"light time status","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.light_time_status","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":620,"y":540,"wires":[["96fcc71316f08920"]]},{"id":"f6d7b10b4473bc19","type":"ha-time","z":"ccf1abe540a3b5a9","name":"rise_light_time","server":"66876666.3e6288","version":2,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityId":"input_datetime.rise_light_time","property":"state","offset":"0","offsetType":"num","offsetUnits":"minutes","randomOffset":false,"repeatDaily":true,"outputProperties":[],"sunday":true,"monday":true,"tuesday":true,"wednesday":true,"thursday":true,"friday":true,"saturday":true,"debugenabled":false,"x":450,"y":540,"wires":[["96fcc71316f08920"]]},{"id":"42bcf58ce90dbbb4","type":"link in","z":"ccf1abe540a3b5a9","name":"light restore","links":["65edb6875e6621bb","96fcc71316f08920","09c4d412366ddaa5","dd7a207b8276bacd","946e692a37fbda1a"],"x":55,"y":600,"wires":[["587a2f970b774dec"]]},{"id":"1e13104782559c9c","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"light_when_cloudy","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.light_when_cloudy","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":130,"y":540,"wires":[["a8aedad4f45a3e9c"]]},{"id":"96fcc71316f08920","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 374","mode":"link","links":["af71798a4268cb52","42bcf58ce90dbbb4"],"x":915,"y":540,"wires":[]},{"id":"f7065268d67195ca","type":"function","z":"ccf1abe540a3b5a9","name":"msg","func":"msg.filter = { \"in\": { linkedClass: \"light\" } };\nmsg.result = \"lights\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":660,"wires":[["0b2b736b0d236dfe"]]},{"id":"d90fc0e521e76bb6","type":"function","z":"ccf1abe540a3b5a9","name":"restore lights to off","func":"let motionArea = global.get(\"motionArea\");\nlet lights = msg.lights;\nlet areas = [];\nlet msgs = [];\n\nfor (let light of lights) {\n    if (!areas.includes(light.linkedArea)) {\n        areas.push(light.linkedArea);\n    }\n}\n\nfor (let area of areas) {\n    msgs.push({ linkedArea: area, state: \"off\" });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":660,"wires":[["01a0f34909e557d2"]]},{"id":"0b2b736b0d236dfe","type":"subflow:ea5b93cde6b1bf0a","z":"ccf1abe540a3b5a9","name":"","x":610,"y":660,"wires":[["d90fc0e521e76bb6"]]},{"id":"01a0f34909e557d2","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 375","mode":"link","links":["13a390949bac6841"],"x":915,"y":660,"wires":[]},{"id":"3def32a14603ce09","type":"subflow:7166242293a03ec9","z":"ccf1abe540a3b5a9","name":"","x":730,"y":60,"wires":[["b8e8a6779e6eae20"]]},{"id":"a40553b9e1b431c2","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"module_lights on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":190,"y":220,"wires":[["79b22379be79f83f"],[]]},{"id":"692843b77d632d73","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 404","mode":"link","links":["16ac30e099907d0d"],"x":615,"y":220,"wires":[]},{"id":"16ac30e099907d0d","type":"link in","z":"ccf1abe540a3b5a9","name":"link in 412","links":["692843b77d632d73"],"x":55,"y":280,"wires":[["56c4434e8fac0757"]]},{"id":"587a2f970b774dec","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"module_lights on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":190,"y":600,"wires":[["830aa417e845e28d"],[]]},{"id":"ad9a09b8e7b92562","type":"api-current-state","z":"ccf1abe540a3b5a9","name":"module_lights on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_lights","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":310,"y":660,"wires":[["f7065268d67195ca"],[]]},{"id":"c984c4aec56dc82b","type":"server-state-changed","z":"ccf1abe540a3b5a9","name":"module_lights","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_lights","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":720,"wires":[["946e692a37fbda1a","e35423a2a82f9168"],["e35423a2a82f9168","7dec798e895a6d15"]]},{"id":"e904c7abdbd0b8c2","type":"function","z":"ccf1abe540a3b5a9","name":"notification","func":"msg.notification_id = \"module_light\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"warning\";\n    msg.title = \"Module Lumière: Désactivé\";\n    msg.message = \"Module Lumière désactivé, les lumières sont allumées\";\n    msg.zone = [\"inside\", \"outside\"];\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":720,"wires":[["4c7682a3d69b57a1"]]},{"id":"4c7682a3d69b57a1","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 411","mode":"link","links":["4fcc3b49d98a2c1f"],"x":435,"y":720,"wires":[]},{"id":"946e692a37fbda1a","type":"link out","z":"ccf1abe540a3b5a9","name":"link out 413","mode":"link","links":["42bcf58ce90dbbb4"],"x":215,"y":720,"wires":[]},{"id":"dd7a5828af21418b","type":"function","z":"ccf1abe540a3b5a9","name":"msg","func":"msg.filter = { \"in\": { linkedClass: \"light\" } };\nmsg.result = \"lights\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":720,"wires":[["11be460593f3bb59"]]},{"id":"11be460593f3bb59","type":"subflow:ea5b93cde6b1bf0a","z":"ccf1abe540a3b5a9","name":"","x":670,"y":720,"wires":[["39c5c048d2a868a7"]]},{"id":"5687a334154dd78b","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"control light","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":970,"y":720,"wires":[[]]},{"id":"39c5c048d2a868a7","type":"function","z":"ccf1abe540a3b5a9","name":"lights on","func":"let lights = msg.lights;\nlet msgs = [];\n\nfor (let light of lights) {\n    if (light.entity_id.includes(\"light.\")) {\n        msgs.push({\n            payload: {\n                data: {\n                    entity_id: light.entity_id,\n                    brightness_pct: 100,\n                    color_temp: 300\n                }\n            }\n        });\n    }\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":720,"wires":[["5687a334154dd78b"]]},{"id":"88c00c21600773b6","type":"api-call-service","z":"ccf1abe540a3b5a9","name":"light off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{topic}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":320,"y":780,"wires":[[]]},{"id":"09585a8a2a9ee022","type":"trigger-state","z":"ccf1abe540a3b5a9","name":"unavailable light is on","server":"66876666.3e6288","version":2,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"light.","entityidfiltertype":"substring","debugenabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"},{"targetType":"entity_id","targetValue":"input_boolean.in_home_zone","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"}],"inputs":0,"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","enableInput":false,"x":140,"y":780,"wires":[[],[]]},{"id":"2d9fb02c1fccfbd7","type":"catch","z":"3998ef2c82bf81bd","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["b24926d32f88191e"]]},{"id":"18b8697fd0427f4a","type":"server-events","z":"3998ef2c82bf81bd","name":"receive heat_temp","server":"66876666.3e6288","version":2,"eventType":"ifttt_webhook_received","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":130,"y":580,"wires":[["c91e693019df46e2"]]},{"id":"0a2b0d2961694033","type":"server-state-changed","z":"3998ef2c82bf81bd","name":"heat_temp","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_text.heat_temp","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"num","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"x":100,"y":520,"wires":[["403fddaf5e746eec"]]},{"id":"e9634dadd5dfdf47","type":"subflow:ad3b29a5dd67898f","z":"3998ef2c82bf81bd","name":"","x":460,"y":40,"wires":[]},{"id":"b24926d32f88191e","type":"change","z":"3998ef2c82bf81bd","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Heaters","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["e9634dadd5dfdf47"]]},{"id":"b2f17a37d788668d","type":"inject","z":"3998ef2c82bf81bd","name":"every 1 minute","props":[],"repeat":"","crontab":"*/1 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":340,"y":120,"wires":[["1282e9565c65e7a9","cffd67d39d011ee2"]]},{"id":"7dc58d13464a24f9","type":"moment","z":"3998ef2c82bf81bd","name":"","topic":"","input":"","inputType":"date","inTz":"Europe/Paris","adjAmount":0,"adjType":"days","adjDir":"add","format":"HH:mm","locale":"C","output":"currentTime","outputType":"msg","outTz":"Europe/Paris","x":885,"y":120,"wires":[["9a1fb288d1f8499b"]],"l":false},{"id":"1f3a7ba89df3c217","type":"subflow:723d4991c3c87385","z":"3998ef2c82bf81bd","name":"","x":750,"y":180,"wires":[]},{"id":"3108493db991645d","type":"link out","z":"3998ef2c82bf81bd","name":"link out 215","mode":"link","links":["4fcc3b49d98a2c1f"],"x":875,"y":180,"wires":[]},{"id":"9a1fb288d1f8499b","type":"link out","z":"3998ef2c82bf81bd","name":"link out 216","mode":"link","links":["a07e5ddd63592049"],"x":935,"y":120,"wires":[]},{"id":"a07e5ddd63592049","type":"link in","z":"3998ef2c82bf81bd","name":"link in 230","links":["9a1fb288d1f8499b"],"x":55,"y":240,"wires":[["5dcdfa88079cbb00"]]},{"id":"45af9fa28332c9ea","type":"link out","z":"3998ef2c82bf81bd","name":"link out 219","mode":"link","links":["4fcc3b49d98a2c1f"],"x":1305,"y":180,"wires":[]},{"id":"c092963b10b94f10","type":"server-state-changed","z":"3998ef2c82bf81bd","name":"heat_temp","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_text.heat_temp","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"num","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":160,"y":120,"wires":[["1282e9565c65e7a9"]]},{"id":"b2f601230d55ad01","type":"link out","z":"3998ef2c82bf81bd","name":"link out 220","mode":"link","links":["4fcc3b49d98a2c1f"],"x":835,"y":520,"wires":[]},{"id":"08c55c196779f452","type":"function","z":"3998ef2c82bf81bd","name":"notification","func":"let heat_temp = msg.payload.toString();\n\nmsg.notification_id = \"heater_temp_lock\";\nif (heat_temp == \"Auto\"){\n    msg.speak = \"Chauffage en mode auto\";\n    msg.dismiss = true;\n} else {\n    msg.alertType = \"success\";\n    msg.title = \"Chauffage vérrouillé:\";\n    msg.message = \"Chauffage verrouillé à \" + heat_temp.replace(\".\", \",\") + \"°C\";\n    msg.speak = \"Chauffage verrouillé à \" + heat_temp.replace(\".\", \",\") + \"°\";\n    msg.sendMobile = false;\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":730,"y":520,"wires":[["b2f601230d55ad01"]]},{"id":"403fddaf5e746eec","type":"function","z":"3998ef2c82bf81bd","name":"clean target","func":"let heat_temp = parseFloat(msg.payload.replace(/[^\\d|,.]/g, \"\").replace(\",\", \".\"));\n\nif (isNaN(heat_temp)) {\n    msg.payload = \"Auto\";\n} else {\n    msg.payload = heat_temp > 22 ? 22 : heat_temp;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":250,"y":520,"wires":[["58c67ae6b04af28f"]]},{"id":"c2419ca5fa8f02cf","type":"api-call-service","z":"3998ef2c82bf81bd","name":"set heat_temp","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.heat_temp"],"data":"{\"value\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":560,"y":520,"wires":[["08c55c196779f452"]]},{"id":"bdcd5e94cfb8d5a8","type":"api-call-service","z":"3998ef2c82bf81bd","name":"set heat_temp","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.heat_temp"],"data":"{\"value\":\"{{payload}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":480,"y":580,"wires":[[]]},{"id":"c91e693019df46e2","type":"function","z":"3998ef2c82bf81bd","name":"clean target","func":"if (msg.payload.event.entity_id == \"heat_temp\") {\n    let heat_temp = parseFloat(msg.payload.event.value.replace(/[^\\d|,.]/g, \"\").replace(\",\", \".\"));\n    if (isNaN(heat_temp)) {\n        msg.payload = \"Auto\";\n    } else {\n        msg.payload = heat_temp > 22 ? 22 : heat_temp;\n    }\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":580,"wires":[["bdcd5e94cfb8d5a8"]]},{"id":"34cc2829477fee92","type":"server-state-changed","z":"3998ef2c82bf81bd","name":"in_home_zone","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_home_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":380,"wires":[["ba59601af723a5e2"],["ba59601af723a5e2"]]},{"id":"eb7801ebfac72a74","type":"api-call-service","z":"3998ef2c82bf81bd","name":"set heat_temp","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.heat_temp"],"data":"{\"value\":\"{{value}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":380,"y":440,"wires":[[]]},{"id":"3c7a2e7e55e2ba48","type":"link in","z":"3998ef2c82bf81bd","name":"input heaters","links":["0489992ff2313771","f9bc064b194c9654"],"x":55,"y":120,"wires":[["1282e9565c65e7a9"]]},{"id":"dda0d7d30bcb2207","type":"server-state-changed","z":"3998ef2c82bf81bd","name":"heat","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.heat","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":90,"y":320,"wires":[[],["c8638757f3e91562"]]},{"id":"5dcdfa88079cbb00","type":"api-current-state","z":"3998ef2c82bf81bd","name":"heat_on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":160,"y":240,"wires":[["1fd867bbc10ac04b"],[]]},{"id":"a546510700c89455","type":"link out","z":"3998ef2c82bf81bd","name":"link out 227","mode":"link","links":["4fcc3b49d98a2c1f"],"x":915,"y":440,"wires":[]},{"id":"cef693a7e9409f17","type":"function","z":"3998ef2c82bf81bd","name":"notification","func":"let heat_temp = msg.value.toString();\n\nmsg.notification_id = \"heater_temp_lock\";\nif (heat_temp == \"Auto\") {\n    msg.dismiss = true;\n} else {\n    msg.alertType = \"success\";\n    msg.title = \"Chauffage vérrouillé: Hors proximité\";\n    msg.message = \"Hors proximité : Chauffage verrouillé à \" + heat_temp.replace(\".\", \",\") + \"°C\";\n    msg.sendMobile = true;\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":440,"wires":[["a546510700c89455"]]},{"id":"c8c049ab4a30f86c","type":"function","z":"3998ef2c82bf81bd","name":"control global heat","func":"let temp_max = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_max\"].state);\nlet temp_min = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state);\nlet heat = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.heat\"].state == \"on\";\nlet temperatures = global.get(\"temperatures\") || {};\nlet temperaturesKeys = Object.keys(temperatures);\nlet globalTemp = 0;\n\nfor (let temperaturesKey of temperaturesKeys){\n    if (temperaturesKey != \"exterior\"){\n        globalTemp += temperatures[temperaturesKey].temperature / temperaturesKeys.length;\n    }\n}\n\nif (globalTemp == 0 && heat){\n    msg.notification_id = \"heater\";\n    msg.alertType = \"error\";\n    msg.title = \"Chauffage désactivé\";\n    msg.message = \"Mode chauffage désactivé: Il n'y a pas de température reçue\";\n    msg.speak = msg.message;\n    msg.zone = [\"inside\", \"outside\"];\n    msg.entity_id = \"input_boolean.heat\";\n    msg.state = \"off\";\n    return msg;    \n} else if (globalTemp < temp_min && !heat) {\n    msg.notification_id = \"heater\";\n    msg.alertType = \"success\";\n    msg.title = \"Activation chauffage mode auto\";\n    msg.message = \"Mode chauffage activé: La température est basse, le chauffage est prêt\";\n    msg.speak = msg.message;\n    msg.zone = [\"inside\", \"outside\"];\n    msg.entity_id = \"input_boolean.heat\";\n    msg.state = \"on\";\n    return msg;\n} else if (globalTemp > temp_max && heat) {\n    msg.notification_id = \"heater\";\n    msg.alertType = \"success\";\n    msg.title = \"Désactivation chauffage mode auto\";\n    msg.message = \"Mode chauffage désactivé: La température est bonne, le chauffage est désactivé\";\n    msg.speak = msg.message;\n    msg.zone = [\"inside\", \"outside\"];\n    msg.entity_id = \"input_boolean.heat\";\n    msg.state = \"off\";\n    return msg;\n} else {\n    msg.notification_id = \"heater\";\n    msg.dismiss = true;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":180,"wires":[["1f3a7ba89df3c217","3108493db991645d"]]},{"id":"78398b3f5a3d4a39","type":"function","z":"3998ef2c82bf81bd","name":"notification","func":"msg.notification_id = \"heater_\" + msg.linkedArea;\n\nif (msg.notification == \"window_open\" && \"originalLinkedClass\" in msg && msg.originalLinkedClass == \"window\") {\n    msg.alertType = \"warning\";\n    msg.title = msg.alias[0].toUpperCase() + msg.alias.substring(1) + \": Désactivé\";\n    msg.message = \"Le \" + msg.alias + \" est désactivé. \" + setMessage(msg.windows);\n    msg.speak = msg.alias + \" désactivé. \" + setMessage(msg.windows);\n    msg.sendMobile = true;\n    return msg;\n} else if (msg.notification == \"heater_no_target\") {\n    msg.alertType = \"warning\";\n    msg.title = msg.alias[0].toUpperCase() + msg.alias.substring(1) + \": Désactivé\";\n    msg.message = \"Le \" + msg.alias + \" désactivé: Pas de consigne recue\";\n    msg.speak = msg.alias + \" désactivé: Pas de consigne recue\";\n    msg.sendMobile = true;\n    return msg;\n} else if (msg.notification == \"heater_temp_error\") {\n    msg.alertType = \"warning\";\n    msg.title = msg.alias[0].toUpperCase() + msg.alias.substring(1) + \": Désactivé\";\n    msg.message = \"Le \" + msg.alias + \" désactivé: Problème de capteur de température\";\n    msg.speak = msg.alias + \" désactivé: Problème de capteur de température\";\n    msg.sendMobile = true;\n    return msg;\n} else if (msg.notification == \"heater_reactivated\") {\n    msg.speak = msg.alias + \" réactivé\";\n    msg.sendMobile = true;\n    msg.dismiss = true;\n    return msg;\n}\n\nfunction setMessage(windows) {\n    let alias = [];\n    for (let window of windows) {\n        alias.push(window.alias);\n    }\n    if (alias.length == 1) {\n        return \"La fenêtre \" + alias[0] + \" est ouverte\";\n    } else {\n        let joinAlias = alias.join(\", \");\n        joinAlias = joinAlias.substring(0, joinAlias.lastIndexOf(\", \")) + \" et \" + joinAlias.substring(joinAlias.lastIndexOf(\", \") + 2);\n        return \"Les fenêtres \" + joinAlias + \" sont ouvertes\";\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1200,"y":180,"wires":[["45af9fa28332c9ea"]]},{"id":"be25456a3952358c","type":"trigger","z":"3998ef2c82bf81bd","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"10","extend":false,"overrideDelay":false,"units":"min","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":370,"y":180,"wires":[["c8c049ab4a30f86c"]]},{"id":"58c67ae6b04af28f","type":"trigger","z":"3998ef2c82bf81bd","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":400,"y":520,"wires":[["c2419ca5fa8f02cf"]]},{"id":"60f83b1d4b623a4a","type":"subflow:ea5b93cde6b1bf0a","z":"3998ef2c82bf81bd","name":"","x":435,"y":240,"wires":[["10ef554a0411caa8"]],"l":false},{"id":"1fd867bbc10ac04b","type":"function","z":"3998ef2c82bf81bd","name":"msg convectors","func":"msg.filter = { \"in\": { linkedClass: \"convector\" }, \"not in\": { state: \"unavailable\" } };\n\nif (\"linkedArea\" in msg) {\n    msg.filter[\"in\"].linkedArea = msg.linkedArea;\n}\n\nmsg.result = \"convectors\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":240,"wires":[["60f83b1d4b623a4a"]]},{"id":"544c12d7665ed33b","type":"function","z":"3998ef2c82bf81bd","name":"msg window","func":"msg.filter = { \"in\": { linkedClass: \"window\", linkedArea: msg.linkedArea, state: \"on\" } };\nmsg.result = \"windows\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":240,"wires":[["e96d174ee74be2aa"]]},{"id":"e96d174ee74be2aa","type":"subflow:ea5b93cde6b1bf0a","z":"3998ef2c82bf81bd","name":"","x":865,"y":240,"wires":[["7910397d6583df88"]],"l":false},{"id":"7910397d6583df88","type":"function","z":"3998ef2c82bf81bd","name":"set target","func":"let notifications = global.get(\"notifications\") || {};\nlet temperatures = global.get(\"temperatures\") || {};\nlet offsetTemp = 0;\n\nif (msg.linkedArea in temperatures) {\n    if (msg.windows.length > 0) {\n        msg.notification = \"window_open\";\n        msg.state = \"off\";\n        return msg;\n    } else if (new Date().getTime() - temperatures[msg.linkedArea].lastChange < 15 * 60 * 1000) {\n        let heat_temp = global.get(\"homeassistant\").homeAssistant.states[\"input_text.heat_temp\"].state;\n        let targetTemp = heat_temp == \"Auto\" ? getTargetTemp(msg.schedule || [], msg.currentTime) : parseFloat(heat_temp);\n        if (targetTemp != 0) {\n            if (temperatures[msg.linkedArea].temperature < (targetTemp + offsetTemp)) {\n                msg.state = \"on\";\n            } else {\n                msg.state = \"off\";\n            }\n            if ((\"heater_\" + msg.linkedArea) in notifications) {\n                msg.notification = \"heater_reactivated\";\n            }\n            return msg;\n        } else {\n            msg.notification = \"heater_no_target\";\n            msg.state = \"off\";\n            return msg;\n        }\n    } else {\n        msg.notification = \"heater_temp_error\";\n        msg.state = \"off\";\n        return msg;\n    }\n}\n\nfunction getTargetTemp(schedule, currentTime) {\n    let mvt = msg.originalLinkedClass == \"motion\";\n    let motionHeater = context.get(\"motionHeater\") || {};\n    let scheduleHour = \"\";\n    let target = 0;\n    let wait = false;\n    for (let s of schedule) {\n        if (currentTime < Object.keys(s)[0]) {\n            break;\n        }\n        scheduleHour = Object.keys(s)[0];\n        wait = s[Object.keys(s)[0]][1];\n        if (!s[Object.keys(s)[0]][1] || mvt || motionHeater[msg.linkedArea + \"_\" + scheduleHour]) {\n            target = s[Object.keys(s)[0]][0];\n        }\n    }\n    if (mvt && wait) {\n        motionHeater[msg.linkedArea + \"_\" + scheduleHour] = true;\n        context.set(\"motionHeater\", motionHeater);\n    } else if (!wait) {\n        motionHeater = {};\n        context.set(\"motionHeater\", motionHeater);\n    }\n    return target;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":960,"y":240,"wires":[["3fb3dfd1ab957649","97576a07474b3d0e"]]},{"id":"3fb3dfd1ab957649","type":"subflow:723d4991c3c87385","z":"3998ef2c82bf81bd","name":"","x":1130,"y":240,"wires":[]},{"id":"97576a07474b3d0e","type":"link out","z":"3998ef2c82bf81bd","name":"link out 394","mode":"link","links":["fb236eaeab50064a"],"x":1255,"y":240,"wires":[]},{"id":"fb236eaeab50064a","type":"link in","z":"3998ef2c82bf81bd","name":"link in 397","links":["97576a07474b3d0e"],"x":935,"y":180,"wires":[["afe0c9d173840720"]]},{"id":"afe0c9d173840720","type":"switch","z":"3998ef2c82bf81bd","name":"notification ?","property":"notification","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":1040,"y":180,"wires":[["78398b3f5a3d4a39"]]},{"id":"e3513a33dea9f28a","type":"function","z":"3998ef2c82bf81bd","name":"msg convectors","func":"msg.filter = { \"in\": { linkedClass: \"convector\" }, \"not in\": { state: \"off\" } };\nmsg.result = \"convectors\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":320,"wires":[["2bfe90cf36519189"]]},{"id":"2bfe90cf36519189","type":"subflow:ea5b93cde6b1bf0a","z":"3998ef2c82bf81bd","name":"","x":610,"y":320,"wires":[["2577c8780f0c50be"]]},{"id":"2577c8780f0c50be","type":"function","z":"3998ef2c82bf81bd","name":"msgs convectors off","func":"let msgs = [];\n\nif (msg.convectors.length != 0) {\n    for (let convector of msg.convectors) {\n        msgs.push({ entity_id: convector.entity_id, state: \"off\" });\n    }\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":320,"wires":[["43759b20f6795987"]]},{"id":"43759b20f6795987","type":"subflow:723d4991c3c87385","z":"3998ef2c82bf81bd","name":"","x":1010,"y":320,"wires":[]},{"id":"05ebc168524bd79f","type":"function","z":"3998ef2c82bf81bd","name":"get heat_temp","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\n\nif (\"zone.home\" in ha_configuration && \"convector_config\" in ha_configuration && msg.entity_id in ha_configuration.convector_config) {\n    msg.value = ha_configuration.convector_config[msg.entity_id];\n    if (msg.entity_id == Object.keys(ha_configuration[\"zone.home\"])[0]) {\n        return [msg, null];\n    } else {\n        return [null, msg];\n    }\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":760,"y":380,"wires":[["4f1b8faeccb71d87"],["a7229a5caac91507"]]},{"id":"3d38d89bf2b2d3bf","type":"server-state-changed","z":"3998ef2c82bf81bd","name":"in_middle_zone","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_middle_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"x":300,"y":380,"wires":[[],["ab339a3d242b243b"]]},{"id":"ab339a3d242b243b","type":"delay","z":"3998ef2c82bf81bd","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":415,"y":380,"wires":[["05ebc168524bd79f"]],"l":false},{"id":"651bd4304374bf14","type":"server-state-changed","z":"3998ef2c82bf81bd","name":"in_big_zone","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_big_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"x":530,"y":380,"wires":[[],["5041c5064d3e6714"]]},{"id":"5041c5064d3e6714","type":"delay","z":"3998ef2c82bf81bd","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":635,"y":380,"wires":[["05ebc168524bd79f"]],"l":false},{"id":"10ef554a0411caa8","type":"function","z":"3998ef2c82bf81bd","name":"msgs convectors","func":"let msgs = [];\n\nif (msg.convectors.length != 0) {\n    for (let convector of msg.convectors) {\n        msgs.push({ originalLinkedClass: (\"linkedClass\" in msg ? msg.linkedClass : \"\"), ...convector, currentTime: msg.currentTime });\n    }\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":240,"wires":[["544c12d7665ed33b"]]},{"id":"7630e07f2eb39b55","type":"server-state-changed","z":"3998ef2c82bf81bd","name":"module_heat","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_heat","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":110,"y":660,"wires":[[],["7f771d7f8a65ade6"]]},{"id":"29f6cb8962417d5f","type":"api-current-state","z":"3998ef2c82bf81bd","name":"module_heat on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":190,"y":440,"wires":[["eb7801ebfac72a74"],[]]},{"id":"4bce06800f91f5a9","type":"api-current-state","z":"3998ef2c82bf81bd","name":"module_heat on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":630,"y":440,"wires":[["cef693a7e9409f17"],[]]},{"id":"a7229a5caac91507","type":"link out","z":"3998ef2c82bf81bd","name":"link out 407","mode":"link","links":["f6c6ed4e2a99478f","2cda1c67c8c15194"],"x":875,"y":380,"wires":[]},{"id":"f6c6ed4e2a99478f","type":"link in","z":"3998ef2c82bf81bd","name":"link in 415","links":["a7229a5caac91507"],"x":505,"y":440,"wires":[["4bce06800f91f5a9"]]},{"id":"4f1b8faeccb71d87","type":"link out","z":"3998ef2c82bf81bd","name":"link out 408","mode":"link","links":["2cda1c67c8c15194"],"x":875,"y":380,"wires":[]},{"id":"2cda1c67c8c15194","type":"link in","z":"3998ef2c82bf81bd","name":"link in 416","links":["4f1b8faeccb71d87","a7229a5caac91507"],"x":55,"y":440,"wires":[["29f6cb8962417d5f"]]},{"id":"6c16b7593312b945","type":"api-current-state","z":"3998ef2c82bf81bd","name":"module_heat on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":190,"y":180,"wires":[["be25456a3952358c"],[]]},{"id":"1282e9565c65e7a9","type":"api-current-state","z":"3998ef2c82bf81bd","name":"module_heat on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":750,"y":120,"wires":[["7dc58d13464a24f9"],[]]},{"id":"cffd67d39d011ee2","type":"link out","z":"3998ef2c82bf81bd","name":"link out 409","mode":"link","links":["2dd09bd5fab6b39b"],"x":455,"y":120,"wires":[]},{"id":"2dd09bd5fab6b39b","type":"link in","z":"3998ef2c82bf81bd","name":"link in 417","links":["cffd67d39d011ee2"],"x":55,"y":180,"wires":[["6c16b7593312b945"]]},{"id":"996dc19d19f639c2","type":"server-state-changed","z":"3998ef2c82bf81bd","name":"module_heat","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_heat","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":720,"wires":[["f3d293670a444db0"]]},{"id":"f3d293670a444db0","type":"function","z":"3998ef2c82bf81bd","name":"notification","func":"msg.notification_id = \"module_heat\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"warning\";\n    msg.title = \"Module Chauffage: Désactivé\";\n    msg.message = \"Module Chauffage désactivé, les chauffages sont allumés\";\n    msg.zone = [\"inside\", \"outside\"];\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":720,"wires":[["12947aaf7b3ad675"]]},{"id":"12947aaf7b3ad675","type":"link out","z":"3998ef2c82bf81bd","name":"link out 412","mode":"link","links":["4fcc3b49d98a2c1f"],"x":375,"y":720,"wires":[]},{"id":"7f771d7f8a65ade6","type":"function","z":"3998ef2c82bf81bd","name":"msg convectors","func":"msg.filter = { \"in\": { linkedClass: \"convector\" } };\nmsg.result = \"convectors\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":660,"wires":[["6be1e297b69762b2"]]},{"id":"6be1e297b69762b2","type":"subflow:ea5b93cde6b1bf0a","z":"3998ef2c82bf81bd","name":"","x":450,"y":660,"wires":[["7f8a570afddcf0ac"]]},{"id":"7f8a570afddcf0ac","type":"function","z":"3998ef2c82bf81bd","name":"msgs convectors on","func":"let msgs = [];\n\nif (msg.convectors.length != 0) {\n    for (let convector of msg.convectors) {\n        msgs.push({ entity_id: convector.entity_id, state: \"on\" });\n    }\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":660,"wires":[["39a03f4f183b55a8"]]},{"id":"39a03f4f183b55a8","type":"subflow:723d4991c3c87385","z":"3998ef2c82bf81bd","name":"","x":850,"y":660,"wires":[]},{"id":"c8638757f3e91562","type":"api-current-state","z":"3998ef2c82bf81bd","name":"module_heat on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":250,"y":320,"wires":[["e3513a33dea9f28a"],[]]},{"id":"c565b07b33112c5a","type":"server-state-changed","z":"3998ef2c82bf81bd","name":"module_heat","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_heat","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":570,"y":120,"wires":[["1282e9565c65e7a9"],[]]},{"id":"30e3717d3d442db0","type":"function","z":"a1ed8ea56c7ba1f9","name":"alerte temperature","func":"let tempMax = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_max\"].state);\nlet tempMin = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_min\"].state);\nlet temperatures = global.get(\"temperatures\") || {};\nlet windows = msg.windows;\nlet areaTemperatures = [];\nlet msgs = [];\n\nif (\"exterior\" in temperatures && Object.keys(temperatures).length >= 2) {\n    let exterior = temperatures[\"exterior\"];\n    let areaWindows = {};\n    for (let window of windows) {\n        let areaFilter = window.linkedArea;\n        if (!(areaFilter in areaWindows)) {\n            areaWindows[areaFilter] = {};\n            areaWindows[areaFilter].open = window.state == \"on\" ? [window] : [];\n            areaWindows[areaFilter].close = window.state == \"off\" ? [window] : [];\n        } else {\n            if (window.state == \"on\") {\n                areaWindows[areaFilter].open.push(window);\n            } else {\n                areaWindows[areaFilter].close.push(window);\n            }\n        }\n    }\n\n    //WINDOWS CLOSED OR OPEN AND EQUAL TEMPS\n    for (let key of Object.keys(temperatures)) {\n        if (key in areaWindows) {\n            if (exterior.temperature > temperatures[key].temperature && !temperatures[key].equalTemp && exterior.tendency >= 0) {\n                temperatures[key].equalTemp = true;\n                msg.linkedArea = key;\n                msg.alert = \"equal\";\n                msgs.push(msg);\n            } else if (exterior.temperature < temperatures[key].temperature && temperatures[key].equalTemp && exterior.tendency <= 0) {\n                temperatures[key].equalTemp = false;\n                msg.linkedArea = key;\n                msg.alert = \"equal\";\n                msgs.push(msg);\n            } else if (areaWindows[key].open.length > 0) {\n                if (exterior.temperature > temperatures[key].temperature && temperatures[key].highTemp && temperatures[key].tendency > 0) {\n                    msg.windows = areaWindows[key].open;\n                    msg.alert = \"outside-max-close\";\n                    msg.linkedArea = key;\n                    msgs.push(msg);\n                } else if (exterior.temperature < temperatures[key].temperature && temperatures[key].lowTemp && temperatures[key].tendency < 0) {\n                    msg.windows = areaWindows[key].open;\n                    msg.alert = \"outside-min-close\";\n                    msg.linkedArea = key;\n                    msgs.push(msg);\n                }\n            } else if (areaWindows[key].close.length > 0) {\n                if (temperatures[key].temperature > exterior.temperature && temperatures[key].highTemp && temperatures[key].tendency > exterior.tendency && exterior.tendency <= 0) {\n                    msg.windows = areaWindows[key].close;\n                    msg.alert = \"inside-max-open\";\n                    msg.linkedArea = key;\n                    msgs.push(msg);\n                }\n            }\n        }\n    }\n\n    global.set(\"temperatures\", temperatures);\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1010,"y":120,"wires":[["40f2834ca56768c6"]]},{"id":"0a58c821fdc03b27","type":"link in","z":"a1ed8ea56c7ba1f9","name":"alert temperature","links":["cb44cde26ee31290"],"x":55,"y":120,"wires":[["def9da95c9a7cb51"]]},{"id":"9678385a908ae48b","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 395","mode":"link","links":["d81df3dd8dd7039a","8a17987007c354f6","350e7e13824d9e2d","3ae3f4e5e49c5702","9335026d210d78f5","5bcd726f6b398487","6ba7c059d1250587","2ed1178129502086","649d08ccd9bcb81a","02a407d345fc4cf6","f5f018c5d4e9068c"],"x":1295,"y":120,"wires":[]},{"id":"3ae3f4e5e49c5702","type":"link in","z":"a1ed8ea56c7ba1f9","name":"link in 399","links":["9678385a908ae48b","21bb1a01566091d0"],"x":55,"y":180,"wires":[["5bfb87d8e98366e8"]]},{"id":"5bfb87d8e98366e8","type":"switch","z":"a1ed8ea56c7ba1f9","name":"alert equal","property":"alert","propertyType":"msg","rules":[{"t":"eq","v":"equal","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":170,"y":180,"wires":[["667c2fe0acdd0fe7"]]},{"id":"9335026d210d78f5","type":"link in","z":"a1ed8ea56c7ba1f9","name":"link in 400","links":["9678385a908ae48b","21bb1a01566091d0"],"x":55,"y":240,"wires":[["f3e80e3168bb7185"]]},{"id":"5bcd726f6b398487","type":"link in","z":"a1ed8ea56c7ba1f9","name":"link in 401","links":["9678385a908ae48b","21bb1a01566091d0"],"x":55,"y":300,"wires":[["d0556215d1cb34ca"]]},{"id":"f3e80e3168bb7185","type":"switch","z":"a1ed8ea56c7ba1f9","name":"alert outside-max-close","property":"alert","propertyType":"msg","rules":[{"t":"eq","v":"outside-max-close","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":210,"y":240,"wires":[["775f7afa858bb5c7"]]},{"id":"d0556215d1cb34ca","type":"switch","z":"a1ed8ea56c7ba1f9","name":"alert outside-min-close","property":"alert","propertyType":"msg","rules":[{"t":"eq","v":"outside-min-close","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":200,"y":300,"wires":[["d96fda6fe32b6748"]]},{"id":"667c2fe0acdd0fe7","type":"function","z":"a1ed8ea56c7ba1f9","name":"notification","func":"let alertSpeaker = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_speaker\"].state == \"on\";\nlet alert_light = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_light\"].state == \"on\";\n\nif (alert_light) {\n    msg.lightEffect = { \"count\": 10, \"hue1\": 40, \"hue2\": 40 };\n}\n\nif (alertSpeaker) {\n    msg.sound = \"equal.mp3\";\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":180,"wires":[["81d250c8e3f52dac","ebea586e913c75ec"]]},{"id":"64e37aeabacaf05d","type":"catch","z":"a1ed8ea56c7ba1f9","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["c26fcca6989cf4f3"]]},{"id":"02a407d345fc4cf6","type":"link in","z":"a1ed8ea56c7ba1f9","name":"link in 402","links":["9678385a908ae48b","21bb1a01566091d0"],"x":55,"y":360,"wires":[["26746a6f58763708"]]},{"id":"26746a6f58763708","type":"switch","z":"a1ed8ea56c7ba1f9","name":"alert inside-max-open","property":"alert","propertyType":"msg","rules":[{"t":"eq","v":"inside-max-open","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":200,"y":360,"wires":[["2515f3fb147c232e"]]},{"id":"a9d131c4dbe11860","type":"link in","z":"a1ed8ea56c7ba1f9","name":"link in 403","links":["0489992ff2313771","e2084ffb49335b77","f9bc064b194c9654"],"x":285,"y":120,"wires":[["be6af0e73945f3a5"]]},{"id":"40f2834ca56768c6","type":"subflow:e6ac576fb4598283","z":"a1ed8ea56c7ba1f9","name":"","x":1190,"y":120,"wires":[["9678385a908ae48b"],[]]},{"id":"ed58d9b69790c97d","type":"server-state-changed","z":"a1ed8ea56c7ba1f9","name":"in_home_zone","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_home_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"5","forType":"num","forUnits":"seconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":420,"wires":[[],["0ae75a5ce9468cf3"]]},{"id":"0d159373699dfb13","type":"api-call-service","z":"a1ed8ea56c7ba1f9","name":"activate alerts","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.alert_temp_speaker","input_boolean.alert_temp_light"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":540,"y":420,"wires":[[]]},{"id":"482a9536d24b4218","type":"subflow:ad3b29a5dd67898f","z":"a1ed8ea56c7ba1f9","name":"","x":460,"y":40,"wires":[]},{"id":"c26fcca6989cf4f3","type":"change","z":"a1ed8ea56c7ba1f9","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Temperature","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["482a9536d24b4218"]]},{"id":"3fc43a2dd10bba99","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 396","mode":"link","links":["4fcc3b49d98a2c1f"],"x":515,"y":240,"wires":[]},{"id":"430ec4e954d98214","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 397","mode":"link","links":["4fcc3b49d98a2c1f"],"x":495,"y":300,"wires":[]},{"id":"94a976c93bbf5c7c","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 398","mode":"link","links":["4fcc3b49d98a2c1f"],"x":495,"y":360,"wires":[]},{"id":"775f7afa858bb5c7","type":"function","z":"a1ed8ea56c7ba1f9","name":"notification","func":"let alertSpeaker = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_speaker\"].state == \"on\";\nlet alert_light = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_light\"].state == \"on\";\n\nmsg.notification_id = \"temperature_alert_\" + msg.linkedArea;\nmsg.zone = [\"inside\", \"outside\"];\nmsg.sendMobile = false;\nmsg.alertType = \"warning\";\nif (alert_light) {\n    msg.lightEffect = { \"count\": 10, \"hue1\": 0, \"hue2\": 0 };\n}\n\nif (alertSpeaker) {\n    msg.title = \"Température haute:\";\n    msg.message = \"Fermez\" + setMessage(msg.windows) + \"pour rester au frais\";\n    msg.speak = msg.message;\n}\n\nreturn msg;\n\nfunction setMessage(windows) {\n    let alias = [];\n    for (let window of windows) {\n        alias.push(window.alias);\n    }\n    if (alias.length == 1) {\n        return \" la fenêtre \" + alias[0] + \" \";\n    } else {\n        let joinAlias = alias.join(\", \");\n        joinAlias = joinAlias.substring(0, joinAlias.lastIndexOf(\", \")) + \" et \" + joinAlias.substring(joinAlias.lastIndexOf(\", \") + 2);\n        return \" les fenêtres \" + joinAlias + \" \";\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":240,"wires":[["3fc43a2dd10bba99"]]},{"id":"d96fda6fe32b6748","type":"function","z":"a1ed8ea56c7ba1f9","name":"notification","func":"let alertSpeaker = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_speaker\"].state == \"on\";\nlet alert_light = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_light\"].state == \"on\";\n\nmsg.notification_id = \"temperature_alert_\" + msg.linkedArea;\nmsg.zone = [\"inside\", \"outside\"];\nmsg.alertType = \"warning\";\nmsg.sendMobile = false;\nif (alert_light) {\n    msg.lightEffect = { \"count\": 10, \"hue1\": 240, \"hue2\": 240 };\n}\n\nif (alertSpeaker) {\n    msg.title = \"Température basse:\";\n    msg.message = \"Fermez\" + setMessage(msg.windows) + \"pour rester au chaud\";\n    msg.speak = msg.message;\n}\n\nreturn msg;\n\nfunction setMessage(windows) {\n    let alias = [];\n    for (let window of windows) {\n        alias.push(window.alias);\n    }\n    if (alias.length == 1) {\n        return \" la fenêtre \" + alias[0] + \" \";\n    } else {\n        let joinAlias = alias.join(\", \");\n        joinAlias = joinAlias.substring(0, joinAlias.lastIndexOf(\", \")) + \" et \" + joinAlias.substring(joinAlias.lastIndexOf(\", \") + 2);\n        return \" les fenêtres \" + joinAlias + \" \";\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":300,"wires":[["430ec4e954d98214"]]},{"id":"2515f3fb147c232e","type":"function","z":"a1ed8ea56c7ba1f9","name":"notification","func":"let alertSpeaker = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_speaker\"].state == \"on\";\nlet alert_light = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.alert_light\"].state == \"on\";\n\nmsg.notification_id = \"temperature_alert_\" + msg.linkedArea;\nmsg.zone = [\"inside\", \"outside\"];\nmsg.alertType = \"warning\";\nmsg.sendMobile = false;\nif (alert_light) {\n    msg.lightEffect = { \"count\": 10, \"hue1\": 0, \"hue2\": 0 };\n}\n\nif (alertSpeaker) {\n    msg.title = \"Température haute:\";\n    msg.message = \"Ouvrez\" + setMessage(msg.windows) + \"pour baisser la température\";\n    msg.speak = msg.message;\n}\n\nreturn msg;\n\nfunction setMessage(windows) {\n    let alias = [];\n    for (let window of windows) {\n        alias.push(window.alias);\n    }\n    if (alias.length == 1) {\n        return \" la fenêtre \" + alias[0] + \" \";\n    } else {\n        let joinAlias = alias.join(\", \");\n        joinAlias = joinAlias.substring(0, joinAlias.lastIndexOf(\", \")) + \" et \" + joinAlias.substring(joinAlias.lastIndexOf(\", \") + 2);\n        return \" les fenêtres \" + joinAlias + \" \";\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":360,"wires":[["94a976c93bbf5c7c"]]},{"id":"ebea586e913c75ec","type":"subflow:dbf17bea6affd2ec","z":"a1ed8ea56c7ba1f9","name":"","x":510,"y":180,"wires":[]},{"id":"dba11fcf0d14ada5","type":"subflow:5a05b9ac0289ff03","z":"a1ed8ea56c7ba1f9","name":"","env":[],"x":860,"y":180,"wires":[]},{"id":"81d250c8e3f52dac","type":"switch","z":"a1ed8ea56c7ba1f9","name":"lightEffect ?","property":"lightEffect","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":690,"y":180,"wires":[["dba11fcf0d14ada5"]]},{"id":"6f459ab11a551418","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 399","mode":"link","links":["4fcc3b49d98a2c1f"],"x":795,"y":560,"wires":[]},{"id":"20d242dca0363c03","type":"function","z":"a1ed8ea56c7ba1f9","name":"notification","func":"if (!msg.isTempDeviceWork) {\n    msg.notification_id = \"vmc_\" + msg.vmc.linkedArea;\n    msg.alertType = \"error\";\n    msg.title = \"Ventilation : Problème de capteur de température et/ou d'humidité\";\n    msg.message = \"La ventilation \" + msg.vmc.alias + \" est désactivée\";\n    msg.speak = msg.message;\n    msg.zone = [\"inside\", \"outside\"];\n    msg.sendMobile = true;\n    return msg;\n} else if (msg.state == \"on\") {\n    msg.notification_id = \"vmc_\" + msg.vmc.linkedArea;\n    msg.alertType = \"success\";\n    let humText = msg.tempMaxHumDiff < 0 ? \"haute\" : \"basse\";\n    msg.title = \"Ventilation: Humidité \" + humText;\n    msg.message = \"Humidité\" + humText + \" : La ventilation \" + msg.vmc.alias + \" est active\";\n    msg.zone = [\"inside\", \"outside\"];\n    msg.sendMobile = false;\n    return msg;\n} else {\n    msg.notification_id = \"vmc_\" + msg.vmc.linkedArea;\n    msg.dismiss = true;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":690,"y":560,"wires":[["6f459ab11a551418"]]},{"id":"3bfc18636a021e10","type":"subflow:723d4991c3c87385","z":"a1ed8ea56c7ba1f9","name":"","x":510,"y":560,"wires":[]},{"id":"5fbb43407c109fc0","type":"function","z":"a1ed8ea56c7ba1f9","name":"prepare devices","func":"let temperatures = global.get(\"temperatures\") || {};\nlet humidities = global.get(\"humidities\") || {};\nlet currentTime = msg.currentTime;\nlet ventilations = msg.ventilations;\nlet areaVentilations = {};\nlet diffPtRosee = 2;\nlet roseePts = {};\nlet msgs = [];\n\nif (ventilations.length == 1) {\n    areaVentilations[ventilations[0].linkedArea] = ventilations[0];\n} else {\n    for (let ventilation of ventilations) {\n        areaVentilations[ventilation.linkedArea] = ventilation;\n    }\n}\n\nroseePts[\"exterior\"] = calcRoseePt(temperatures[\"exterior\"].temperature, humidities[\"exterior\"].humidity);\nlet areaKeys = Object.keys(areaVentilations);\nfor (let key of areaKeys) {\n    if (areaKeys.length == 1 && !isScheduled(currentTime, areaVentilations[key])) {\n        let humidityKey = Object.keys(humidities);\n        humidityKey.sort(function (a, b) { return humidities[a].humidity - humidities[b].humidity }).reverse();\n        let area = humidityKey[0] != \"exterior\" ? humidityKey[0] : humidityKey[1];\n        if (area in humidities && area in temperatures) {\n            roseePts[key] = calcRoseePt(temperatures[area].temperature, humidities[area].humidity);\n        }\n    } else if (key in temperatures && key in humidities && !isScheduled(currentTime, areaVentilations[key])) {\n        roseePts[key] = calcRoseePt(temperatures[key].temperature, humidities[key].humidity);\n    }\n}\n\nfor (let key of Object.keys(roseePts)) {\n    if (key != \"exterior\") {\n        let isTempDeviceWork = new Date().getTime() - humidities[key].lastChange < 15 * 60 * 1000;\n        let tempMaxHumDiff = roseePts[\"exterior\"] - roseePts[key];\n        let isMaxOrMinHum = humidities[key].lowHumidity || humidities[key].highHumidity;\n        if (isTempDeviceWork && (Math.abs(tempMaxHumDiff) > diffPtRosee || Math.abs(humidities[key].tendency) > 1) && isMaxOrMinHum) {\n            if (areaVentilations[key].state == \"off\") {\n                msgs.push({\n                    entity_id: areaVentilations[key].entity_id,\n                    state: \"on\",\n                    vmc: areaVentilations[key],\n                    tempMaxHumDiff: tempMaxHumDiff,\n                    isTempDeviceWork: isTempDeviceWork\n                });\n            }\n        } else {\n            if (areaVentilations[key].state == \"on\") {\n                msgs.push({\n                    entity_id: areaVentilations[key].entity_id,\n                    state: \"off\",\n                    vmc: areaVentilations[key],\n                    tempMaxHumDiff: tempMaxHumDiff,\n                    isTempDeviceWork: isTempDeviceWork\n                });\n            }\n        }\n    }\n}\n\nreturn [msgs];\n\nfunction calcRoseePt(temperature, humidity) {\n    let a = (17.27 * temperature) / (237.7 + temperature);\n    return (237.7 * (a + Math.log(humidity / 100))) / (17.27 - (a + Math.log(humidity / 100)));\n}\n\nfunction isScheduled(currentTime, vmc) {\n    let validate = false;\n    for (let i = 0; i < vmc.onTime.length; i++) {\n        validate = validate || (vmc.onTime[i] <= currentTime && currentTime <= vmc.offTime[i]);\n    }\n    return validate;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":560,"wires":[["3bfc18636a021e10","20d242dca0363c03"]]},{"id":"3b2602c55ca04f7c","type":"inject","z":"a1ed8ea56c7ba1f9","name":"every 20 min","props":[],"repeat":"","crontab":"*/20 0-23 * * *","once":false,"onceDelay":0.1,"topic":"","x":140,"y":500,"wires":[["be89ec4e23a228dc"]]},{"id":"6c113e8d1373c341","type":"moment","z":"a1ed8ea56c7ba1f9","name":"get time","topic":"","input":"","inputType":"date","inTz":"Europe/Paris","adjAmount":"0","adjType":"hours","adjDir":"add","format":"HH:mm","locale":"C","output":"currentTime","outputType":"msg","outTz":"Europe/Paris","x":160,"y":560,"wires":[["5fbb43407c109fc0"]]},{"id":"def9da95c9a7cb51","type":"function","z":"a1ed8ea56c7ba1f9","name":"msg window","func":"msg.filter = { \"in\": { linkedClass: \"window\" } };\nmsg.result = \"windows\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":120,"wires":[["94ada1c824b173ea"]]},{"id":"be6af0e73945f3a5","type":"function","z":"a1ed8ea56c7ba1f9","name":"msg window area","func":"msg.filter = { \"in\": { linkedClass: \"window\", linkedArea: msg.linkedArea } };\nmsg.result = \"windows\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":120,"wires":[["94ada1c824b173ea"]]},{"id":"8fae079033bf1473","type":"subflow:ea5b93cde6b1bf0a","z":"a1ed8ea56c7ba1f9","name":"","x":830,"y":120,"wires":[["30e3717d3d442db0"]]},{"id":"d57e83b8324fa9ac","type":"function","z":"a1ed8ea56c7ba1f9","name":"msg ventilation","func":"msg.filter = { \"in\": { linkedClass: \"ventilation\" } };\nmsg.result = \"ventilations\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":500,"wires":[["ac697963b3d0aa2f"]]},{"id":"ac697963b3d0aa2f","type":"subflow:ea5b93cde6b1bf0a","z":"a1ed8ea56c7ba1f9","name":"","x":730,"y":500,"wires":[["b4b6fe6ded8b1be2"]]},{"id":"0ae75a5ce9468cf3","type":"api-current-state","z":"a1ed8ea56c7ba1f9","name":"module_temperature on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_temperature","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":330,"y":420,"wires":[["0d159373699dfb13"],[]]},{"id":"be89ec4e23a228dc","type":"api-current-state","z":"a1ed8ea56c7ba1f9","name":"module_temperature on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_temperature","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":350,"y":500,"wires":[["d57e83b8324fa9ac"],[]]},{"id":"b4b6fe6ded8b1be2","type":"link out","z":"a1ed8ea56c7ba1f9","name":"link out 406","mode":"link","links":["e9bf7751a9dd827b"],"x":835,"y":500,"wires":[]},{"id":"e9bf7751a9dd827b","type":"link in","z":"a1ed8ea56c7ba1f9","name":"link in 414","links":["b4b6fe6ded8b1be2"],"x":55,"y":560,"wires":[["6c113e8d1373c341"]]},{"id":"94ada1c824b173ea","type":"api-current-state","z":"a1ed8ea56c7ba1f9","name":"module_temperature on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_temperature","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":630,"y":120,"wires":[["8fae079033bf1473"],[]]},{"id":"b769fe8f7935819f","type":"inject","z":"a1ed8ea56c7ba1f9","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":160,"y":620,"wires":[["030c7e7e1ad90e4f","e2c8af6d312339d6","a277572fedc20b90","29dde0ab409617d0"]]},{"id":"030c7e7e1ad90e4f","type":"api-get-history","z":"a1ed8ea56c7ba1f9","name":"input_number.temp_ext","server":"66876666.3e6288","version":0,"startdate":"2023-03-12T00:00:00+00:00","enddate":"2023-03-14T00:00:00+00:00","entityid":"input_number.temp_ext","entityidtype":"is","useRelativeTime":false,"relativeTime":"","flatten":true,"output_type":"array","output_location_type":"msg","output_location":"payload","x":350,"y":620,"wires":[["e17dfc3f7cd68f30"]]},{"id":"bbce824ce485a58b","type":"debug","z":"a1ed8ea56c7ba1f9","name":"debug 1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":680,"y":620,"wires":[]},{"id":"e17dfc3f7cd68f30","type":"function","z":"a1ed8ea56c7ba1f9","name":"average","func":"let count = 0;\nlet sum = 0;\n\nfor (let entity_id of msg.payload) {\n    sum += parseFloat(entity_id.state);\n    count++;\n}\n\nmsg.value = sum / count;\nmsg.meanValue = msg.value;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":620,"wires":[["bbce824ce485a58b"]]},{"id":"e2c8af6d312339d6","type":"api-get-history","z":"a1ed8ea56c7ba1f9","name":"input_number.temp_ext","server":"66876666.3e6288","version":0,"startdate":"2023-03-12T00:00:00+00:00","enddate":"2023-03-14T00:00:00+00:00","entityid":"input_number.temp_int_1","entityidtype":"is","useRelativeTime":false,"relativeTime":"","flatten":true,"output_type":"array","output_location_type":"msg","output_location":"payload","x":350,"y":680,"wires":[["3115416c99a2cf5d"]]},{"id":"3115416c99a2cf5d","type":"function","z":"a1ed8ea56c7ba1f9","name":"average","func":"let count = 0;\nlet sum = 0;\n\nfor (let entity_id of msg.payload) {\n    sum += parseFloat(entity_id.state);\n    count++;\n}\n\nmsg.value = sum / count;\nmsg.meanValue = msg.value;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":680,"wires":[["bbce824ce485a58b"]]},{"id":"a277572fedc20b90","type":"api-get-history","z":"a1ed8ea56c7ba1f9","name":"input_number.temp_ext","server":"66876666.3e6288","version":0,"startdate":"2023-03-12T00:00:00+00:00","enddate":"2023-03-14T00:00:00+00:00","entityid":"input_number.humidity_ext","entityidtype":"is","useRelativeTime":false,"relativeTime":"","flatten":true,"output_type":"array","output_location_type":"msg","output_location":"payload","x":350,"y":740,"wires":[["8d927f046c6252fb"]]},{"id":"8d927f046c6252fb","type":"function","z":"a1ed8ea56c7ba1f9","name":"average","func":"let count = 0;\nlet sum = 0;\n\nfor (let entity_id of msg.payload) {\n    sum += parseFloat(entity_id.state);\n    count++;\n}\n\nmsg.value = sum / count;\nmsg.meanValue = msg.value;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":740,"wires":[["bbce824ce485a58b"]]},{"id":"29dde0ab409617d0","type":"api-get-history","z":"a1ed8ea56c7ba1f9","name":"input_number.temp_ext","server":"66876666.3e6288","version":0,"startdate":"2023-03-12T00:00:00+00:00","enddate":"2023-03-14T00:00:00+00:00","entityid":"input_number.humidity_int_1","entityidtype":"is","useRelativeTime":false,"relativeTime":"","flatten":true,"output_type":"array","output_location_type":"msg","output_location":"payload","x":350,"y":800,"wires":[["379097a32b5bde70"]]},{"id":"379097a32b5bde70","type":"function","z":"a1ed8ea56c7ba1f9","name":"average","func":"let count = 0;\nlet sum = 0;\n\nfor (let entity_id of msg.payload) {\n    sum += parseFloat(entity_id.state);\n    count++;\n}\n\nmsg.value = sum / count;\nmsg.meanValue = msg.value;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":800,"wires":[["bbce824ce485a58b"]]},{"id":"66b809d75014e699","type":"catch","z":"ab914a2a493ebbf5","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["103b5b2b1d5427e7"]]},{"id":"f63c64627a69e81d","type":"subflow:ad3b29a5dd67898f","z":"ab914a2a493ebbf5","name":"","x":460,"y":40,"wires":[]},{"id":"103b5b2b1d5427e7","type":"change","z":"ab914a2a493ebbf5","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Covers","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["f63c64627a69e81d"]]},{"id":"e3c8c262ba8d76ac","type":"server-state-changed","z":"ab914a2a493ebbf5","name":"sun","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sun.sun","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":false,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"}],"x":90,"y":120,"wires":[["d9f739b9cbc83e44"]]},{"id":"f12c94f0300ac8f9","type":"function","z":"ab914a2a493ebbf5","name":"sun calc","func":"let sunAngleCoverOff = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_cover_off\"].state);\nlet sunAngleCoverOn = parseInt(global.get('homeassistant').homeAssistant.states[\"input_number.sun_angle_cover_on\"].state);\nlet newStateElevation = msg.data.new_state.attributes.elevation;\nlet oldStateElevation = msg.data.old_state.attributes.elevation;\n\nif (oldStateElevation <= sunAngleCoverOn && sunAngleCoverOn <= newStateElevation) {\n    msg.value = 100;\n    return msg;\n} else if (oldStateElevation >= sunAngleCoverOff && sunAngleCoverOff >= newStateElevation) {\n    msg.value = 0;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":120,"wires":[["dace57953f1c7f8a"]]},{"id":"dace57953f1c7f8a","type":"function","z":"ab914a2a493ebbf5","name":"msg covers","func":"msg.filter = { \"in\": { linkedClass: \"cover\" } };\nmsg.result = \"covers\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":120,"wires":[["75b53c6f7fa9db4c"]]},{"id":"75b53c6f7fa9db4c","type":"subflow:ea5b93cde6b1bf0a","z":"ab914a2a493ebbf5","name":"","x":730,"y":120,"wires":[["fd18f3ab2a134595"]]},{"id":"591f139254d874b3","type":"api-call-service","z":"ab914a2a493ebbf5","name":"set covers pct","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":880,"y":180,"wires":[[]]},{"id":"ff8917fbe0e53ade","type":"link in","z":"ab914a2a493ebbf5","name":"link in 420","links":["b7ac33720a1cbe49"],"x":55,"y":320,"wires":[["d79e1a2d57bb756f"]]},{"id":"edcc162b29c8a8af","type":"function","z":"ab914a2a493ebbf5","name":"cover calc","func":"let timeToAeration = \"timeToAeration\" in msg ? msg.timeToAeration : 0;\nlet timeToClose = \"timeToClose\" in msg ? msg.timeToClose : 0;\nlet timeToOpen = \"timeToOpen\" in msg ? msg.timeToOpen : 0;\nlet oldState = msg.oldState;\nlet newState = msg.newState;\n\nif (msg.linkedDevice != \"\") {\n    msg.entity_id = msg.linkedDevice;\n    if (newState == 100) {\n        msg.service = \"open_cover\";\n        msg.delay = (timeToOpen + timeToAeration) * 1000;\n    } else if (newState == 0) {\n        msg.service = \"close_cover\";\n        msg.delay = (timeToClose + timeToAeration) * 1000;\n    } else if (newState == 1) {\n        if (oldState == 0) {\n            msg.service = \"open_cover\";\n            msg.delay = (timeToAeration) * 1000;\n        } else {\n            msg.service = \"close_cover\";\n            msg.delay = (oldState + 1) * timeToClose * 10 + timeToAeration * 1000;\n            msg.nextService = \"open_cover\";\n            msg.nextDelay = (timeToAeration) * 1000;\n        }\n    } else {\n        msg.delay = oldState == 0 ? timeToAeration : 0;\n        if (oldState < newState) {\n            msg.service = \"open_cover\";\n            msg.delay += (newState - oldState) * timeToOpen * 10;\n        } else {\n            msg.service = \"close_cover\";\n            msg.delay += (oldState - newState) * timeToClose * 10;\n        }\n    }\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":320,"wires":[["cfff980d5a10bb6e"]]},{"id":"cfff980d5a10bb6e","type":"api-call-service","z":"ab914a2a493ebbf5","name":"set cover","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"cover","service":"{{service}}","areaId":[],"deviceId":[],"entityId":["{{entity_id}}"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":580,"y":320,"wires":[["4cbf989b56c4b52f"]]},{"id":"8453250c55071464","type":"api-call-service","z":"ab914a2a493ebbf5","name":"stop cover","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"cover","service":"stop_cover","areaId":[],"deviceId":[],"entityId":["{{entity_id}}"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":790,"y":320,"wires":[["2d2a95039320e5b1"]]},{"id":"4cbf989b56c4b52f","type":"delay","z":"ab914a2a493ebbf5","name":"","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":675,"y":320,"wires":[["8453250c55071464"]],"l":false},{"id":"2d2a95039320e5b1","type":"function","z":"ab914a2a493ebbf5","name":"next calc","func":"if (\"nextService\" in msg && \"nextDelay\" in msg) {\n    msg.service = msg.nextService;\n    msg.delay = msg.nextDelay;\n\n    delete msg.nextService;\n    delete msg.nextDelay;\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":320,"wires":[["c1e32b8d5dd68fbf"]]},{"id":"c1e32b8d5dd68fbf","type":"link out","z":"ab914a2a493ebbf5","name":"link out 414","mode":"link","links":["06c8167483650701"],"x":1035,"y":320,"wires":[]},{"id":"06c8167483650701","type":"link in","z":"ab914a2a493ebbf5","name":"link in 421","links":["c1e32b8d5dd68fbf"],"x":475,"y":320,"wires":[["cfff980d5a10bb6e"]]},{"id":"d9f739b9cbc83e44","type":"api-current-state","z":"ab914a2a493ebbf5","name":"module_cover on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_cover","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":250,"y":120,"wires":[["f12c94f0300ac8f9"],[]]},{"id":"d79e1a2d57bb756f","type":"api-current-state","z":"ab914a2a493ebbf5","name":"module_covers on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_cover","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":200,"y":320,"wires":[["edcc162b29c8a8af"],[]]},{"id":"0a74c79fa2b26337","type":"server-state-changed","z":"ab914a2a493ebbf5","name":"modules_covers","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_cover","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":460,"wires":[["b930ded2b8ae45b5"]]},{"id":"b930ded2b8ae45b5","type":"function","z":"ab914a2a493ebbf5","name":"notification","func":"msg.notification_id = \"module_cover\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"warning\";\n    msg.title = \"Module volet roulant: Désactivé\";\n    msg.message = \"Module volet roulant désactivé, les volets roulants ne sont plus controlées\";\n    msg.zone = [\"inside\", \"outside\"];\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":460,"wires":[["47e4fe779b75e0dc"]]},{"id":"47e4fe779b75e0dc","type":"link out","z":"ab914a2a493ebbf5","name":"link out 415","mode":"link","links":["4fcc3b49d98a2c1f"],"x":395,"y":460,"wires":[]},{"id":"fc248d2e80a1c866","type":"function","z":"ab914a2a493ebbf5","name":"get alarms","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet persons = global.get(\"persons\") || {};\nlet cover = msg.payload.data.entity_id;\nlet value = msg.payload.data.value;\n\nlet personsKeys = Object.keys(persons);\nfor (let key of personsKeys) {\n    let personAlarmClockCovers = key in ha_configuration && \"alarmClock\" in ha_configuration[key]\n        && \"linkedCovers\" in ha_configuration[key].alarmClock ? ha_configuration[key].alarmClock.linkedCovers : [];\n    if (!(persons[key].alarm.split(\" \")[0] == msg.currentDate && personAlarmClockCovers.includes(cover)) && value == 100) {\n        return msg;\n    } else if (value == 0) {\n        return msg;\n    }\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":180,"wires":[["591f139254d874b3"]]},{"id":"fd18f3ab2a134595","type":"link out","z":"ab914a2a493ebbf5","name":"link out 417","mode":"link","links":["f17e11ed7c016f8b","1f0132a2fbee311c"],"x":835,"y":120,"wires":[]},{"id":"f17e11ed7c016f8b","type":"link in","z":"ab914a2a493ebbf5","name":"link in 423","links":["fd18f3ab2a134595"],"x":55,"y":180,"wires":[["138be8f8608ac91c"]]},{"id":"4744f099b52ffeb9","type":"subflow:e6ac576fb4598283","z":"ab914a2a493ebbf5","name":"","x":330,"y":180,"wires":[["22c5387bc538d0b3"],["74a232c0c54bfcd0"]]},{"id":"138be8f8608ac91c","type":"function","z":"ab914a2a493ebbf5","name":"covers calc","func":"let covers = msg.covers;\nlet state = msg.state;\nlet msgs = [];\n\nfor (let cover of covers) {\n    msgs.push({\n        payload: {\n            data: {\n                entity_id: cover.entity_id, value: msg.value\n            }\n        }\n    });\n}\n\nif (msgs.length != 0) {\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":180,"wires":[["4744f099b52ffeb9"]]},{"id":"1f0132a2fbee311c","type":"link in","z":"ab914a2a493ebbf5","name":"link in 426","links":["fd18f3ab2a134595"],"x":55,"y":240,"wires":[["eaec0d325d79696a"]]},{"id":"a861d8b07880a2e2","type":"function","z":"ab914a2a493ebbf5","name":"notification","func":"let covers = msg.covers;\n\nif (covers.length != 0) {\n    msg.notification_id = \"empty_home_cover_status\";\n    msg.zone = [\"inside\", \"outside\"];\n    msg.alertType = \"success\";\n    msg.title = \"Volets: \" + (msg.value == 100 ? \"Ouverture\" : \"Fermeture\");\n    msg.sendMobile = true;\n    let endTxt = \" pendant votre absence\";\n    if (msg.value == 100) {\n        msg.message = (covers.length == 1 ? \"Le volet s'est ouvert\" : \"Les volets ce sont ouverts\") + endTxt;\n        return msg;\n    } else if (msg.value == 0) {\n        msg.message = (covers.length == 1 ? \"Le volet s'est fermé\" : \"Les volets ce sont fermés\") + endTxt;\n        return msg;\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":240,"wires":[["625506e86313414c"]]},{"id":"625506e86313414c","type":"link out","z":"ab914a2a493ebbf5","name":"link out 421","mode":"link","links":["4fcc3b49d98a2c1f"],"x":655,"y":240,"wires":[]},{"id":"eaec0d325d79696a","type":"subflow:e6ac576fb4598283","z":"ab914a2a493ebbf5","name":"","x":170,"y":240,"wires":[[],["f11f87671de9fb2a"]]},{"id":"f32dd6019bb04292","type":"server-state-changed","z":"ab914a2a493ebbf5","name":"in_home_zone","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_home_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":400,"wires":[["249f4fb1ec363df2"],[]]},{"id":"249f4fb1ec363df2","type":"function","z":"ab914a2a493ebbf5","name":"notification","func":"msg.notification_id = \"empty_home_cover_status\";\nmsg.dismiss = true;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":400,"wires":[["b968a370a50879c2"]]},{"id":"b968a370a50879c2","type":"link out","z":"ab914a2a493ebbf5","name":"link out 422","mode":"link","links":["4fcc3b49d98a2c1f"],"x":395,"y":400,"wires":[]},{"id":"f11f87671de9fb2a","type":"moment","z":"ab914a2a493ebbf5","name":"","topic":"","input":"","inputType":"date","inTz":"ETC/UTC","adjAmount":"0","adjType":"hours","adjDir":"add","format":"HH:mm","locale":"C","output":"currentTime","outputType":"msg","outTz":"Europe/Paris","x":360,"y":240,"wires":[["a861d8b07880a2e2"]]},{"id":"22c5387bc538d0b3","type":"moment","z":"ab914a2a493ebbf5","name":"","topic":"","input":"","inputType":"date","inTz":"ETC/UTC","adjAmount":"0","adjType":"hours","adjDir":"add","format":"YYYY-MM-DD","locale":"C","output":"currentDate","outputType":"msg","outTz":"Europe/Paris","x":520,"y":180,"wires":[["fc248d2e80a1c866"]]},{"id":"77e530deb7bf581d","type":"catch","z":"7cc0f49198f44c93","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["5a7b5ddea88e190c"]]},{"id":"5328d12699267234","type":"link out","z":"7cc0f49198f44c93","name":"link out 142","mode":"link","links":["fb3e440fb6fa75d1","33e4417d398d20b0"],"x":695,"y":240,"wires":[]},{"id":"1d3537cefa120188","type":"link out","z":"7cc0f49198f44c93","name":"link out 143","mode":"link","links":["16f09e4745541810","5eb22229d96c4be2","8b4c397cb104a0a5","ad3507cfc053e231","04a669a83b903917","8b5af871c510692d","016a653e4d6cfb5c"],"x":1525,"y":240,"wires":[]},{"id":"1390d89f491972da","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":1190,"y":360,"wires":[]},{"id":"d5ba672c9bc39474","type":"link in","z":"7cc0f49198f44c93","name":"get water_heat","links":[],"x":55,"y":360,"wires":[["dc9eeb3dac45fda9"]]},{"id":"564731f7fef8270e","type":"server-state-changed","z":"7cc0f49198f44c93","name":"in_big_zone","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_big_zone","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"notification","propertyType":"msg","value":"hc_proximity","valueType":"str"}],"x":390,"y":180,"wires":[["4d07ec3b53587064"],["63743b66f2e16afd"]]},{"id":"8b5af871c510692d","type":"link in","z":"7cc0f49198f44c93","name":"link in 177","links":["f04323dbf972a68a","1d3537cefa120188"],"x":55,"y":300,"wires":[["802624bc629f0673"]]},{"id":"8ed07ac3f17dcc4b","type":"looptimer","z":"7cc0f49198f44c93","duration":"1","units":"Hour","maxloops":"24","maxtimeout":"24","maxtimeoutunits":"Hour","name":"","x":350,"y":300,"wires":[["3fb0878d2d4a0cea"],[]]},{"id":"3fb0878d2d4a0cea","type":"function","z":"7cc0f49198f44c93","name":"delay","func":"let waterHeatPct = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_pct\"].state) / 100;\n\nif (msg.delay != 0) {\n    msg.delay = waterHeatPct == 1 ? 59 : waterHeatPct * 60;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":300,"wires":[["a967506670ea067a"]]},{"id":"8ef14a70ba1a7d3f","type":"stoptimer-varidelay","z":"7cc0f49198f44c93","duration":"0","durationType":"num","units":"Minute","payloadtype":"num","payloadval":"0","name":"","reporting":"none","persist":false,"ignoretimerpass":false,"x":880,"y":300,"wires":[["6378bc17a78a57a3"],[],[]]},{"id":"a967506670ea067a","type":"api-current-state","z":"7cc0f49198f44c93","name":"in_big_zone ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.in_big_zone","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":640,"y":300,"wires":[["810176c80762139a","6eef9586104aaabd"],[]]},{"id":"802624bc629f0673","type":"change","z":"7cc0f49198f44c93","name":"stop","rules":[{"t":"set","p":"payload","pt":"msg","to":"stop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":150,"y":300,"wires":[["8ed07ac3f17dcc4b","8ef14a70ba1a7d3f"]]},{"id":"3c7ed0693727de58","type":"subflow:ad3b29a5dd67898f","z":"7cc0f49198f44c93","name":"","x":460,"y":40,"wires":[]},{"id":"5a7b5ddea88e190c","type":"change","z":"7cc0f49198f44c93","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Devices","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["3c7ed0693727de58"]]},{"id":"9cbe78b2241026d2","type":"link out","z":"7cc0f49198f44c93","name":"link out 209","mode":"link","links":["4fcc3b49d98a2c1f"],"x":1475,"y":360,"wires":[]},{"id":"af309add2f8d1c70","type":"function","z":"7cc0f49198f44c93","name":"prepare devices","func":"let devices = msg.waterHeats;\nlet msgs = [];\n\nfor (let device of devices) {\n    if (msg.state != device.state) {\n        msgs.push({\n            state: msg.state,\n            entity_id: device.entity_id\n        });\n    }\n}\n\nmsg.notification_id = \"water_heat\";\nif (msg.state == \"on\" && msgs.length > 0) {\n    msg.alertType = \"success\";\n    msg.zone = [\"inside\", \"outside\"];\n    if (msg.notification == \"hc_proximity\") {\n        msg.title = \"Proximité : Dans la grande zone\";\n        msg.message = \"Le chauffe eau est allumé \" + msg.delay + \" min\";\n        msg.sendMobile = true;\n    } else if (msg.notification == \"hc_on\") {\n        msg.title = \"Planification : Heures creuses\";\n        msg.message = \"Le chauffe eau est allumé\";\n        msg.sendMobile = false;\n    } else if (msg.notification == \"hc_manual\") {\n        msg.title = \"Action manuelle\";\n        msg.message = \"Le chauffe eau est allumé pendant \" + msg.delay + \" min\";\n        msg.sendMobile = true;\n    } else if (msg.notification == \"module_desactivated\") {\n        msg.title = \"Module Chauffe eau désactivé\";\n        msg.message = \"Le chauffe eau ne se coupera plus\";\n        msg.sendMobile = false;\n    }\n} else {\n    msg.dismiss = true;\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1000,"y":360,"wires":[["1390d89f491972da"]]},{"id":"8132ce34d09fd4a2","type":"link out","z":"7cc0f49198f44c93","name":"link out 213","mode":"link","links":["fb3e440fb6fa75d1","46eecb027fc72783","016a653e4d6cfb5c"],"x":895,"y":180,"wires":[]},{"id":"46eecb027fc72783","type":"link in","z":"7cc0f49198f44c93","name":"link in 228","links":["f04323dbf972a68a","8132ce34d09fd4a2"],"x":755,"y":300,"wires":[["8ef14a70ba1a7d3f"]]},{"id":"495d17d52fed7d90","type":"link out","z":"7cc0f49198f44c93","name":"link out 214","mode":"link","links":["16f09e4745541810","5eb22229d96c4be2","8b4c397cb104a0a5","ad3507cfc053e231","3cb4d0986723f6b6","016a653e4d6cfb5c"],"x":1115,"y":300,"wires":[]},{"id":"6378bc17a78a57a3","type":"change","z":"7cc0f49198f44c93","name":"off","rules":[{"t":"set","p":"state","pt":"msg","to":"off","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1030,"y":300,"wires":[["495d17d52fed7d90","5a23ad382e31be62"]]},{"id":"33e4417d398d20b0","type":"link in","z":"7cc0f49198f44c93","name":"link in 229","links":["f04323dbf972a68a","5328d12699267234"],"x":235,"y":300,"wires":[["8ed07ac3f17dcc4b"]]},{"id":"9511aad44383fe41","type":"delay","z":"7cc0f49198f44c93","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":635,"y":240,"wires":[["5328d12699267234"]],"l":false},{"id":"4d07ec3b53587064","type":"function","z":"7cc0f49198f44c93","name":"get duration","func":"msg.delay = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.water_heat_duration\"].state);\nmsg.state = \"on\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":180,"wires":[["fe63a46e1710352f"]]},{"id":"4460b9255c4c1c04","type":"server-state-changed","z":"7cc0f49198f44c93","name":"activate manual water","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.water_heat_temp","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"notification","propertyType":"msg","value":"hc_manual","valueType":"str"}],"x":140,"y":180,"wires":[["55f2bb860de7bb22"],["508ff684287a8576"]]},{"id":"71225fcf4e1afe84","type":"link out","z":"7cc0f49198f44c93","name":"link out 233","mode":"link","links":["b88cb97c0f0d72fe","14b33d911438f95c"],"x":945,"y":180,"wires":[]},{"id":"750c28d389fe672b","type":"link in","z":"7cc0f49198f44c93","name":"link in 253","links":["cb44cde26ee31290","33d0fdd326f277f0"],"x":55,"y":240,"wires":[["f52337efc5c5cf6d"]]},{"id":"14b33d911438f95c","type":"link in","z":"7cc0f49198f44c93","name":"link in 254","links":["cb44cde26ee31290","33d0fdd326f277f0","508ff684287a8576","71225fcf4e1afe84"],"x":755,"y":240,"wires":[["ac7b6f6b29a6c98b"]]},{"id":"10910321b9bfc019","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":950,"y":480,"wires":[]},{"id":"2c41d0af87e204e7","type":"link in","z":"7cc0f49198f44c93","name":"link in 256","links":["cb44cde26ee31290","33d0fdd326f277f0"],"x":55,"y":480,"wires":[["798f47e061046024"]]},{"id":"32e605dd29682350","type":"function","z":"7cc0f49198f44c93","name":"prepare devices","func":"let ventilations = msg.ventilations;\nlet msgs = [];\n\nfor (let ventilation of ventilations) {\n    let state = global.get(\"homeassistant\").homeAssistant.states[ventilation.entity_id].state;\n    let calculatedState = calculate(ventilation);\n    if (state != calculatedState) {\n        ventilation.currentTime = msg.currentTime;\n        ventilation.state = calculatedState;\n        msgs.push({ ...ventilation });\n    }\n}\n\nreturn [msgs];\n\nfunction calculate(ventilation) {\n    for (let i = 0; i < ventilation.onTime.length; i++) {\n        if (ventilation.onTime[i] == msg.currentTime) {\n            return \"on\";\n        } else if (ventilation.offTime[i] == msg.currentTime) {\n            return \"off\";\n        }\n    }\n    return ventilation.state;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":760,"y":480,"wires":[["50e2a98ed86b6e81","10910321b9bfc019"]]},{"id":"50e2a98ed86b6e81","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"msg.notification_id = \"vmc_\" + msg.linkedArea;\nif (msg.state == \"on\") {\n    msg.alertType = \"success\";\n    msg.title = \"Ventilation: Ventilation planifiée\";\n    msg.message = \"La ventilation \" + msg.alias + \" est active\";\n    msg.zone = [\"inside\", \"outside\"];\n    msg.sendMobile = false;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1130,"y":480,"wires":[["41c03bb8a071fda7"]]},{"id":"41c03bb8a071fda7","type":"link out","z":"7cc0f49198f44c93","name":"link out 259","mode":"link","links":["4fcc3b49d98a2c1f"],"x":1235,"y":480,"wires":[]},{"id":"b6536d45be534fe7","type":"comment","z":"7cc0f49198f44c93","name":"linkedClass : ventilation","info":"","x":140,"y":420,"wires":[]},{"id":"4d4b6a5f9d5a991b","type":"comment","z":"7cc0f49198f44c93","name":"linkedClass : water_heat","info":"","x":150,"y":120,"wires":[]},{"id":"fbc1c0ac1d7bec76","type":"link in","z":"7cc0f49198f44c93","name":"link in 408","links":["0489992ff2313771","1849c3d6ff1ccfb0","26abb5af0922722f","cb44cde26ee31290","e2084ffb49335b77"],"x":65,"y":660,"wires":[["2b4fd97f1ef896db"]]},{"id":"bd500f79237a0f09","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":510,"y":660,"wires":[]},{"id":"d7da59904a6f6d41","type":"subflow:ea5b93cde6b1bf0a","z":"7cc0f49198f44c93","name":"","x":350,"y":360,"wires":[["9f73f5befcf08bcc"]]},{"id":"dc9eeb3dac45fda9","type":"function","z":"7cc0f49198f44c93","name":"msg water_heat","func":"msg.filter = { \"in\": { linkedClass: \"water_heat\" } };\nmsg.result = \"waterHeats\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":360,"wires":[["d7da59904a6f6d41"]]},{"id":"b3568d98cc4c1f4b","type":"function","z":"7cc0f49198f44c93","name":"msg ventilation","func":"msg.filter = { \"in\": { linkedClass: \"ventilation\" } };\nmsg.result = \"ventilations\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":480,"wires":[["8bfc0f632798223f"]]},{"id":"8bfc0f632798223f","type":"subflow:ea5b93cde6b1bf0a","z":"7cc0f49198f44c93","name":"","x":590,"y":480,"wires":[["32e605dd29682350"]]},{"id":"508ff684287a8576","type":"link out","z":"7cc0f49198f44c93","name":"link out 401","mode":"link","links":["fb3e440fb6fa75d1","b88cb97c0f0d72fe","14b33d911438f95c"],"x":275,"y":180,"wires":[]},{"id":"bfb175b03433a260","type":"comment","z":"7cc0f49198f44c93","name":"controle_device","info":"","x":120,"y":600,"wires":[]},{"id":"2b4fd97f1ef896db","type":"function","z":"7cc0f49198f44c93","name":"control_devices","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet controlDevices = [];\nlet msgs = [];\n\nif (\"control_device\" in ha_configuration) {\n    if (\"control_device\" in msg) {\n        controlDevices = controlDevices.concat(msg.control_device);\n    } else if (\"time\" in msg && \"time\" in ha_configuration.control_device) {\n        controlDevices = controlDevices.concat(ha_configuration.control_device.time);\n    } else if (\"linkedClass\" in msg && \"linkedArea\" in msg) {\n        let globalClass = \"linkedClass_\" + msg.linkedClass + \"_\" + msg.linkedArea;\n        if (globalClass in ha_configuration.control_device) {\n            controlDevices = controlDevices.concat(ha_configuration.control_device[globalClass]);\n        }\n    }\n}\n\nfor (let controlDevice of controlDevices) {\n    if (logicalOperator(controlDevice[\"if\"])) {\n        for (let device of controlDevice[\"then\"]) {\n            if (typeof device[0] == \"string\" && typeof device[1] == \"object\") {\n                let result = logicalOperator(device[0]);\n                if (result && device.length >= 2) {\n                    sendSubDevice(device[1]);\n                } else if (!result && device.length == 3) {\n                    sendSubDevice(device[2]);\n                }\n            } else {\n                msg.subdevice = device;\n                sendSubDevice(device);\n            }\n        }\n    }\n}\n\nreturn [msgs];\n\nfunction sendSubDevice(subDevices) {\n    for (let subDevice of subDevices) {\n        let state = global.get(\"homeassistant\").homeAssistant.states[subDevice[0]].state;\n        if (state != subDevice[1]) {\n            msgs.push({\n                entity_id: subDevice[0],\n                state: subDevice[1],\n                delay: subDevice.length == 3 ? subDevice[2] * 1000 : 0\n            });\n        }\n    }\n}\n\nfunction logicalOperator(condition) {\n    let resultOR = false;\n    if (condition != \"\") {\n        let operatorORSplit = condition.split(\"OR\");\n        let countORLength = operatorORSplit.length - 1;\n        for (let i = 0; i < operatorORSplit.length; i++) {\n            let operatorANDSplit = operatorORSplit[i].split(\"AND\");\n            let resultAND = true;\n            for (let i = 0; i < operatorANDSplit.length; i++) {\n                let operatorAND = operatorANDSplit[i];\n                let csplit = operatorAND.trim().split(\" \").slice(0, 2);\n                csplit.push(operatorAND.substring(operatorAND.indexOf(csplit[1]) + csplit[1].length).trim());\n                resultAND = resultAND && comparisonOperator(getHaState(csplit[0]), csplit[1], csplit[2]);\n                if (countORLength == i && !resultAND) {\n                    return resultAND;\n                }\n            }\n            resultOR = resultOR || resultAND;\n        }\n    }\n    return resultOR;\n}\n\nfunction comparisonOperator(haState, operator, userState) {\n    userState = isNaN(userState) ? userState : parseFloat(userState);\n    let result = false;\n    if (operator == \"==\") {\n        result = haState == userState;\n    } else if (operator == \"!=\") {\n        result = haState != userState;\n    } else if (operator == \"<\") {\n        result = haState < userState;\n    } else if (operator == \"<=\") {\n        result = haState <= userState;\n    } else if (operator == \">\") {\n        result = haState > userState;\n    } else if (operator == \">=\") {\n        result = haState >= userState;\n    }\n    return result;\n}\n\nfunction getHaState(haState) {\n    if (haState.startsWith(\"global.\")) {\n        let ha_state_split = haState.replace(\"global.\", \"\").split(\".\");\n        let gbl_ha_state = global.get(ha_state_split[0]);\n        for (let i = 1; i < ha_state_split.length; i++) {\n            gbl_ha_state = gbl_ha_state[ha_state_split[i]];\n        }\n        return isNaN(gbl_ha_state) ? gbl_ha_state : parseFloat(gbl_ha_state);\n    } else if (haState.startsWith(\"time\")) {\n        let date = new Date();\n        let hours = date.getHours() < 10 ? \"0\" + date.getHours() : date.getHours();\n        let minutes = date.getMinutes() < 10 ? \"0\" + date.getMinutes() : date.getMinutes();\n        return hours + \":\" + minutes;\n    } else {\n        let ha_state_split = haState.split(\".\");\n        let gbl_ha_state = global.get(\"homeassistant\").homeAssistant.states[ha_state_split[0] + \".\" + ha_state_split[1]];\n        for (let i = 2; i < ha_state_split.length; i++) {\n            gbl_ha_state = gbl_ha_state[ha_state_split[i]];\n        }\n        return isNaN(gbl_ha_state) ? gbl_ha_state : parseFloat(gbl_ha_state);\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":660,"wires":[["ef2536cf856a81d2"]]},{"id":"ef2536cf856a81d2","type":"delay","z":"7cc0f49198f44c93","name":"","pauseType":"delayv","timeout":"0","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":340,"y":660,"wires":[["bd500f79237a0f09"]]},{"id":"9f73f5befcf08bcc","type":"link out","z":"7cc0f49198f44c93","name":"","mode":"return","links":[],"x":455,"y":360,"wires":[]},{"id":"016a653e4d6cfb5c","type":"link in","z":"7cc0f49198f44c93","name":"link in 411","links":["641e7efbbd5cdefa","01f99ef76019f619","b0821d7f1d29c02d","9b218c811c46b9ad","8132ce34d09fd4a2","495d17d52fed7d90","1d3537cefa120188"],"x":715,"y":360,"wires":[["4e200f68fceefd6c"]]},{"id":"53070d8ace15fa37","type":"link call","z":"7cc0f49198f44c93","name":"water_heat","links":["d5ba672c9bc39474"],"linkType":"static","timeout":"30","x":410,"y":240,"wires":[["1ba444bb1a455e18"]]},{"id":"4e200f68fceefd6c","type":"link call","z":"7cc0f49198f44c93","name":"water_heat","links":["d5ba672c9bc39474"],"linkType":"static","timeout":"30","x":830,"y":360,"wires":[["af309add2f8d1c70","5798011c9190ba75"]]},{"id":"1ba444bb1a455e18","type":"function","z":"7cc0f49198f44c93","name":"on","func":"if (\"waterHeats\" in msg && msg.waterHeats.length != 0 && msg.waterHeats[0].onTime.includes(msg.currentTime)) {\n    msg.state = \"on\";\n    msg.notification = \"hc_on\";\n    delete msg.waterHeats;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":240,"wires":[["9511aad44383fe41"]]},{"id":"216fa3eeb9b6fb2d","type":"link call","z":"7cc0f49198f44c93","name":"water_heat","links":["d5ba672c9bc39474"],"linkType":"static","timeout":"30","x":1300,"y":240,"wires":[["ad355a82914f17b0"]]},{"id":"ad355a82914f17b0","type":"function","z":"7cc0f49198f44c93","name":"off","func":"if (\"waterHeats\" in msg && msg.waterHeats.length != 0 && \"currentTime\" in msg && msg.waterHeats[0].offTime.includes(msg.currentTime)) {\n    return send();\n} else if (\"waterHeats\" in msg && msg.waterHeats.length != 0 && !(\"currentTime\" in msg)) {\n    return send();\n}\n\nfunction send() {\n    msg.state = \"off\";\n    msg.notification = \"hc_off\";\n    delete msg.waterHeats;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1440,"y":240,"wires":[["1d3537cefa120188"]]},{"id":"fe63a46e1710352f","type":"api-current-state","z":"7cc0f49198f44c93","name":"module_water_heat on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_water_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":750,"y":180,"wires":[["8132ce34d09fd4a2"],[]]},{"id":"798f47e061046024","type":"api-current-state","z":"7cc0f49198f44c93","name":"module_temperature on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_temperature","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":210,"y":480,"wires":[["b3568d98cc4c1f4b"],[]]},{"id":"e142d4fca5be15b6","type":"server-state-changed","z":"7cc0f49198f44c93","name":"module_temperature","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_temperature","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":130,"y":540,"wires":[["0112252634f2957a","43a514d60ce67875"]]},{"id":"0112252634f2957a","type":"function","z":"7cc0f49198f44c93","name":"msg ventilation","func":"let inverse = { \"on\": \"off\", \"off\": \"on\" };\nmsg.filter = { \"in\": { linkedClass: \"ventilation\", state: inverse[msg.payload] } };\nmsg.result = \"ventilations\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":540,"wires":[["fad6851779c08551"]]},{"id":"fad6851779c08551","type":"subflow:ea5b93cde6b1bf0a","z":"7cc0f49198f44c93","name":"","x":490,"y":540,"wires":[["6a77bcc53698bdf2"]]},{"id":"6a77bcc53698bdf2","type":"function","z":"7cc0f49198f44c93","name":"prepare devices","func":"let ventilations = msg.ventilations;\nlet msgs = [];\n\nfor (let ventilation of ventilations) {\n    msgs.push({\n        entity_id: ventilation.entity_id,\n        state: \"on\"\n    });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":540,"wires":[["5b591b1daf98840c"]]},{"id":"5b591b1daf98840c","type":"subflow:723d4991c3c87385","z":"7cc0f49198f44c93","name":"","x":850,"y":540,"wires":[]},{"id":"ac7b6f6b29a6c98b","type":"api-current-state","z":"7cc0f49198f44c93","name":"module_water_heat on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_water_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1100,"y":240,"wires":[["216fa3eeb9b6fb2d"],[]]},{"id":"e691d3f9c93a3da2","type":"server-state-changed","z":"7cc0f49198f44c93","name":"module_water_heat","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_water_heat","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"on","valueType":"str"},{"property":"notification","propertyType":"msg","value":"module_desactivated","valueType":"str"}],"x":590,"y":360,"wires":[[],["1b9e84c11edbdbf7"]]},{"id":"f52337efc5c5cf6d","type":"api-current-state","z":"7cc0f49198f44c93","name":"module_water_heat on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_water_heat","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":210,"y":240,"wires":[["53070d8ace15fa37"],[]]},{"id":"dd84142f4b743cdd","type":"server-state-changed","z":"7cc0f49198f44c93","name":"module_water_heat","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_water_heat","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":880,"y":240,"wires":[["ac7b6f6b29a6c98b"],[]]},{"id":"43a514d60ce67875","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"msg.notification_id = \"vmc_\" + msg.linkedArea;\nif (msg.payload == \"off\") {\n    msg.alertType = \"warning\";\n    msg.title = \"Module Ventilation/Température: Désactivé\";\n    msg.message = \"Module température désactivé, la ventilation est active et les alertes températures sont désactivées\";\n    msg.zone = [\"inside\", \"outside\"];\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1030,"y":540,"wires":[["0dc804fe20ae0d4a"]]},{"id":"0dc804fe20ae0d4a","type":"link out","z":"7cc0f49198f44c93","name":"link out 410","mode":"link","links":["4fcc3b49d98a2c1f"],"x":1135,"y":540,"wires":[]},{"id":"bacdad7c8a83142f","type":"function","z":"7cc0f49198f44c93","name":"resend low battery notify","func":"let notifications = global.get(\"notifications\") || {};\nlet notificationsKeys = Object.keys(notifications);\n\nlet lowBatteryCount = 0;\nfor (let notificationsKey of notificationsKeys) {\n    if (notificationsKey.indexOf(\"battery_lvl\") != -1) {\n        lowBatteryCount++;\n    }\n}\n\nif (lowBatteryCount != 0) {\n    if (lowBatteryCount == 1) {\n        msg.speak = \"Vous avez un capteur avec un niveau de batterie faible.\";\n    } else {\n        msg.speak = \"Vous avez plusieurs capteurs avec des niveaux de batterie faible.\";\n    }\n    msg.speak += \" Pour en savoir plus, regardez vos notifications.\";\n    return msg;\n\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":800,"wires":[["56d769fc796ea088"]]},{"id":"21e9ce7eda339017","type":"server-state-changed","z":"7cc0f49198f44c93","name":"in_home_zone","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.in_home_zone","entityidfiltertype":"exact","outputinitially":true,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":800,"wires":[["34c3b26f84cb0b80"],[]]},{"id":"34c3b26f84cb0b80","type":"delay","z":"7cc0f49198f44c93","name":"","pauseType":"delay","timeout":"15","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":280,"y":800,"wires":[["bacdad7c8a83142f"]]},{"id":"62ea62448314d76e","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"let lowBatteryLvl = parseInt(global.get(\"homeassistant\").homeAssistant.states[\"input_number.low_batteries\"].state);\nlet notifications = global.get(\"notifications\") || {};\nlet deviceClass = msg.attributes.device_class;\nlet entityId = msg.entity_id;\n\nif (isNaN(msg.state)) {\n    msg.payload = onOff(msg.state);\n} else if (deviceClass == \"battery\") {\n    msg.state = parseInt(msg.state);\n} else if (deviceClass == \"signal_strength\") {\n    msg.state = lowBatteryLvl + 1;\n}\n\nmsg.notification_id = \"battery_lvl\" + entityId.substring(entityId.lastIndexOf(\"_\"));\nif (!(msg.notification_id in notifications) && msg.state < lowBatteryLvl) {\n    msg.title = \"Alerte batterie:\";\n    if (msg.state == 0) {\n        msg.alertType = \"error\";\n        msg.message = 'Batterie vide \"' + msg.attributes.friendly_name + '\"';\n        msg.speak = \"La batterie du \" + msg.attributes.friendly_name + ' est vide\"';\n    } else {\n        msg.alertType = \"warning\";\n        msg.message = 'Batterie \"' + msg.attributes.friendly_name + '\" en dessous de ' + lowBatteryLvl + \" %\";\n    }\n    msg.zone = [\"inside\", \"outside\"];\n    msg.sendMobile = true;\n    msg.data = {};\n    return msg;\n} else if (msg.notification_id in notifications) {\n    msg.dismiss = true;\n    return msg;\n}\n\nfunction onOff(payload) {\n    return payload == \"off\" ? lowBatteryLvl + 1 : payload == \"on\" ? lowBatteryLvl - 1 : 0;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":860,"wires":[["9efffdb0ef885bb8"]]},{"id":"9efffdb0ef885bb8","type":"link out","z":"7cc0f49198f44c93","name":"link out 207","mode":"link","links":["4fcc3b49d98a2c1f"],"x":775,"y":860,"wires":[]},{"id":"56d769fc796ea088","type":"subflow:dbf17bea6affd2ec","z":"7cc0f49198f44c93","name":"","x":690,"y":800,"wires":[]},{"id":"cac180f98c39b3bd","type":"trigger-state","z":"7cc0f49198f44c93","name":"battery","server":"66876666.3e6288","version":2,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"^sensor.battery_|^sensor.ble_battery_|^sensor.*_bat_level$|^binary_sensor.*battery_low$","entityidfiltertype":"regex","debugenabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is_not","comparatorValueDatatype":"prevEntity","comparatorValue":"state"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.device_class","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"battery"},{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is_not","comparatorValueDatatype":"str","comparatorValue":"None"}],"inputs":0,"outputs":2,"customoutputs":[],"outputinitially":false,"state_type":"str","enableInput":false,"x":90,"y":860,"wires":[["d85024375f516485"],[]]},{"id":"c1c6e9325405504b","type":"server-state-changed","z":"7cc0f49198f44c93","name":"low_batteries","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_number.low_batteries","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[],"x":230,"y":860,"wires":[["964c3792b6ab3e14"]]},{"id":"964c3792b6ab3e14","type":"ha-get-entities","z":"7cc0f49198f44c93","name":"","server":"66876666.3e6288","version":0,"rules":[{"property":"entity_id","logic":"is","value":"^sensor.battery_|^sensor.ble_battery_|^sensor.*_bat_level$|^binary_sensor.*battery_low$","valueType":"re"},{"property":"attributes.device_class","logic":"is","value":"battery","valueType":"str"},{"property":"state","logic":"is_not","value":"None","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":390,"y":860,"wires":[["e42a7b955c643577"]]},{"id":"e42a7b955c643577","type":"function","z":"7cc0f49198f44c93","name":"msg","func":"msg = {...msg.data.event.new_state};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":860,"wires":[["62ea62448314d76e"]]},{"id":"5a1bf07e167f1a1d","type":"comment","z":"7cc0f49198f44c93","name":"Low battery","info":"","x":110,"y":740,"wires":[]},{"id":"5798011c9190ba75","type":"function","z":"7cc0f49198f44c93","name":"notification","func":"let devices = msg.waterHeats;\nlet hasChanged = false;\n\nfor (let device of devices) {\n    if (device.state != msg.state) {\n        hasChanged = true;\n        break;\n    }\n}\n\nmsg.notification_id = \"water_heat\";\nif (msg.state == \"on\" && hasChanged) {\n    msg.alertType = \"success\";\n    msg.zone = [\"inside\", \"outside\"];\n    if (msg.notification == \"hc_proximity\") {\n        msg.title = \"Chauffe-eau: Dans la grande zone\";\n        msg.message = \"Le chauffe-eau est allumé \" + msg.delay + \" min\";\n        msg.sendMobile = true;\n    } else if (msg.notification == \"hc_on\") {\n        msg.title = \"Chauffe-eau: Planification heures creuses\";\n        msg.message = \"Le chauffe-eau est allumé\";\n        msg.sendMobile = false;\n    } else if (msg.notification == \"hc_manual\") {\n        msg.title = \"Chauffe-eau: Action manuelle\";\n        msg.message = \"Le chauffe-eau est allumé pendant \" + msg.delay + \" min\";\n        msg.sendMobile = true;\n    } else if (msg.notification == \"module_desactivated\") {\n        msg.alertType = \"warning\";\n        msg.title = \"Module Chauffe-eau: Désactivé\";\n        msg.message = \"Module Chauffe-eau désactivé, le chauffe eau est allumé\";\n        msg.sendMobile = true;\n    }\n} else {\n    msg.dismiss = true;\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1370,"y":360,"wires":[["9cbe78b2241026d2"]]},{"id":"5a23ad382e31be62","type":"switch","z":"7cc0f49198f44c93","name":"hc_manual ?","property":"notification","propertyType":"msg","rules":[{"t":"eq","v":"hc_manual","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1230,"y":300,"wires":[["e761c4f5df30b6e5"]]},{"id":"e761c4f5df30b6e5","type":"api-call-service","z":"7cc0f49198f44c93","name":"desactivate manual water","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.water_heat_temp"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1430,"y":300,"wires":[[]]},{"id":"4020e05dc1d0c23a","type":"server-events","z":"a62a0ee8573c9b72","name":"phone receive","server":"66876666.3e6288","version":2,"eventType":"mobile_app_notification_action","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":110,"y":460,"wires":[["aa5c03271a7254d9","23bdf19660fa3754","a14b364f488d51a0","b4c1c5b35af21b97","2a33384c6bcb8786"]]},{"id":"aa5c03271a7254d9","type":"switch","z":"a62a0ee8573c9b72","name":"mesure","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"mesure","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":760,"y":460,"wires":[["b020e66ae86cfbd0"]]},{"id":"23bdf19660fa3754","type":"switch","z":"a62a0ee8573c9b72","name":"walk","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"walk","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":250,"y":460,"wires":[["b020e66ae86cfbd0"]]},{"id":"a14b364f488d51a0","type":"switch","z":"a62a0ee8573c9b72","name":"run","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"run","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":370,"y":460,"wires":[["b020e66ae86cfbd0"]]},{"id":"b4c1c5b35af21b97","type":"switch","z":"a62a0ee8573c9b72","name":"fitness","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"fitness","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":490,"y":460,"wires":[["b020e66ae86cfbd0"]]},{"id":"2a33384c6bcb8786","type":"switch","z":"a62a0ee8573c9b72","name":"stretching","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"stretching","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":620,"y":460,"wires":[["b020e66ae86cfbd0"]]},{"id":"b020e66ae86cfbd0","type":"function","z":"a62a0ee8573c9b72","name":"receive activities states","func":"//{\"walk\":[0,4,false],\"run\":[0,2,false],\"fitness\":[0,3,false],\"stretching\":[0,6,false],\"mesure\":[0,3,false]}\nvar activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state || \"{}\");\nvar type = msg.payload.event.action;\n\nif (activities[type][0] + 1 <= activities[type][1] && type !== \"\") {\n    switch (type) {\n        case \"walk\":\n            activities[\"walk\"][0]++;\n            activities[\"walk\"][2] = false;\n            break;\n        case \"run\":\n            activities[\"run\"][0]++;\n            activities[\"run\"][2] = false;\n            break;\n        case \"fitness\":\n            activities[\"fitness\"][0]++;\n            activities[\"fitness\"][2] = false;\n            break;\n        case \"stretching\":\n            activities[\"stretching\"][0]++;\n            activities[\"stretching\"][2] = false;\n            break;\n        case \"mesure\":\n            activities[\"mesure\"][0]++;\n            activities[\"mesure\"][2] = false;\n            break;\n    }\n    msg.payload = activities;\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":950,"y":460,"wires":[["461605c77a5074f4"]]},{"id":"0429572f34c1181a","type":"function","z":"a62a0ee8573c9b72","name":"build html activities tab","func":"let activities = msg.payload;\nlet totalUp = 0;\nlet totalDo = 0;\nlet txt = \"\";\nlet td = \"\";\nlet th = \"\"; \n\n//walk\ntd += buildHtml(getPercent('walk','Marche'));\n//run\ntd += buildHtml(getPercent('run','Course'));\n//fitness\ntd += buildHtml(getPercent('fitness','Musculation'));\n//stretching\ntd += buildHtml(getPercent('stretching','Étirement'));\n//mesure\ntd += buildHtml(getPercent('mesure','Pesée'));\n\n//Envoi\nlet total = isNaN(parseInt(100*totalUp/totalDo)) ? 0 : parseInt(100*totalUp/totalDo);\ntxt = '<center><b>' + 'Objectifs santé: ' + total + '% atteints' + '</b></center><hr>';\ntxt += '<table style=\"width:100%;text-align:center\"><tr>' + th + '</tr><tr>' + td + '</tr></table>';\n\nmsg.total = total;\nmsg.txt1 = {\"data\":{\"value\":txt.substring(0,254)}};\nmsg.txt2 = {\"data\":{\"value\":txt.substring(254)}};\n\nreturn msg;\n\nfunction getUp(type){\n    totalUp += parseInt(activities[type][0]);\n    return activities[type][0];\n}\n\nfunction getDo(type){\n    totalDo += parseInt(activities[type][1]);\n    return activities[type][1];\n}\n\nfunction getPercent(type,name){\n    th += '<th style=\"width:20%\">' + name + '</th>';\n    return getUp(type) + \"/\" + getDo(type);\n}\n\nfunction buildHtml(i){\n    return '<td>' + (i.split(\"/\")[0] === i.split(\"/\")[1] ? '✅': i) + '</td>';\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":260,"wires":[["467ecbfa6d0fc6f5","34b0f91244589587"]]},{"id":"605a6fcdec6e7dea","type":"switch","z":"a62a0ee8573c9b72","name":"100% complete","property":"total","propertyType":"msg","rules":[{"t":"eq","v":"100","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":840,"y":260,"wires":[["78dba95788419f7e"]]},{"id":"fc225d0ed2994071","type":"api-call-service","z":"a62a0ee8573c9b72","name":"health_stats_1","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.health_stats_1"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":300,"y":380,"wires":[[]]},{"id":"967453ce60bb4ed4","type":"api-call-service","z":"a62a0ee8573c9b72","name":"health_stats_2","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.health_stats_2"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":660,"y":380,"wires":[[]]},{"id":"581bd663e32209c1","type":"change","z":"a62a0ee8573c9b72","name":"txt1","rules":[{"t":"set","p":"payload","pt":"msg","to":"txt1","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":150,"y":380,"wires":[["fc225d0ed2994071"]]},{"id":"4c2b1b5ac50cc378","type":"change","z":"a62a0ee8573c9b72","name":"txt2","rules":[{"t":"set","p":"payload","pt":"msg","to":"txt2","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":510,"y":380,"wires":[["967453ce60bb4ed4"]]},{"id":"461605c77a5074f4","type":"function","z":"a62a0ee8573c9b72","name":"set json","func":"msg.payload = { \"data\": { \"value\": JSON.stringify(msg.payload) } };\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1140,"y":460,"wires":[["e10a6ab642e72857"]]},{"id":"e10a6ab642e72857","type":"api-call-service","z":"a62a0ee8573c9b72","name":"json activities","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1290,"y":460,"wires":[[]]},{"id":"508f7fb084e67cee","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"json activities","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_text.json_activities","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":260,"wires":[["4b68efecf1da94d1"]]},{"id":"4b68efecf1da94d1","type":"json","z":"a62a0ee8573c9b72","name":"","property":"payload","action":"","pretty":false,"x":250,"y":260,"wires":[["0429572f34c1181a"]]},{"id":"1774a2b5f618d01d","type":"subflow:3846091448eb9a09","z":"a62a0ee8573c9b72","name":"","env":[],"x":710,"y":40,"wires":[]},{"id":"b1fa06090656fd52","type":"catch","z":"a62a0ee8573c9b72","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["74f70af5292cd7f0"]]},{"id":"467ecbfa6d0fc6f5","type":"subflow:e6ac576fb4598283","z":"a62a0ee8573c9b72","name":"","x":670,"y":260,"wires":[["605a6fcdec6e7dea"],[]]},{"id":"3ddfb4e84d45cf22","type":"switch","z":"a62a0ee8573c9b72","name":"","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"alarm","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":590,"y":180,"wires":[["195ea958794de3f1"]]},{"id":"80e4c7b3fed93d58","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"sun","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sun.sun","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"above_horizon","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":90,"y":180,"wires":[["a74c66a671401d46"],[]]},{"id":"a74c66a671401d46","type":"moment","z":"a62a0ee8573c9b72","name":"","topic":"","input":"","inputType":"date","inTz":"ETC/utc","adjAmount":0,"adjType":"days","adjDir":"add","format":"YYYY-MM-DD","locale":"C","output":"payload","outputType":"msg","outTz":"ETC/utc","x":260,"y":180,"wires":[["f38f72a9a33e9329"]]},{"id":"565a47b4c56c5090","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"motivation_resend","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.motivation_resend","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":130,"y":120,"wires":[["b7272d98fbf8706e"],[]]},{"id":"b7272d98fbf8706e","type":"api-call-service","z":"a62a0ee8573c9b72","name":"motivation_resend off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation_resend"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":340,"y":120,"wires":[["4d734662885861d4"]]},{"id":"195ea958794de3f1","type":"function","z":"a62a0ee8573c9b72","name":"prepare activities for today","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state || \"{}\");\nlet title = \"Sport & Santé\";\nlet msgs = [];\n\nif (activities[\"mesure\"][2]) {\n    msgs.push({ title: title, message: \"Se peser\", type: \"mesure\" });\n}\n\nif (activities[\"stretching\"][2]) {\n    msgs.push({ title: title, message: \"Une séance d'étirement est prévue\", type: \"stretching\" });\n}\n\nif (activities[\"walk\"][2]) {\n    msgs.push({ title: title, message: \"Une marche est prévue\", type: \"walk\" });\n}\n\nif (activities[\"run\"][2]) {\n    msgs.push({ title: title, message: \"Une course est prévue\", type: \"run\" });\n}\n\nif (activities[\"fitness\"][2]) {\n    msgs.push({ title: title, message: \"Une séance de musculation est prévue\", type: \"fitness\" });\n}\n\nreturn [msgs];","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1000,"y":180,"wires":[["6981cbd208078aa7"]]},{"id":"4a161c195a4c8183","type":"function","z":"a62a0ee8573c9b72","name":"notification","func":"msg.data = { actions: [{ \"action\": msg.type, \"title\": \"Fait avec amour\" }, { \"action\": \"0\", \"title\": \"pas fait\" }] };\nmsg.sendMobile = true;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":120,"wires":[["b5f1fd6eac80b150"]]},{"id":"b5f1fd6eac80b150","type":"subflow:ba09e97f2ed22f2b","z":"a62a0ee8573c9b72","name":"","x":1040,"y":120,"wires":[]},{"id":"4d734662885861d4","type":"function","z":"a62a0ee8573c9b72","name":"resend week activities","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state || \"{}\");\nlet title = \"Santé: \";\nlet msgs = [];\n\nloadActivities(\"mesure\", \"Se peser\");\nloadActivities(\"stretching\", \"Une séance d'étirement est prévue\");\nloadActivities(\"walk\", \"Une marche est prévue\");\nloadActivities(\"run\", \"Une course est prévue\");\nloadActivities(\"fitness\", \"Une séance de musculation est prévue\");\n\nreturn [msgs];\n\nfunction loadActivities(activityType, message) {\n    for (let i = activities[activityType][0]; i < activities[activityType][1]; i++) {\n        msgs.push({ title: title, message: message, type: activityType });\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":120,"wires":[["271c98b81e4c60be"]]},{"id":"2b8a6446b97c275d","type":"subflow:ad3b29a5dd67898f","z":"a62a0ee8573c9b72","name":"","x":460,"y":40,"wires":[]},{"id":"74f70af5292cd7f0","type":"change","z":"a62a0ee8573c9b72","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"sport","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["2b8a6446b97c275d"]]},{"id":"271c98b81e4c60be","type":"link out","z":"a62a0ee8573c9b72","name":"link out 238","mode":"link","links":["0ab7eb9ee8e849b9"],"x":695,"y":120,"wires":[]},{"id":"0ab7eb9ee8e849b9","type":"link in","z":"a62a0ee8573c9b72","name":"link in 236","links":["271c98b81e4c60be","6981cbd208078aa7"],"x":755,"y":120,"wires":[["4a161c195a4c8183"]]},{"id":"6981cbd208078aa7","type":"link out","z":"a62a0ee8573c9b72","name":"link out 239","mode":"link","links":["594562288aa3dadd","0ab7eb9ee8e849b9"],"x":1155,"y":180,"wires":[]},{"id":"3c216bb3ba5c50da","type":"subflow:dbf17bea6affd2ec","z":"a62a0ee8573c9b72","name":"","x":890,"y":320,"wires":[]},{"id":"b079abeb62017956","type":"change","z":"a62a0ee8573c9b72","name":"sound","rules":[{"t":"set","p":"sound","pt":"msg","to":"win.mp3","tot":"str"},{"t":"set","p":"volumeLevel","pt":"msg","to":"0.6","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":150,"y":320,"wires":[["a04b624c11672d09"]]},{"id":"34b0f91244589587","type":"link out","z":"a62a0ee8573c9b72","name":"link out 240","mode":"link","links":["d0a58f4c96e9c4e3","1ac9e1f9d270db35"],"x":555,"y":260,"wires":[]},{"id":"d0a58f4c96e9c4e3","type":"link in","z":"a62a0ee8573c9b72","name":"link in 237","links":["34b0f91244589587"],"x":415,"y":380,"wires":[["4c2b1b5ac50cc378"]]},{"id":"1ac9e1f9d270db35","type":"link in","z":"a62a0ee8573c9b72","name":"link in 238","links":["49947236b125db38","34b0f91244589587"],"x":55,"y":380,"wires":[["581bd663e32209c1"]]},{"id":"2b8c4c09a3742acd","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"motiv","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.motivation","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":90,"y":600,"wires":[["c437e0a422479e97"],[]]},{"id":"c437e0a422479e97","type":"function","z":"a62a0ee8573c9b72","name":"notification","func":"msg.title = \"Option Santé: Activée\";\nmsg.message = \"Tu fais le bon choix. Reste motivé.\";\nmsg.sendMobile = true;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":600,"wires":[["0ece54a40b22328b"]]},{"id":"8640a3a14306a54b","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"motiv","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.motivation","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":90,"y":540,"wires":[["7dd9d25ba50a5fa4"],[]]},{"id":"7dd9d25ba50a5fa4","type":"function","z":"a62a0ee8573c9b72","name":"reinit activities","func":"let activities = JSON.parse(global.get(\"homeassistant\").homeAssistant.states[\"input_text.json_activities\"].state || \"{}\");\nlet init = [0, 0, false];\n\nactivities[\"walk\"] = init;\nactivities[\"run\"] = init;\nactivities[\"fitness\"] = init;\nactivities[\"stretching\"] = init;\nactivities[\"mesure\"] = init;\n\nmsg.payload = activities;\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":240,"y":540,"wires":[["e7d45d857ee953d3"]]},{"id":"e7d45d857ee953d3","type":"function","z":"a62a0ee8573c9b72","name":"set json","func":"msg.payload = { \"data\": { \"value\": JSON.stringify(msg.payload) } };\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":540,"wires":[["0f303a07aee53ece"]]},{"id":"0f303a07aee53ece","type":"api-call-service","z":"a62a0ee8573c9b72","name":"json activities","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.json_activities"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":550,"y":540,"wires":[[]]},{"id":"0ece54a40b22328b","type":"subflow:ba09e97f2ed22f2b","z":"a62a0ee8573c9b72","name":"","x":400,"y":600,"wires":[]},{"id":"a04b624c11672d09","type":"ha-wait-until","z":"a62a0ee8573c9b72","name":"wait until home","server":"66876666.3e6288","version":2,"outputs":2,"entityId":"input_boolean.in_home_zone","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"4","timeoutType":"num","timeoutUnits":"hours","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":560,"y":320,"wires":[["77dd447fc12f94fb"],[]]},{"id":"47ed8e2b327dccf0","type":"delay","z":"a62a0ee8573c9b72","name":"","pauseType":"delay","timeout":"9","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":280,"y":320,"wires":[["0c3f3ed299e670ca"]]},{"id":"0c3f3ed299e670ca","type":"change","z":"a62a0ee8573c9b72","name":"speak","rules":[{"t":"set","p":"speak","pt":"msg","to":"Vous avez terminé vos objectifs de la journée. Ohhh hièèèèè bro !","tot":"str"},{"t":"set","p":"volumeLevel","pt":"msg","to":"0.6","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":320,"wires":[["a04b624c11672d09"]]},{"id":"78dba95788419f7e","type":"link out","z":"a62a0ee8573c9b72","name":"link out 241","mode":"link","links":["35f30657dc9a7253"],"x":955,"y":260,"wires":[]},{"id":"35f30657dc9a7253","type":"link in","z":"a62a0ee8573c9b72","name":"link in 239","links":["78dba95788419f7e"],"x":55,"y":320,"wires":[["b079abeb62017956","47ed8e2b327dccf0"]]},{"id":"77dd447fc12f94fb","type":"delay","z":"a62a0ee8573c9b72","name":"","pauseType":"delay","timeout":"20","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":720,"y":320,"wires":[["3c216bb3ba5c50da"]]},{"id":"fdaf52796d22e4f8","type":"link in","z":"a62a0ee8573c9b72","name":"link in 418","links":["08a2e534e6dd4397"],"x":675,"y":180,"wires":[["b301563aef7664dc"]]},{"id":"b301563aef7664dc","type":"function","z":"a62a0ee8573c9b72","name":"get alarms","func":"let persons = global.get(\"persons\") || {};\n\nlet keys = Object.keys(persons);\nfor (let key of keys) {\n    if (\"alarm\" in persons[key] && persons[key].alarm == msg.currentTime) {\n        return msg;\n    }\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":180,"wires":[["195ea958794de3f1"]]},{"id":"f38f72a9a33e9329","type":"function","z":"a62a0ee8573c9b72","name":"get alarms","func":"let persons = global.get(\"persons\") || {};\n\nlet personsKeys = Object.keys(persons);\nfor (let key of personsKeys) {\n    msg.alarm = persons[key].alarm.split(\" \")[0];\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":180,"wires":[["3ddfb4e84d45cf22"]]},{"id":"e7e6f923a633831a","type":"server-state-changed","z":"a62a0ee8573c9b72","name":"module_healthy","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.module_healty","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":120,"y":660,"wires":[["8f546715d338a376","ea3fb831dea35c4d"]]},{"id":"8f546715d338a376","type":"function","z":"a62a0ee8573c9b72","name":"notification","func":"msg.notification_id = \"module_healthy\";\nif (msg.payload == \"off\") {\n    msg.alertType = \"warning\";\n    msg.title = \"Module Sport et santé: Désactivé\";\n    msg.message = \"Module Sport et santé désactivé, vous ne recevrez plus de notifications\";\n    msg.zone = [\"inside\", \"outside\"];\n    msg.sendMobile = true;\n} else {\n    msg.dismiss = true;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":660,"wires":[["3b3dd6b16a5c5a1d"]]},{"id":"3b3dd6b16a5c5a1d","type":"link out","z":"a62a0ee8573c9b72","name":"link out 416","mode":"link","links":["4fcc3b49d98a2c1f"],"x":515,"y":660,"wires":[]},{"id":"ea3fb831dea35c4d","type":"api-call-service","z":"a62a0ee8573c9b72","name":"motiv","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_{{payload}}","areaId":[],"deviceId":[],"entityId":["input_boolean.motivation"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":270,"y":660,"wires":[[]]},{"id":"00ede13124c44890","type":"catch","z":"eaa696a731a52b23","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["b175ee858ab93e92"]]},{"id":"0b9796d6577bb527","type":"link in","z":"eaa696a731a52b23","name":"link in 88","links":["08a2e534e6dd4397"],"x":265,"y":120,"wires":[["b9a51bce4e5b801e"]]},{"id":"38beb2359e67bda8","type":"subflow:ad3b29a5dd67898f","z":"eaa696a731a52b23","name":"","x":460,"y":40,"wires":[]},{"id":"b175ee858ab93e92","type":"change","z":"eaa696a731a52b23","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Alarm clock","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["38beb2359e67bda8"]]},{"id":"960208acd6ab9db8","type":"function","z":"eaa696a731a52b23","name":"get alarms","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\nlet persons = global.get(\"persons\") || {};\nlet msgs = [];\n\nlet personsKeys = Object.keys(persons);\nfor (let key of personsKeys) {\n    if (\"alarm\" in persons[key] && persons[key].alarm == msg.currentTime) {\n        msg = { ...msg, ...ha_configuration[key] };\n\n        let ambianceSet = \"alarmClock\" in msg && \"linkedAmbiance\" in msg.alarmClock && \"linkedAmbianceDuration\" in msg.alarmClock;\n        msg.delay = ambianceSet ? msg.alarmClock.linkedAmbianceDuration * 60 * 1000 : 0;\n        msg.option = ambianceSet && msg.delay != 0 ? randomAmbiance(ha_configuration[\"ambiance_config\"].ambiances_type) : \"\";\n\n        let radioVolumeLevelSet = \"alarmClock\" in msg && \"linkedAmbiance\" in msg.alarmClock && \"radioVolumeLevel\" in ha_configuration[msg.alarmClock.linkedAmbiance];\n        msg.radioVolumeLevel = radioVolumeLevelSet ? ha_configuration[msg.alarmClock.linkedAmbiance].radioVolumeLevel : 0.5;\n        msgs.push(msg);\n    }\n}\n\nif (msgs.length != 0) {\n    return [msgs];\n}\n\nfunction randomAmbiance(ambiances_type) {\n    let ambiancesTypeKeys = Object.keys(ambiances_type);\n    let ambiancesType = [];\n    for (let key of ambiancesTypeKeys) {\n        ambiancesType.push(ambiances_type[key].name);\n    }\n    return ambiancesType[1 + Math.floor(Math.random() * 7)];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":120,"wires":[["359870b03acadcb7"]]},{"id":"064fb128dde2efef","type":"delay","z":"eaa696a731a52b23","name":"","pauseType":"delayv","timeout":"1","timeoutUnits":"hours","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":480,"y":240,"wires":[["d05051316ec66cd6","b314b6395ded99fa"]]},{"id":"02e883d0e84f6ad6","type":"function","z":"eaa696a731a52b23","name":"msg speaker","func":"if (\"speaker\" in msg && msg.speaker.length != 0 &&\n    \"attributes\" in msg.speaker[0] &&\n    \"device_class\" in msg.speaker[0].attributes &&\n    msg.speaker[0].attributes.device_class == \"speaker\") {\n\n    msg.payload = {\n        data: {\n            entity_id: msg.alarmClock.linkedSpeaker,\n            media_content_id: msg.alarmClock.linkedRadio,\n            media_content_type: \"music\"\n        }\n    };\n\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":300,"wires":[["aa27a92396a069f8"]]},{"id":"7ae10a24f3c61c40","type":"function","z":"eaa696a731a52b23","name":"msg","func":"let linkedRadioSet = \"alarmClock\" in msg && \"linkedSpeaker\" in msg.alarmClock && \"linkedRadio\" in msg.alarmClock;\nif (linkedRadioSet) {\n    msg.filter = { \"in\": { entity_id: msg.alarmClock.linkedSpeaker } };\n    msg.result = \"speaker\";\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":300,"wires":[["b2f71faa998f6070"]]},{"id":"3fc9cf9c927671aa","type":"api-call-service","z":"eaa696a731a52b23","name":"set vol","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"{{entity_id}}\",\"volume_level\":\"{{volume_level}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":730,"y":300,"wires":[[]]},{"id":"8062fd9bb31de8d6","type":"function","z":"eaa696a731a52b23","name":"set volume","func":"if (\"speaker\" in msg && msg.speaker.length != 0 &&\n    \"attributes\" in msg.speaker[0] &&\n    \"device_class\" in msg.speaker[0].attributes &&\n    msg.speaker[0].attributes.device_class == \"speaker\") {\n\n    let radioVolumeLevel = \"radioVolumeLevel\" in msg ? msg.radioVolumeLevel : \"defaultVolumeLevel\" in msg.speaker[0] ? msg.speaker[0].defaultVolumeLevel : 0.5;\n    msg.payload = {\n        data: {\n            entity_id: msg.alarmClock.linkedSpeaker,\n            volume_level: radioVolumeLevel\n        }\n    };\n\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":300,"wires":[["3fc9cf9c927671aa"]]},{"id":"aa27a92396a069f8","type":"api-call-service","z":"eaa696a731a52b23","name":"set speaker","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1030,"y":300,"wires":[[]]},{"id":"26ebf42c4bebcc08","type":"subflow:ea5b93cde6b1bf0a","z":"eaa696a731a52b23","name":"","x":430,"y":300,"wires":[["8062fd9bb31de8d6","02e883d0e84f6ad6"]]},{"id":"d05051316ec66cd6","type":"link out","z":"eaa696a731a52b23","name":"link out 334","mode":"link","links":["de52115cdb597d40","727e84e5749fbbf6"],"x":575,"y":240,"wires":[]},{"id":"de52115cdb597d40","type":"link in","z":"eaa696a731a52b23","name":"link in 348","links":["d05051316ec66cd6"],"x":55,"y":300,"wires":[["7ae10a24f3c61c40"]]},{"id":"b89369d9b4b74482","type":"function","z":"eaa696a731a52b23","name":"msg","func":"msg.filter = { \"in\": { linkedClass: \"motion\", linkedArea: msg.linkedArea } };\nmsg.result = \"motions\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":180,"wires":[["3c4562703e84eeb2"]]},{"id":"3c4562703e84eeb2","type":"subflow:ea5b93cde6b1bf0a","z":"eaa696a731a52b23","name":"","x":290,"y":180,"wires":[["0b477e7910fca0f6"]]},{"id":"359870b03acadcb7","type":"link out","z":"eaa696a731a52b23","name":"alarm started","mode":"link","links":["646b3ecc40cac7d6","ad71db437d37282f","efcfefbd4cbdc989"],"x":775,"y":120,"wires":[]},{"id":"ad71db437d37282f","type":"link in","z":"eaa696a731a52b23","name":"link in 364","links":["359870b03acadcb7"],"x":55,"y":180,"wires":[["b89369d9b4b74482"]]},{"id":"1d6891ce8d403238","type":"function","z":"eaa696a731a52b23","name":"set alarm","func":"let persons = global.get(\"persons\") || {};\n\nif (!(msg.linkedPerson in persons)) {\n    persons[msg.linkedPerson] = {};\n    persons[msg.linkedPerson].name = msg.person.name;\n}\n\npersons[msg.linkedPerson].alarm = msg.localTime;\nglobal.set(\"persons\", persons);\nreturn msg;","outputs":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":120,"wires":[]},{"id":"4e516a193edce284","type":"link in","z":"eaa696a731a52b23","name":"link in 366","links":["2fe6890217e27ac6"],"x":55,"y":120,"wires":[["1d6891ce8d403238"]]},{"id":"0b477e7910fca0f6","type":"function","z":"eaa696a731a52b23","name":"set waits","func":"let motions = msg.motions;\nmsg.waits = [];\nmsg.states = [];\n\nif (msg.delay != 0) {\n    for (let motion of motions) {\n        msg.waits.push(motion.entity_id);\n        msg.states.push(motion.invertedMotion ? \"off\" : \"on\");\n        msg.timeout = msg.delay / 1000;\n    }\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":180,"wires":[["ce50f43acef72ede"]]},{"id":"a40c3173ed69eae1","type":"subflow:050c60654a910e68","z":"eaa696a731a52b23","name":"","x":160,"y":240,"wires":[["caf7c088c9670934","d05051316ec66cd6","b314b6395ded99fa"]]},{"id":"caf7c088c9670934","type":"change","z":"eaa696a731a52b23","name":"reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool"},{"t":"delete","p":"delay","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":240,"wires":[["064fb128dde2efef"]]},{"id":"ce50f43acef72ede","type":"link out","z":"eaa696a731a52b23","name":"link out 354","mode":"link","links":["dc898bfab5de97de"],"x":535,"y":180,"wires":[]},{"id":"dc898bfab5de97de","type":"link in","z":"eaa696a731a52b23","name":"link in 369","links":["ce50f43acef72ede"],"x":55,"y":240,"wires":[["a40c3173ed69eae1"]]},{"id":"b9a51bce4e5b801e","type":"subflow:e6ac576fb4598283","z":"eaa696a731a52b23","name":"","x":370,"y":120,"wires":[["699d5211bed69d84"],[]]},{"id":"699d5211bed69d84","type":"api-current-state","z":"eaa696a731a52b23","name":"reveil ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.reveil","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":520,"y":120,"wires":[["960208acd6ab9db8"],[]]},{"id":"af6f9b05d26ce6b7","type":"api-call-service","z":"eaa696a731a52b23","name":"select ambiance","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_select","service":"select_option","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"input_select.{{alarmClock.linkedAmbiance}}\",\"option\":\"{{option}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1080,"y":240,"wires":[[]]},{"id":"55c14ffc8b8ac1b9","type":"change","z":"eaa696a731a52b23","name":"set stop option","rules":[{"t":"set","p":"option","pt":"msg","to":"ha_configuration.ambiance_config.ambiances_type.stop.name","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":900,"y":240,"wires":[["af6f9b05d26ce6b7"]]},{"id":"b2f71faa998f6070","type":"delay","z":"eaa696a731a52b23","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":280,"y":300,"wires":[["26ebf42c4bebcc08"]]},{"id":"efcfefbd4cbdc989","type":"link in","z":"eaa696a731a52b23","name":"link in 394","links":["359870b03acadcb7"],"x":375,"y":240,"wires":[["064fb128dde2efef"]]},{"id":"646b3ecc40cac7d6","type":"link in","z":"eaa696a731a52b23","name":"link in 395","links":["359870b03acadcb7"],"x":595,"y":180,"wires":[["a4ca12c58591b1ed"]]},{"id":"727e84e5749fbbf6","type":"link in","z":"eaa696a731a52b23","name":"link in 422","links":["d05051316ec66cd6"],"x":55,"y":360,"wires":[["345ed36762fa253e"]]},{"id":"8e7912d6c84c4bdd","type":"api-call-service","z":"eaa696a731a52b23","name":"select ambiance","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_select","service":"select_option","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"input_select.{{alarmClock.linkedAmbiance}}\",\"option\":\"{{option}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":920,"y":180,"wires":[[]]},{"id":"345ed36762fa253e","type":"function","z":"eaa696a731a52b23","name":"msg","func":"if (\"alarmClock\" in msg && \"linkedCovers\" in msg.alarmClock) {\n    msg.filter = { \"in\": { entity_id: msg.alarmClock.linkedCovers } };\n    msg.result = \"covers\";\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":360,"wires":[["1ae67d03ee65aa33"]]},{"id":"1ae67d03ee65aa33","type":"subflow:ea5b93cde6b1bf0a","z":"eaa696a731a52b23","name":"","x":290,"y":360,"wires":[["354f9cbcd636e108"]]},{"id":"354f9cbcd636e108","type":"function","z":"eaa696a731a52b23","name":"covers open","func":"let covers = msg.covers;\nlet msgs = [];\n\nfor (let cover of covers) {\n    msgs.push({ payload: { data: { entity_id: cover.entity_id, value: 100 } } });\n}\n\nif (msgs.length != 0) {\n    return [msgs];\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":360,"wires":[["93d65c346eab5746"]]},{"id":"93d65c346eab5746","type":"api-call-service","z":"eaa696a731a52b23","name":"set covers pct","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_number","service":"set_value","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":620,"y":360,"wires":[[]]},{"id":"a4ca12c58591b1ed","type":"function","z":"eaa696a731a52b23","name":"ambianceValidated","func":"let ambianceValidated = msg.option != \"\" && \"linkedAmbiance\" in msg.alarmClock && msg.alarmClock.linkedAmbiance != \"\";\n\nif (ambianceValidated){\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":730,"y":180,"wires":[["8e7912d6c84c4bdd"]]},{"id":"b314b6395ded99fa","type":"function","z":"eaa696a731a52b23","name":"ambianceValidated","func":"let ambianceValidated = msg.option != \"\" && \"linkedAmbiance\" in msg.alarmClock && msg.alarmClock.linkedAmbiance != \"\";\n\nif (ambianceValidated){\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":240,"wires":[["55c14ffc8b8ac1b9"]]},{"id":"c60d1faaa1caab61","type":"catch","z":"3bf1cd85b32b4e67","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["6e67b519f11705fa"]]},{"id":"69336d7ebfeb86a0","type":"subflow:ad3b29a5dd67898f","z":"3bf1cd85b32b4e67","name":"","x":460,"y":40,"wires":[]},{"id":"6e67b519f11705fa","type":"change","z":"3bf1cd85b32b4e67","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Devices","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["69336d7ebfeb86a0"]]},{"id":"f18b9af73474d013","type":"server-state-changed","z":"3bf1cd85b32b4e67","name":"Det mode canap","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.door_window_sensor_158d0003d4dfec","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":120,"wires":[[],["16e3c15572c9984b"]]},{"id":"806fe25b2ff47b0b","type":"api-call-service","z":"3bf1cd85b32b4e67","name":"mode canap on","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.mode_canape"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1200,"y":160,"wires":[[]]},{"id":"aed81e6d2d905b05","type":"api-current-state","z":"3bf1cd85b32b4e67","name":"det mode canap on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.door_window_sensor_158d0003d4dfec","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":800,"y":120,"wires":[["a797ab8286b6f26b"],[]]},{"id":"b357bac7b1570d4a","type":"delay","z":"3bf1cd85b32b4e67","name":"","pauseType":"rate","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":460,"y":120,"wires":[["d2f1978517773f14"]]},{"id":"d2f1978517773f14","type":"delay","z":"3bf1cd85b32b4e67","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":620,"y":120,"wires":[["aed81e6d2d905b05"]]},{"id":"a797ab8286b6f26b","type":"api-current-state","z":"3bf1cd85b32b4e67","name":"mode canap on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.mode_canape","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":1010,"y":120,"wires":[["1edb0c2bd06348dd"],["806fe25b2ff47b0b"]]},{"id":"16e3c15572c9984b","type":"subflow:e6ac576fb4598283","z":"3bf1cd85b32b4e67","name":"","x":290,"y":120,"wires":[["b357bac7b1570d4a"],[]]},{"id":"1edb0c2bd06348dd","type":"api-call-service","z":"3bf1cd85b32b4e67","name":"mode canap off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.mode_canape"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1200,"y":80,"wires":[[]]},{"id":"659272da7d6c680a","type":"function","z":"3bf1cd85b32b4e67","name":"IR packets","func":"switch(msg.payload){\n    case \"hc_power\":\n        msg.payload = \"JgBOAAwAAoQKsQABLJAWDxYzFw4WDxYzFw4XMxYzFw4XDhY0FjMXDhY0FjMXDhY0FjMXDhY0Fg8WDhczFjMXDhcOFjQWDhczFjQWDhcOFwANBQAAAAAAAAAAAAA=\";\n        break;\n    case \"hc_vol_up\":\n        msg.payload = \"JgCOABcOFjQWDhcOFzMWDxYzFzMWMxcOFzMWMxcOFzMWMxcOFw4WMhgOFw4XDhYPFg8WDxYzFg8WMxczFjQWMxczFjMXAASlE0UAASyQFg8WMxYPFg8WMxcOFjQWMxcyFw8WMxczFg8WMxY0Fg8WDxYzFg8WDxYPFg4XDhYPFjMXDhczFjQWMxYxGTMXMxYADQUAAAAAAAAAAAAA\";\n        break;\n    case \"hc_vol_do\":\n        msg.payload = \"JgCQAAABKZIWDxU1FBEUEBU1FRAVNBY0FDUVEBQ2FDYUEBU1FDUWDxQ2FDUWDxQRFRAUERQRFBAUERUQFDUVNRQ2FDUUNhQ1FQAE/wABKZIVEBQ2FBEUERQ1FBEUNRU1FDYUERQ1FDYUEBU1FDYUEBU1FDYUEBUQFBEUERQRFBAVEBQRFDYUNRQ2FDUVNRQ2FAANBQAAAAAAAAAA\";\n        break;        \n    case \"hc_mute\":\n        msg.payload = \"JgBQAAABLJAWDxYzFw4XDhYzFw4XMxYzFzMXDhYzFzMXDhYzFzMXDhY0Fg4XMxYPFg8WDhcOFw4WDxYzFw4XMxYzFzMWNBYzFwAE/AABLEYWAA0FAAAAAAAAAAA=\";\n        break;   \n    case \"hc_hdmi\":\n        msg.payload = \"JgBIAAABKZIUERQ2FBEUEBU1FBEUNRQ2FDUVEBQ2FDYUEBQ2FDYUEBQ1FREUNRQzFxEUERQQFBEUERQ2FBAUERQ2FDUUNhQ2FAANBQ==\";\n        break; \n    case \"hc_bt\":\n        msg.payload = \"JgBQAAABLJAXDhczFw0YDRczFw4XMhgyFw4XMxcyFzMXMxcNGA0XDhcOFw4XDhcNGDIXDhczFw0YDRczFzMXMhcOFw4XDhcOFwAFjwABLEYWAA0FAAAAAAAAAAA=\";\n        break;  \n    case \"vp_power_on\":\n        msg.payload = \"JgCgAJiPFC4UDBUMFQwVLBUMFQwVDBUtFA0TDRQuFA0UDRMOEw0UkBQNEw4TDRQNFC4TDhMNFC4ULhMNFA0ULhMOEy4ULhMOEw4TLhQuEw4TAAdbl5ATLhQNFA0UDRMuFA0UDRQNEy4UDRQNFC4TDhMNFA0UDRSPFA0UDRQNFA0TLhQNFA0ULhMuFA0UDRQuEw0ULhQuEw0UDRQuEy4UDRQADQUAAAAAAAAAAA==\";\n        break; \n    case \"vp_power_off\":\n        msg.payload = \"JgCgAJaQEjAREBEPEg8SMBEQEQ8TDhIwERATDRIvEw8REBEQEQ8SkhEQERARDxIPEg8REBEQETASMBEQERASLxIwETASMBEQERARMBIwERARAAddl5ARMBIPEg8SDxEwEg8SDxIPETASDxIPEjAREBEPEg8SDxKSEQ8SDxIPEg8REBEQEQ8SMBExEQ8SDxIwETASMBIwERARDxIwETASDxIADQUAAAAAAAAAAA==\";\n        break;\n    case \"fan_power\":\n        msg.payload = \"JgA6ASwLLQsRJywLLQsRJhEnEScRJRInEScs6S0LLQsRJi0LLQsRJxAnEScRJhEnEScs6S0LLAsRJy0LLAwQJxEnEScQJxEnESYt6SwMLAsRJywMLAsRJxEnECcRJxEnECct6SwLLQsRJywLLQsRJxEmEScRJxEmESct6SwLLQsRJi0LLQsRJhEnEScRJhEnEScs6S0LLAwQJy0LLAwQJxEnEScQJxEnEScs6S0LLAsRJywMLAsRJxEnESYRJxEnESYt6SwLLQsSJiwMLAsRJxEmEScRJxEmESct6SwLLQsRJywLLQsRJxAnEScRJxAnEiYs6S0LLAwQJy0LLQsQJxEnEScRJhEnEScs6SsNLAsRJywMKw0OKREnECcRJxEnESYr6ywMKg0RJywMLAsRJxEnECcRJxEnECctAA0FAAAAAAAAAAAAAAAAAAA=\";\n    break;\n    case \"fan_speed\":\n        msg.payload = \"JgC2ACwLLQsRJy0KLQsSJhEmEiYRJxEmLgoSAAEDLgouChIlLgouChIlEiYSJhImESYuChIAAQMuCiwLEiYuCC8LECcRJxEnECcRJywMEAABBS0KLQoSJywMLQoRJxImECcRJxImLQoSAAEELQouChImLQouChImEiUSJhImEiUuChIAAQMtCy0LESYtCy4KEScQJxEnECgQJy0LEQABBC0LLAwQJy0LLQsRJhEnEScRJhEnLAwRAA0FAAA=\";\n    break;\n    case \"fan_rotate\":\n        msg.payload = \"JgBoACwJLwoSJywMLAsRJw8pLAsRJw8pDygRAAEFKg0rDQ8pLAstChApECctCw8pDygPKREAAQQtCywKEictCywMECcRJywLEScRJxEnEAABBSwMLAsRJywMLAsRJxEnLAsRJxEnECcSAA0F\";\n    break;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":110,"y":180,"wires":[[]]},{"id":"3a335bfb2e72f42a","type":"server-state-changed","z":"22b4130fe1f6a28b","name":"github update","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.lemuriens_coconut_latest_commit","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","outputs":1,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":110,"y":120,"wires":[["df4af56f9ed72f66"]]},{"id":"0b58061cac0414bc","type":"catch","z":"22b4130fe1f6a28b","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["5628c3b6e6e05cc2"]]},{"id":"8308b45e584b06f6","type":"subflow:ad3b29a5dd67898f","z":"22b4130fe1f6a28b","name":"","x":460,"y":40,"wires":[]},{"id":"5628c3b6e6e05cc2","type":"change","z":"22b4130fe1f6a28b","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Github","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["8308b45e584b06f6"]]},{"id":"7054f8d19f28b03a","type":"function","z":"22b4130fe1f6a28b","name":"god_mode ?","func":"let ha_configuration = global.get(\"ha_configuration\") || {};\n\nif (\"god_mode\" in ha_configuration\n    && \"linkedClass\" in ha_configuration[\"god_mode\"]\n    && ha_configuration[\"god_mode\"].linkedClass == \"god_mode\"\n    && ha_configuration[\"god_mode\"].mode == \"dev\") {\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":180,"wires":[["d6f860c7dde4dfac"],[]]},{"id":"8e6ca1647e0c0ba5","type":"link out","z":"22b4130fe1f6a28b","name":"link out 423","mode":"link","links":["5f85fc493433edce"],"x":475,"y":200,"wires":[]},{"id":"df4af56f9ed72f66","type":"api-call-service","z":"22b4130fe1f6a28b","name":"update available","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.update_available_on_lemuriens_coconut"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":280,"y":120,"wires":[[]]},{"id":"d95aeb3d32616821","type":"link in","z":"22b4130fe1f6a28b","name":"update validated","links":["830d16c9be89788c"],"x":495,"y":300,"wires":[["e6d93ead290b08a2"]]},{"id":"cd33a20bd7aa444d","type":"server-state-changed","z":"22b4130fe1f6a28b","name":"update","server":"66876666.3e6288","version":4,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.update_from_lemuriens_coconut","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","outputs":2,"output_only_on_state_change":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":90,"y":180,"wires":[["7054f8d19f28b03a"],[]]},{"id":"e6d93ead290b08a2","type":"api-call-service","z":"22b4130fe1f6a28b","name":"update validated","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.update_available_on_lemuriens_coconut","input_boolean.update_from_lemuriens_coconut"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":620,"y":300,"wires":[["932abaaacd89ff01"]]},{"id":"314cf66972eefafd","type":"delay","z":"22b4130fe1f6a28b","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":680,"y":120,"wires":[[]]},{"id":"db6ed825fa8ec8e2","type":"link in","z":"22b4130fe1f6a28b","name":"link in 431","links":["523bebf570571714","6b594e58c4deee27"],"x":55,"y":300,"wires":[["8b90ccdbc66dac03"]]},{"id":"4392c27b07392a2e","type":"api-call-service","z":"22b4130fe1f6a28b","name":"restart node-red","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"hassio","service":"addon_restart","areaId":[],"deviceId":[],"entityId":[],"data":"{\"addon\":\"{{addon}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":380,"y":300,"wires":[[]]},{"id":"932abaaacd89ff01","type":"link out","z":"22b4130fe1f6a28b","name":"link out 427","mode":"return","links":[],"x":735,"y":300,"wires":[]},{"id":"8b90ccdbc66dac03","type":"function","z":"22b4130fe1f6a28b","name":"get node-red addon","func":"let nodeRed = global.get('homeassistant').homeAssistant.states[\"update.node_red_update\"];\nlet checkPass = \"attributes\" in nodeRed && \"entity_picture\" in nodeRed.attributes && nodeRed.attributes.entity_picture != \"\";\n\nif (checkPass) {\n    msg.addon = nodeRed.attributes.entity_picture.replace(\"/api/hassio/addons/\", \"\").replace(\"/icon\", \"\");\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":300,"wires":[["4392c27b07392a2e"]]},{"id":"19c67d2aca8dacf4","type":"exec","z":"22b4130fe1f6a28b","command":"","addpay":"payload","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":270,"y":240,"wires":[["a84852adfbcf0f82"],[],[]]},{"id":"a84852adfbcf0f82","type":"switch","z":"22b4130fe1f6a28b","name":"no error","property":"rc.code","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":400,"y":240,"wires":[["bb7d562d36a95364"]]},{"id":"5f85fc493433edce","type":"link in","z":"22b4130fe1f6a28b","name":"link in 432","links":["8e6ca1647e0c0ba5"],"x":55,"y":240,"wires":[["c1d14ac0a4c78950"]]},{"id":"6b594e58c4deee27","type":"link out","z":"22b4130fe1f6a28b","name":"link out 428","mode":"link","links":["e88b205d1a3b0ecc","db6ed825fa8ec8e2"],"x":675,"y":240,"wires":[]},{"id":"5aeb2ae76d7c6433","type":"link call","z":"22b4130fe1f6a28b","name":"validate update","links":["d95aeb3d32616821"],"linkType":"static","timeout":"30","x":900,"y":120,"wires":[[]]},{"id":"c1d14ac0a4c78950","type":"template","z":"22b4130fe1f6a28b","name":"git pull","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"cd /config\ngit reset --hard HEAD\ngit pull -f https://github.com/lemuriens/combava.git","output":"str","x":150,"y":240,"wires":[["19c67d2aca8dacf4"]]},{"id":"bb7d562d36a95364","type":"link call","z":"22b4130fe1f6a28b","name":"validate update","links":["d95aeb3d32616821"],"linkType":"static","timeout":"30","x":560,"y":240,"wires":[["6b594e58c4deee27"]]},{"id":"0414410e1ea2d0eb","type":"server-events","z":"e95b0d12eedce5f1","name":"Rainmeter","server":"66876666.3e6288","version":2,"eventType":"ifttt_webhook_received","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":100,"y":140,"wires":[["8c80e6d7aef6bb6a"]]},{"id":"f0144973b310a2bd","type":"switch","z":"e95b0d12eedce5f1","name":"","property":"payload.event.ambiance","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":630,"y":140,"wires":[["b4d134869fbfd37a"]]},{"id":"54829fc517976dce","type":"function","z":"e95b0d12eedce5f1","name":"data output html","func":"var txt = \"\";\ntxt += \"<data>\";\n\n// TEMPERATURE MAISON\nvar temp_int = global.get(\"temperatures\").salon.temperature || \"\";\ntxt += wrap(\"temp_int\", Math.round(temp_int * 10) / 10);\n\nvar temp_tend = global.get(\"temperatures\").salon.tendency || \"\";\ntxt += wrap(\"temp_tend\", temp_tend == 0 ? \"\" : temp_tend > 0 ? \"↗\" : \"↘\");\n\n// MODE CHAUFFAGE\nvar heat_ = global.get(\"homeassistant\").homeAssistant.states[\"input_boolean.heat\"].state || \"\";\nvar heat_temp = global.get(\"homeassistant\").homeAssistant.states[\"input_text.heat_temp\"].state || \"\";\nif (heat_ === \"on\" && heat_temp != \"\") {\n    txt += wrap(\"warm\", \"Chauffage réglé \" + (heat_temp != \"Auto\" ? \"à \" + heat_temp + \"°C\" : \"en auto\"));\n} else {\n    txt += wrap(\"warm\", \"\");\n}\n\n// FENETRES\nvar windows_txt = global.get(\"windows_txt\") || \"\";\ntxt += wrap(\"windows_txt\", windows_txt);\n\n// DETECTION\nvar detect_time = global.get(\"detect_txt\") || \"\";\ntxt += wrap(\"detect_time\", detect_time);\n\n// STORES\nvar stores = global.get(\"stores_txt\") || \"\";\ntxt += wrap(\"stores\", stores);\n\n// BATTERIE TEL\nvar tel_bat = global.get(\"homeassistant\").homeAssistant.states[\"sensor.phone_bat_level\"].state;\ntxt += wrap(\"tel_bat\", tel_bat);\n\n// BATTERIE TAB\nvar tab_bat = global.get(\"homeassistant\").homeAssistant.states[\"sensor.lenovo_tb_x606f_bat_level\"].state;\ntxt += wrap(\"tab_bat\", tab_bat);\n\n// WEATHER CONDITION\nvar day_night = global.get(\"homeassistant\").homeAssistant.states[\"sun.sun\"].state === \"above_horizon\" ? \"-d\" : \"-n\";\nvar weather_condition = global.get(\"homeassistant\").homeAssistant.states[\"sensor.openweathermap_condition\"].state;\nweather_condition = (weather_condition == \"sunny\" || \"clear-night\" ? \"clear\" : weather_condition) + day_night;\ntxt += wrap(\"weather_condition\", weather_condition);\n\n// WEATHER TEMP\n//var weather_temperature = global.get(\"homeassistant\").homeAssistant.states[\"sensor.openweathermap_temperature\"].state;\nvar weather_temperature = global.get(\"homeassistant\").homeAssistant.states[\"input_number.temp_ext\"].state || \"\";\ntxt += wrap(\"weather_temperature\", Math.round(weather_temperature * 10) / 10);\n\nfunction wrap(xname, x) {\n    return \"<\" + xname + \">\" + x + \"</\" + xname + \">\";\n}\n\ntxt += \"</data>\";\nmsg.payload = txt;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":320,"wires":[["a16cd238feb3285b"]]},{"id":"a16cd238feb3285b","type":"file","z":"e95b0d12eedce5f1","name":"output file","filename":"/config/www/data_output.html","filenameType":"str","appendNewline":false,"createDir":false,"overwriteFile":"true","encoding":"utf8","x":980,"y":320,"wires":[[]]},{"id":"fb592c3ab3282599","type":"api-current-state","z":"e95b0d12eedce5f1","name":"pc power on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.pc_power","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":560,"y":280,"wires":[["54829fc517976dce"],[]]},{"id":"f1241fcae3402792","type":"server-events","z":"e95b0d12eedce5f1","name":"Rainmeter","server":"66876666.3e6288","version":2,"eventType":"ifttt_webhook_received","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":100,"y":200,"wires":[["e0702b7c7c765662"]]},{"id":"4b590ce967a4cb52","type":"switch","z":"e95b0d12eedce5f1","name":"","property":"payload.event.headset","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":810,"y":200,"wires":[["3e65cbca90000453"]]},{"id":"3e65cbca90000453","type":"switch","z":"e95b0d12eedce5f1","name":"","property":"payload.event.headset","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":930,"y":200,"wires":[["adc183ec48306d93"],["2a514dd26c44a0be"]]},{"id":"adc183ec48306d93","type":"api-call-service","z":"e95b0d12eedce5f1","name":"headset on","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.headset"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1070,"y":200,"wires":[[]]},{"id":"2a514dd26c44a0be","type":"api-call-service","z":"e95b0d12eedce5f1","name":"headset off","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.headset"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1070,"y":260,"wires":[[]]},{"id":"ec6cbe8654c945b4","type":"api-current-state","z":"e95b0d12eedce5f1","name":"pc power on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.pc_power","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":660,"y":200,"wires":[["4b590ce967a4cb52"],[]]},{"id":"9204e7f3dbc8e8b1","type":"inject","z":"e95b0d12eedce5f1","name":"when pc is off","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"1800","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":360,"wires":[["5422fe7d4f347146"]]},{"id":"9c0d86726b790cce","type":"inject","z":"e95b0d12eedce5f1","name":"when pc is on","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"600","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":280,"wires":[["705b0622ef586c10"]]},{"id":"ece31aed41c13794","type":"server-events","z":"e95b0d12eedce5f1","name":"Rainmeter","server":"66876666.3e6288","version":2,"eventType":"ifttt_webhook_received","exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":100,"y":440,"wires":[["b986869e46453094"]]},{"id":"579a3b8b6998fbda","type":"switch","z":"e95b0d12eedce5f1","name":"","property":"payload.event.gsound","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":630,"y":440,"wires":[["abb8708d1dc3e2e1","259d65aecdf17fbf"]]},{"id":"abb8708d1dc3e2e1","type":"switch","z":"e95b0d12eedce5f1","name":"","property":"payload.event.gsound","propertyType":"msg","rules":[{"t":"eq","v":"plus","vt":"str"},{"t":"eq","v":"minus","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":750,"y":440,"wires":[["b3935767ad51d33a"],["cbb0d8cf07f8b882"]]},{"id":"b3935767ad51d33a","type":"api-call-service","z":"e95b0d12eedce5f1","name":"google_home plus","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":["media_player.google_home"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":910,"y":440,"wires":[[]]},{"id":"cbb0d8cf07f8b882","type":"api-call-service","z":"e95b0d12eedce5f1","name":"google_home minus","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"volume_down","areaId":[],"deviceId":[],"entityId":["media_player.google_home"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1120,"y":440,"wires":[[]]},{"id":"c8dad96f217ca187","type":"api-call-service","z":"e95b0d12eedce5f1","name":"google_home mute","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":["media_player.google_home"],"data":"{\"is_volume_muted\":{{payload}}}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":570,"y":500,"wires":[["218464f8b007c52d"]]},{"id":"f3cf41499bf744f4","type":"api-current-state","z":"e95b0d12eedce5f1","name":"google home ?","server":"66876666.3e6288","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.google_home","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":240,"y":500,"wires":[["c9d1f6de4f45ce6b"]]},{"id":"259d65aecdf17fbf","type":"switch","z":"e95b0d12eedce5f1","name":"","property":"payload.event.gsound","propertyType":"msg","rules":[{"t":"eq","v":"mute","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":90,"y":500,"wires":[["f3cf41499bf744f4"]]},{"id":"c9d1f6de4f45ce6b","type":"function","z":"e95b0d12eedce5f1","name":"","func":"msg.payload = !msg.data.attributes.is_volume_muted;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":500,"wires":[["c8dad96f217ca187"]]},{"id":"218464f8b007c52d","type":"ha-wait-until","z":"e95b0d12eedce5f1","name":"","server":"66876666.3e6288","version":2,"outputs":2,"entityId":"input_select.ambiance","entityIdFilterType":"exact","property":"state","comparator":"is","value":"Arrêt","valueType":"str","timeout":"1","timeoutType":"num","timeoutUnits":"hours","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":740,"y":500,"wires":[["df630f4194f2812d"],["df630f4194f2812d"]]},{"id":"df630f4194f2812d","type":"api-call-service","z":"e95b0d12eedce5f1","name":"google_home unmute","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":["media_player.google_home"],"data":"{\"is_volume_muted\":false}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":920,"y":500,"wires":[["5cfba14dd6398fbb"]]},{"id":"5cfba14dd6398fbb","type":"api-call-service","z":"e95b0d12eedce5f1","name":"vol 0.4","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.google_home"],"data":"{\"volume_level\":\"0.4\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1090,"y":500,"wires":[[]]},{"id":"a954b64cd31251d2","type":"catch","z":"e95b0d12eedce5f1","name":"Bug Sender","scope":null,"uncaught":false,"x":110,"y":40,"wires":[["b1484d7f72503893"]]},{"id":"41184a6508b50019","type":"subflow:e6ac576fb4598283","z":"e95b0d12eedce5f1","name":"","x":490,"y":140,"wires":[["f0144973b310a2bd"],[]]},{"id":"482280cd4ac3293d","type":"subflow:e6ac576fb4598283","z":"e95b0d12eedce5f1","name":"","x":490,"y":200,"wires":[["ec6cbe8654c945b4"],[]]},{"id":"a7084d2b1ae17538","type":"subflow:e6ac576fb4598283","z":"e95b0d12eedce5f1","name":"","x":490,"y":440,"wires":[["579a3b8b6998fbda"],[]]},{"id":"b4d134869fbfd37a","type":"change","z":"e95b0d12eedce5f1","name":"","rules":[{"t":"set","p":"ambiance_type","pt":"msg","to":"payload.event.ambiance","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":810,"y":140,"wires":[["911592d8210d2318"]]},{"id":"911592d8210d2318","type":"change","z":"e95b0d12eedce5f1","name":"delete","rules":[{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":990,"y":140,"wires":[["7bbb76382f27c5a7"]]},{"id":"7bbb76382f27c5a7","type":"api-call-service","z":"e95b0d12eedce5f1","name":"set ambiance","server":"66876666.3e6288","version":5,"debugenabled":false,"domain":"input_select","service":"select_option","areaId":[],"deviceId":[],"entityId":["input_select.ambiance_1"],"data":"{\"option\":\"{{ambiance_type}}\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1130,"y":140,"wires":[[]]},{"id":"8296e43d9698045c","type":"subflow:ad3b29a5dd67898f","z":"e95b0d12eedce5f1","name":"","x":460,"y":40,"wires":[]},{"id":"b1484d7f72503893","type":"change","z":"e95b0d12eedce5f1","name":"set flowTitle","rules":[{"t":"set","p":"flowTitle","pt":"msg","to":"Rainmeter","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":40,"wires":[["8296e43d9698045c"]]},{"id":"7b55ab76ade5ab83","type":"api-current-state","z":"e95b0d12eedce5f1","name":"pc power on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.pc_power","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":560,"y":360,"wires":[[],["54829fc517976dce"]]},{"id":"8c80e6d7aef6bb6a","type":"api-current-state","z":"e95b0d12eedce5f1","name":"module_rainmeter on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_rainmeter","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":290,"y":140,"wires":[["41184a6508b50019"],[]]},{"id":"e0702b7c7c765662","type":"api-current-state","z":"e95b0d12eedce5f1","name":"module_rainmeter on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_rainmeter","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":290,"y":200,"wires":[["482280cd4ac3293d"],[]]},{"id":"b986869e46453094","type":"api-current-state","z":"e95b0d12eedce5f1","name":"module_rainmeter on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_rainmeter","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":290,"y":440,"wires":[["a7084d2b1ae17538"],[]]},{"id":"705b0622ef586c10","type":"api-current-state","z":"e95b0d12eedce5f1","name":"module_rainmeter on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_rainmeter","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":350,"y":280,"wires":[["fb592c3ab3282599"],[]]},{"id":"5422fe7d4f347146","type":"api-current-state","z":"e95b0d12eedce5f1","name":"module_rainmeter on ?","server":"66876666.3e6288","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.module_rainmeter","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":350,"y":360,"wires":[["7b55ab76ade5ab83"],[]]}]